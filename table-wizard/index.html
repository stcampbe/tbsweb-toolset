<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoTabler™ - HTML Table Wizard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.0/beautify-html.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
    /* Custom styles for the editor */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    body {
        font-family: 'Inter', sans-serif;
        display: flex;
        flex-direction: column;
        background-color: #09090b;
    }
    .table-wizard-header {
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .table-wizard-header h1 {
        font-size: 1.25rem;
        font-weight: bold;
        color: #ffffff;
        margin-right: auto;
    }
    .editor-container {
        display: flex;
        flex-grow: 1;
        padding: 0 1rem 1rem 1rem;
        gap: 1rem;
        margin: 0;
        width: 100%;
        height: 100%;
        box-sizing: border-box;
        overflow-y: hidden;
        overflow-x: hidden;
    }
    .code-panel {
        background-color: #18181b;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        padding: 1rem;
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        flex-shrink: 1;
        height: 100%;
        box-sizing: border-box;
        overflow-y: hidden;
        overflow-x: hidden;
    }

    #editor-container {
        min-height: 200px;
        flex-grow: 1;
        height: 100%;
        border: 1px solid #3f3f46;
        border-radius: 0.5rem;
        overflow: hidden;
    }

    h1 {
        color: #ffffff;
        margin-bottom: 1rem;
        text-align: center;
    }
    h2 {
        color: #ffffff;
        font-size: 1.5rem;
        font-weight: 600;
    }
    h3 {
        color: #ffffff;
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }
    label {
        color: #d4d4d8;
    }
    input[type="text"], input[type="number"] {
        background-color: #27272a;
        color: #ffffff;
        border-color: #3f3f46;
    }
    input[type="text"]::placeholder, input[type="number"]::placeholder {
        color: #a1a1aa;
    }

    @media (max-width: 1023px) {
        .editor-container {
            flex-direction: column;
        }
        .code-panel {
            width: 100%;
        }
    }

    .button-group {
        display: flex;
        width: 100%;
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        border: 1px solid #3f3f46;
        flex-wrap: wrap;
    }

    .button-group button {
        flex: 1;
        border-radius: 0;
        border: none;
        margin: 0;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        line-height: 1.25rem;
        position: relative;
        color: #ffffff;
        font-weight: bold;
        background-color: #27272a;
        transition: background-color 0.2s ease;
    }

    .button-group button:hover {
        background-color: #3f3f46;
        z-index: 1;
    }
    .button-group button.active {
        background-color: #3b82f6;
        color: #ffffff;
    }

    .button-group button:not(:last-child) {
        border-right: 1px solid rgba(63, 63, 70, 0.5);
    }

    .button-group button:first-child {
        border-top-left-radius: 0.5rem;
        border-bottom-left-radius: 0.5rem;
    }

    .button-group button:last-child {
        border-top-right-radius: 0.5rem;
        border-bottom-right-radius: 0.5rem;
    }

    #message-box {
        position: fixed;
        top: 1rem;
        left: 50%;
        z-index: 9999;
        min-width: 350px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        transform: translateX(-50%);
    }
    
    .message-box-fade-in {
        animation: fadeIn 0.5s ease-out forwards;
    }

    .message-box-fade-out {
        animation: fadeOut 0.5s ease-in forwards;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    @keyframes fadeOut {
        from { opacity: 1; transform: translateX(-50%) translateY(0); }
        to { opacity: 0; transform: translateX(-50%) translateY(-20px); }
    }

    .toggle-switch-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        margin-bottom: 0.25rem;
        padding: 0.25rem 0;
        gap: 0.5rem;
    }

    .toggle-switch-label {
        color: #d4d4d8;
        font-size: 0.875rem;
        flex-grow: 1;
        text-align: left;
        cursor: pointer;
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 40px;
        height: 22px;
        border-radius: 11px;
        background-color: #71717a;
        cursor: pointer;
        transition: background-color 0.3s ease;
        flex-shrink: 0;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-switch-slider {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 2px;
        bottom: 2px;
        background-color: #ffffff;
        border-radius: 50%;
        transition: transform 0.3s ease;
    }

    .toggle-switch.is-checked {
        background-color: #3b82f6;
    }

    .toggle-switch.is-checked .toggle-switch-slider {
        transform: translateX(18px);
    }

    .options-section {
        background-color: #3f3f46;
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        flex: 1;
    }

    .options-section h4 {
        font-size: 1rem;
        font-weight: bold;
        color: #ffffff;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #52525b;
    }

    .options-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.25rem;
        padding-top: 0.5rem;
    }

    .alignment-group-container {
        margin-bottom: 0.75rem;
    }

    .alignment-group-container label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #e4e4e7;
        margin-bottom: 0.3rem;
        display: block;
    }

    .option-text-input {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.25rem;
        justify-content: flex-start;
    }
    .option-text-input label {
        flex-shrink: 0;
        font-size: 0.875rem;
    }
    .option-text-input input[type="text"] {
        width: 80px;
        padding: 0.2rem 0.4rem;
        font-size: 0.875rem;
        height: 22px;
        border-radius: 0.25rem;
    }

    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .code-panel button:disabled,
    .modal-content button:disabled {
        background-color: #4a4a4a !important;
        cursor: not-allowed !important;
        opacity: 0.6 !important;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background-color: #18181b;
        padding: 1rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        color: #ffffff;
        text-align: left;
        max-width: 95%;
        width: 1700px;
        max-height: 90vh;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    .modal-options-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        flex-grow: 1;
    }

    @media (max-width: 900px) {
        .modal-options-row {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 600px) {
        .modal-options-row {
            grid-template-columns: 1fr;
        }
    }

    .modal-content h3 {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 1rem;
        text-align: left;
    }

    .modal-content p {
        margin-bottom: 1.5rem;
    }
    
     /* --- MODIFIED: Modal Button Styles --- */
    /* General container styles */
    .modal-content .modal-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap; /* Allow wrapping on small screens */
    }

    /* General button appearance */
    .modal-content .modal-buttons button {
        background-color: #3b82f6;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: bold;
        transition: background-color 0.2s ease;
    }

    .modal-content .modal-buttons button:hover {
        background-color: #2563eb;
    }

    /* "Format All Tables" Modal Specifics */
    #options-modal-overlay .modal-buttons {
        justify-content: center;
    }
    #options-modal-overlay .modal-buttons button {
        width: 100%;
    }
    
    /* "Custom Format" Modal Specifics */
    #customize-modal-overlay #format-specific-table-button {
        background-color: #3b82f6;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: bold;
        transition: background-color 0.2s ease;
        flex-shrink: 0; /* Prevent button from shrinking */
    }

    #customize-modal-overlay #format-specific-table-button:hover {
        background-color: #2563eb;
    }

    .table-select-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #d4d4d8;
    }

    #table-search-dropdown {
        background-color: #27272a;
        color: #ffffff;
        border: 1px solid #3f3f46;
        border-radius: 0.25rem;
        padding: 0.4rem 0.6rem;
        font-size: 0.875rem;
        width: 380px;
        flex-shrink: 0;
    }

    #table-search-dropdown:focus,
    .table-select-container select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
    }

    .selected-line-highlight {
        background-color: rgba(59, 130, 246, 0.2);
        border-radius: 4px;
    }

    #customize-modal-overlay .modal-content {
        width: 95%;
        max-width: 1700px;
        height: 90vh;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .customize-main-content-wrapper {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        gap: 1rem;
        overflow: hidden;
        padding: 1rem 0 0 0;
    }

    @media (min-width: 768px) {
        .customize-main-content-wrapper {
            flex-direction: row;
        }
    }

    .customize-preview-wrapper {
        width: 100%;
        height: 70%;
        flex-shrink: 1;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        border-radius: 0.5rem;
        overflow-y: auto;
        overflow-x: hidden;
        box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
    }

    @media (min-width: 768px) {
        .customize-preview-wrapper {
            width: 75%;
            height: auto;
        }
    }

    #customize-preview-iframe {
        width: 100%;
        height: 100%;
        border: 1px solid #475569;
        border-radius: 0.375rem;
        background-color: #e2e8f0;
    }

    .customize-options-panel {
        width: 100%;
        height: 30%;
        flex-shrink: 1;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        overflow-y: auto;
        overflow-x: hidden;
    }

    @media (min-width: 768px) {
        .customize-options-panel {
            width: 25%;
            height: auto;
        }
    }

    .customize-options-panel .options-section {
        background-color: #27272a;
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        flex-shrink: 0;
    }
    
    .attached-button-group {
        display: inline-flex;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }
    /* --- MODIFIED: Generic selector for any child element --- */
    .attached-button-group > * {
        border-radius: 0; /* Remove radius from all elements in the group by default */
    }
    .attached-button-group > *:first-child {
        border-top-left-radius: 0.375rem; /* rounded-md */
        border-bottom-left-radius: 0.375rem; /* rounded-md */
    }
    .attached-button-group > *:last-child {
        border-top-right-radius: 0.375rem; /* rounded-md */
        border-bottom-right-radius: 0.375rem; /* rounded-md */
    }
    .attached-button-group > *:not(:first-child):not(:last-child) {
        border-radius: 0; /* Explicitly remove radius for middle elements */
    }
    .trash-button {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
    }
    
    /* --- Color variations for button groups --- */
    .attached-button-group.blue button {
        background-color: #1d4ed8; /* blue-800 */
        color: white;
    }
    .attached-button-group.blue button:hover {
        background-color: #1e40af; /* blue-900 */
    }
    .attached-button-group.orange button {
        background-color: #c2410c; /* orange-700 */
        color: white;
    }
    .attached-button-group.orange button:hover {
        background-color: #9a3412; /* orange-800 */
    }
    .attached-button-group.green button {
        background-color: #15803d; /* green-700 */
        color: white;
    }
    .attached-button-group.green button:hover {
        background-color: #166534; /* green-800 */
    }
     .attached-button-group.purple button {
        background-color: #6d28d9; /* purple-700 */
        color: white;
    }
    .attached-button-group.purple button:hover {
        background-color: #5b21b6; /* purple-800 */
    }


    /* --- Styles for new Cell Actions Toolbar --- */
    .cell-actions-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    /* --- MODIFIED: Removed border-radius from this general rule --- */
    .cell-actions-group button {
        background-color: #3f3f46; /* Zinc-700 */
        color: white;
        padding: 0.25rem 0.6rem !important; /* Smaller padding */
        font-size: 0.8rem; /* Smaller font */
        font-weight: 500;
        transition: background-color 0.2s ease;
    }

    .cell-actions-group button:hover {
        background-color: #52525b; /* Zinc-600 */
    }

    .cell-actions-group input[type="text"] {
        width: 120px;
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
        height: auto;
        border: 1px solid #52525b;
    }
    
    /* Padding utility classes for iframe cells */
    .pad-sm { padding: 0.25rem !important; }
    .pad-md { padding: 0.5rem !important; }
    .pad-lg { padding: 1rem !important; }
    .pad-xl { padding: 1.5rem !important; }
</style>
</head>
<body>
    <div id="message-box" class="p-4 rounded-lg text-sm text-center transition-all duration-300 ease-in-out bg-gray-400 hidden" role="alert">No messages</div>

    <header class="table-wizard-header">
        <h1 class="text-left"><i class="fa-solid fa-table"></i> AutoTabler™ - HTML Table Wizard</h1>
        <a href="/tbsweb-toolset/rich-content-wizard/" class="px-3 py-1 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 font-bold">Content Wizard</a>
        <a href="/tbsweb-toolset/table-wizard/" class="px-3 py-1 text-sm text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 font-bold bg-gray-400 cursor-not-allowed opacity-60" disabled="">Table Wizard</a>
        <a href="/tbsweb-toolset/qa-wizard/" class="px-3 py-1 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 font-bold">QA Wizard</a></header>
    <div class="editor-container">
        <div class="code-panel">
            <div class="flex items-center mb-2 flex-wrap">
    <div class="flex space-x-2 items-center"> <div class="attached-button-group">
            <button id="open-options-modal-btn" class="px-4 py-2 text-base bg-blue-700 text-white rounded-l-md hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 font-semibold">
                Format ALL Tables
            </button>
            <button id="reset-universal-btn" class="trash-button bg-blue-800 text-white rounded-r-md hover:bg-blue-900 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-opacity-50 font-semibold" title="Resetting all tables">
                <i class="fas fa-trash-alt"></i>
            </button>
        </div>
        <div class="attached-button-group" role="group">
            <button id="auto-responsive-btn" class="px-4 py-2 text-base bg-orange-700 text-white rounded-l-md hover:bg-orange-800 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-opacity-50 font-semibold">
                Auto-Responsive
            </button>
            <button id="reset-responsive-btn" class="trash-button bg-orange-800 text-white rounded-r-md hover:bg-orange-900 focus:outline-none focus:ring-2 focus:ring-orange-600 focus:ring-opacity-50 font-semibold" title="Remove Responsive Wrappers">
                <i class="fas fa-trash-alt"></i>
            </button>
        </div>
        <div class="attached-button-group">
            <button id="auto-scope-btn" class="px-4 py-2 text-base bg-green-700 text-white rounded-l-md hover:bg-green-800 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 font-semibold">
                Auto-Scope/ID
            </button>
            <button id="reset-scopeid-btn" class="trash-button bg-green-800 text-white rounded-r-md hover:bg-green-900 focus:outline-none focus:ring-2 focus:ring-green-600 focus:ring-opacity-50 font-semibold" title="Reset All Scopes and IDs">
                <i class="fas fa-trash-alt"></i>
            </button>
        </div>
        <div class="attached-button-group">
        <button id="eng-number-button" class="px-3 py-1 text-sm bg-purple-700 text-white rounded-l-md hover:bg-purple-800 focus:outline-none focus:ring-2 focus:ring-purple-600 focus:ring-opacity-50 font-bold">
            ENG Numbering
        </button>
        <button id="fra-number-button" class="px-3 py-1 text-sm bg-purple-700 text-white rounded-r-md hover:bg-purple-800 focus:outline-none focus:ring-2 focus:ring-purple-600 focus:ring-opacity-50 font-bold">
            FRA Numbering
        </button>
        </div>
        <button id="autoTableIDBtn" class="px-3 py-1 text-sm bg-gray-700 text-white rounded-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-600 focus:ring-opacity-50 font-bold">
            Quick Table ID's
        </button>
        <button id="autoEncodeBtn" class="px-3 py-1 text-sm bg-red-700 text-white rounded-md hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-opacity-50 font-semibold">
            Auto-Encode
        </button>
        <button id="autoFormatBtn" class="px-3 py-1 text-sm bg-red-700 text-white rounded-md hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-opacity-50 font-semibold">
            Auto-Indent
        </button>
    </div>
    </div>
<div class="flex mb-4 px-2 py-2 space-x-2 items-center bg-gray-800 rounded-md">
        <label for="table-search-dropdown" class="text-sm font-medium">Table Select:</label>
        <select id="table-search-dropdown" class="text-sm">
            <option value="">-- Select a table --</option>
        </select>
        <div class="attached-button-group">
        <button id="customize-button" class="px-3 py-1 text-sm bg-blue-700 text-white rounded-l-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-opacity-50 font-bold">
            Custom Format
        </button>
    <button id="reset-tableformat-btn" class="trash-button bg-blue-800 text-white rounded-r-md hover:bg-blue-900 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-opacity-50 font-semibold" title="Reset Table Formatting">
                <i class="fas fa-trash-alt"></i>
            </button>
    </div>
        <div class="attached-button-group" role="group">
        <button id="force-scope-button" class="px-3 py-1 text-sm bg-green-700 text-white rounded-l-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-600 focus:ring-opacity-50 font-bold">
            Force Scope
        </button>
        <button id="force-id-button" class="px-3 py-1 text-sm bg-green-700 text-white hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-600 focus:ring-opacity-50 font-bold">
            Force ID/Headers
        </button>
        <button id="reset-tablescopeid-btn" class="trash-button bg-green-800 text-white rounded-r-md hover:bg-green-900 focus:outline-none focus:ring-2 focus:ring-green-600 focus:ring-opacity-50 font-semibold" title="Reset Table Scope/IDs">
                <i class="fas fa-trash-alt"></i>
            </button>
        </div>
</div>
			<div class="flex items-center mb-4 flex-wrap">
                    <div class="inline-flex rounded-md shadow-sm" role="group">
                        <button id="copyCodeBtn" class="px-4 py-1 text-sm bg-zinc-700 text-white rounded-l-md hover:bg-zinc-600 focus:outline-none focus:ring-2 focus:ring-zinc-500 focus:ring-opacity-50 font-semibold">
                            Copy Code <i class="fa-solid fa-copy"></i>
                        </button>
                        <button id="clearAllBtn" class="px-4 py-1 text-sm bg-zinc-700 text-white rounded-r-md hover:bg-zinc-600 focus:outline-none focus:ring-2 focus:ring-zinc-500 focus:ring-opacity-50 font-semibold">
                            Clear All <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                    <div class="inline-flex rounded-md shadow-sm ml-4" role="group">
    <button id="undoBtn" class="px-4 py-1 text-sm bg-zinc-700 text-white rounded-l-md hover:bg-zinc-600 focus:outline-none focus:ring-2 focus:ring-zinc-500 focus:ring-opacity-50 font-semibold disabled:opacity-50 disabled:cursor-not-allowed" title="Undo">
        <i class="fas fa-undo"></i>
    </button>
    <button id="redoBtn" class="px-4 py-1 text-sm bg-zinc-700 text-white rounded-r-md hover:bg-zinc-600 focus:outline-none focus:ring-2 focus:ring-zinc-500 focus:ring-opacity-50 font-semibold disabled:opacity-50 disabled:cursor-not-allowed" title="Redo">
        <i class="fas fa-redo"></i>
    </button>
</div>
                    <div class="inline-flex rounded-md shadow-sm ml-4" role="group">
                        <button id="importHtmlBtn" class="px-3 py-1 text-sm bg-purple-700 text-white rounded-l-md hover:bg-purple-800 focus:outline-none focus:ring-2 focus:ring-purple-600 focus:ring-opacity-50 font-bold">Import HTML <i class="fa-solid fa-file-import"></i></button>
                        <button id="exportHtmlBtn" class="px-3 py-1 text-sm bg-red-700 text-white rounded-r-md hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-opacity-50 font-bold">Export HTML <i class="fa-solid fa-file-export"></i></button>
                        <input type="file" id="htmlFileInput" accept=".html" style="display: none;">
                    </div>
                    
                </div>

            

            <div id="editor-container"></div>
			
        </div>
    </div>

    <div id="options-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white mt-4">Formatting Options</h3>
                <button id="close-options-modal-btn" class="text-gray-400 hover:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="modal-options-row">
                <div class="options-section">
                    <h4>Base Properties</h4>
                    <div class="options-grid">
                        <div class="toggle-switch-container">
                            <label class="toggle-switch is-checked" for="id-checkbox">
                                <input type="checkbox" id="id-checkbox" class="hidden" checked>
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200">ID Tables</span>
                        </div>
                        <div class="option-text-input">
                            <input type="text" id="page-id-prefix-input" class="w-auto" style="width: 60px;" placeholder="tbl">
                            <label for="page-id-prefix-input" class="text-gray-200">Table ID Prefix</label>
                        </div>
                        <div class="option-text-input">
                            <input type="text" id="figure-data-id-prefix-input" class="w-auto" style="width: 60px;" placeholder="ftbl">
                            <label for="figure-data-id-prefix-input" class="text-gray-200">Figure Table ID Prefix</label>
                        </div>
                        <div class="toggle-switch-container">
                            <label class="toggle-switch is-checked" for="fix-empty-cells-checkbox">
                                <input type="checkbox" id="fix-empty-cells-checkbox" class="hidden" checked>
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200">Fix Empty Cells</span>
                        </div>
                        <div class="toggle-switch-container">
                            <label class="toggle-switch is-checked" for="make-tfoot-from-colspan-checkbox">
                                <input type="checkbox" id="make-tfoot-from-colspan-checkbox" class="hidden" checked>
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200">TFOOT from LAST COLSPAN</span>
                        </div>
						<div class="toggle-switch-container">
                            <label class="toggle-switch is-checked" for="make-tfoot-before-tbody-checkbox">
                                <input type="checkbox" id="make-tfoot-before-tbody-checkbox" class="hidden" checked>
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200">TFOOT before TBODY</span>
                        </div>
                        <div class="toggle-switch-container">
                            <label class="toggle-switch is-checked" for="caption-checkbox">
                                <input type="checkbox" id="caption-checkbox" class="hidden" checked>
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200">Caption (set manually)</span>
                        </div>
                        <div class="toggle-switch-container">
                            <label class="toggle-switch" for="auto-caption-checkbox">
                                <input type="checkbox" id="auto-caption-checkbox" class="hidden">
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200">Auto-Caption</span>
                        </div>
						<div class="toggle-switch-container">
                            <label class="toggle-switch" for="inv-caption-checkbox">
                                <input type="checkbox" id="inv-caption-checkbox" class="hidden">
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200">Invisible Captions</span>
                        </div>
                        
                        <div class="toggle-switch-container">
                            <label class="toggle-switch" for="remove-p-tags-checkbox">
                                <input type="checkbox" id="remove-p-tags-checkbox" class="hidden">
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200">Remove &lt;p&gt; Tags</span>
                        </div>
                        
                        <div class="toggle-switch-container">
                            <label class="toggle-switch" for="class-small-checkbox">
                                <input type="checkbox" id="class-small-checkbox" class="hidden">
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200">Add <strong>small</strong> to TABLE</span>
                        </div>
                        <div class="toggle-switch-container">
                            <label class="toggle-switch" for="add-small-to-tr-checkbox">
                                <input type="checkbox" id="add-small-to-tr-checkbox" class="hidden">
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200">Add <strong>small</strong> to ALL TR</span>
                        </div>
                    </div>
                </div>

                <div class="options-section">
                    <h4>Structure and Styling</h4>
                    <div class="options-grid">
                        <div class="toggle-switch-container">
                            <label class="toggle-switch is-checked" for="class-tables-checkbox">
                                <input type="checkbox" id="class-tables-checkbox" class="hidden" checked>
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200">Basic Classes</span>
                        </div>
                        <div class="toggle-switch-container">
                            <label class="toggle-switch is-checked" for="header-checkbox">
                                <input type="checkbox" id="header-checkbox" class="hidden" checked>
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200">TH COL Headers (1st row)</span>
                        </div>
                        <div class="toggle-switch-container">
                            <label class="toggle-switch is-checked" for="row-header-checkbox">
                                <input type="checkbox" id="row-header-checkbox" class="hidden" checked>
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200">TH ROW Headers (1st col)</span>
                        </div>
                        <div class="toggle-switch-container">
                            <label class="toggle-switch is-checked" for="active-col-headers-checkbox">
                                <input type="checkbox" id="active-col-headers-checkbox" class="hidden" checked>
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200"><strong>active</strong> COL Headers</span>
                        </div>
                        <div class="toggle-switch-container">
                            <label class="toggle-switch is-checked" for="active-colspan-headers-checkbox">
                                <input type="checkbox" id="active-colspan-headers-checkbox" class="hidden" checked>
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200"><strong>active</strong> COLSPAN Headers</span>
                        </div>
                        <div class="toggle-switch-container">
                            <label class="toggle-switch" for="active-row-headers-checkbox">
                                <input type="checkbox" id="active-row-headers-checkbox" class="hidden">
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200"><strong>active</strong> ROW Headers</span>
                        </div>
                        <div class="toggle-switch-container">
                            <label class="toggle-switch is-checked" for="bordered-checkbox">
                                <input type="checkbox" id="bordered-checkbox" class="hidden" checked>
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200">Add <strong>bordered</strong></span>
                        </div>
                        <div class="toggle-switch-container">
                            <label class="toggle-switch" for="striped-checkbox">
                                <input type="checkbox" id="striped-checkbox" class="hidden">
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200">Add <strong>striped</strong></span>
                        </div>
                        <div class="toggle-switch-container">
                            <label class="toggle-switch" for="hover-checkbox">
                                <input type="checkbox" id="hover-checkbox" class="hidden">
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200">Add <strong>hover</strong></span>
                        </div>
                        <div class="toggle-switch-container">
                            <label class="toggle-switch" for="bold-totals-checkbox">
                                <input type="checkbox" id="bold-totals-checkbox" class="hidden">
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200">Bold Totals</span>
                        </div>
                        <div class="toggle-switch-container">
                            <label class="toggle-switch" for="finance-table-checkbox">
                                <input type="checkbox" id="finance-table-checkbox" class="hidden">
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200">Finance Tables</span>
                        </div>
                        
                    </div>
                </div>

                <div class="options-section">
                    <h4>Alignment</h4>
                    <div class="options-grid">
                        

                        <div class="alignment-group-container">
                            <label for="caption-alignment">Caption</label>
                            <div id="caption-alignment-group" class="button-group">
                                <button data-align="left" class="active">Left</button>
                                <button data-align="center">Center</button>
                                <button data-align="right">Right</button>
                            </div>
                        </div>

                        <div class="alignment-group-container">
                            <label for="col-headers-alignment">Column Headers</label>
                            <div id="col-headers-alignment-group" class="button-group">
                                <button data-align="none" class="active">None</button>
                                <button data-align="left">Left</button>
                                <button data-align="center">Center</button>
                                <button data-align="right">Right</button>
                            </div>
                        </div>

                        <div class="alignment-group-container">
                            <label for="row-headers-alignment">Row Headers</label>
                            <div id="row-headers-alignment-group" class="button-group">
                                <button data-align="none" class="active">None</button>
                                <button data-align="left">Left</button>
                                <button data-align="center">Center</button>
                                <button data-align="right">Right</button>
                            </div>
                        </div>

                        <div class="alignment-group-container">
                            <label for="colspan-headers-alignment">Colspan Headers</label>
                            <div id="colspan-headers-alignment-group" class="button-group">
                                <button data-align="none" class="active">None</button>
                                <button data-align="left">Left</button>
                                <button data-align="center">Center</button>
                                <button data-align="right">Right</button>
                            </div>
                        </div>

                        <div class="alignment-group-container">
                            <label for="data-cells-alignment">Data Cells</label>
                            <div id="data-cells-alignment-group" class="button-group">
                                <button data-align="none" class="active">None</button>
                                <button data-align="left">Left</button>
                                <button data-align="center">Center</button>
                                <button data-align="right">Right</button>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>

            <div class="modal-buttons">
                <button id="format-button-modal" class="font-semibold mt-4">
                    Format Tables
                </button>
            </div>
        </div>
    </div>

    <div id="customize-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-white mt-4">Customize Table</h3>
                <button id="close-customize-modal-btn" class="text-gray-400 hover:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="customize-main-content-wrapper">
                <div class="customize-preview-wrapper flex flex-col">
                    <iframe id="customize-preview-iframe" class="flex-grow"></iframe>
                </div>

                <div class="customize-options-panel">
                    <div class="options-section">
                        <h4>Base Properties</h4>
                        <div class="options-grid">
                            <div class="option-text-input">
                                <label for="customize-page-id-prefix-input" class="text-gray-200">Custom ID</label>
                                <input type="text" id="customize-page-id-prefix-input" class="flex-grow bg-zinc-700 text-white border border-zinc-500 rounded-md p-1" placeholder="my-custom-id">
                            </div>
							<div class="toggle-switch-container">
                                <label class="toggle-switch" for="customize-fix-empty-cells-checkbox">
                                    <input type="checkbox" id="customize-fix-empty-cells-checkbox" class="hidden" checked>
                                    <span class="toggle-switch-slider"></span>
                                </label>
                                <span class="toggle-switch-label text-gray-200">Fix Empty Cells</span>
                            </div>

                            <div class="toggle-switch-container">
                                <label class="toggle-switch" for="customize-make-tfoot-from-colspan-checkbox">
                                    <input type="checkbox" id="customize-make-tfoot-from-colspan-checkbox" class="hidden">
                                    <span class="toggle-switch-slider"></span>
                                </label>
                                <span class="toggle-switch-label text-gray-200">TFOOT from LAST COLSPAN</span>
                            </div>
							<div class="toggle-switch-container">
                            <label class="toggle-switch is-checked" for="customize-make-tfoot-before-tbody-checkbox">
                                <input type="checkbox" id="customize-make-tfoot-before-tbody-checkbox" class="hidden">
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200">TFOOT before TBODY</span>
                        </div>
							<div class="toggle-switch-container">
                            <label class="toggle-switch" for="customize-caption-checkbox">
                                <input type="checkbox" id="customize-caption-checkbox" class="hidden">
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200">Caption</span>
                        </div>
                            <div class="toggle-switch-container">
                            <label class="toggle-switch" for="customize-inv-caption-checkbox">
                                <input type="checkbox" id="customize-inv-caption-checkbox" class="hidden">
                                <span class="toggle-switch-slider"></span>
                            </label>
                            <span class="toggle-switch-label text-gray-200">Invisible Captions</span>
                        </div>
                            <div class="toggle-switch-container">
                                <label class="toggle-switch" for="customize-remove-p-tags-checkbox">
                                    <input type="checkbox" id="customize-remove-p-tags-checkbox" class="hidden">
                                    <span class="toggle-switch-slider"></span>
                                </label>
                                <span class="toggle-switch-label text-gray-200">Remove &lt;p&gt; Tags</span>
                            </div>
                            
                            <div class="toggle-switch-container">
                                <label class="toggle-switch" for="customize-class-small-checkbox">
                                    <input type="checkbox" id="customize-class-small-checkbox" class="hidden">
                                    <span class="toggle-switch-slider"></span>
                                </label>
                                <span class="toggle-switch-label text-gray-200">Add <strong>small</strong> to TABLE</span>
                            </div>
                            <div class="toggle-switch-container">
                                <label class="toggle-switch" for="customize-add-small-to-tr-checkbox">
                                    <input type="checkbox" id="customize-add-small-to-tr-checkbox" class="hidden">
                                    <span class="toggle-switch-slider"></span>
                                </label>
                                <span class="toggle-switch-label text-gray-200">Add <strong>small</strong> to ALL TR</span>
                            </div>
                        </div>
                    </div>

                    <div class="options-section">
                        <h4>Structure and Styling</h4>
                        <div class="options-grid">
						<div class="toggle-switch-container">
                                <label class="toggle-switch" for="customize-class-tables-checkbox">
                                    <input type="checkbox" id="customize-class-tables-checkbox" class="hidden" checked>
                                    <span class="toggle-switch-slider"></span>
                                </label>
                                <span class="toggle-switch-label text-gray-200">Basic Classes</span>
                            </div>
                            <div class="toggle-switch-container">
                                <label class="toggle-switch" for="customize-header-checkbox">
                                    <input type="checkbox" id="customize-header-checkbox" class="hidden" checked>
                                    <span class="toggle-switch-slider"></span>
                                </label>
                                <span class="toggle-switch-label text-gray-200">TH COL Headers (1st row)</span>
                            </div>
                            <div class="toggle-switch-container">
                                <label class="toggle-switch" for="customize-row-header-checkbox">
                                    <input type="checkbox" id="customize-row-header-checkbox" class="hidden" checked>
                                    <span class="toggle-switch-slider"></span>
                                </label>
                                <span class="toggle-switch-label text-gray-200">TH ROW Headers (1st col)</span>
                            </div>
                            <div class="toggle-switch-container">
                                <label class="toggle-switch" for="customize-active-col-headers-checkbox">
                                    <input type="checkbox" id="customize-active-col-headers-checkbox" class="hidden" checked>
                                    <span class="toggle-switch-slider"></span>
                                </label>
                                <span class="toggle-switch-label text-gray-200"><strong>active</strong> COL Headers</span>
                            </div>
                            <div class="toggle-switch-container">
                                <label class="toggle-switch" for="customize-active-colspan-headers-checkbox">
                                    <input type="checkbox" id="customize-active-colspan-headers-checkbox" class="hidden" checked>
                                    <span class="toggle-switch-slider"></span>
                                </label>
                                <span class="toggle-switch-label text-gray-200"><strong>active</strong> COLSPAN Headers</span>
                            </div>
                            <div class="toggle-switch-container">
                                <label class="toggle-switch" for="customize-active-row-headers-checkbox">
                                    <input type="checkbox" id="customize-active-row-headers-checkbox" class="hidden">
                                    <span class="toggle-switch-slider"></span>
                                </label>
                                <span class="toggle-switch-label text-gray-200"><strong>active</strong> ROW Headers</span>
                            </div>
                            <div class="toggle-switch-container">
                                <label class="toggle-switch" for="customize-bordered-checkbox">
                                    <input type="checkbox" id="customize-bordered-checkbox" class="hidden" checked>
                                    <span class="toggle-switch-slider"></span>
                                </label>
                                <span class="toggle-switch-label text-gray-200">Add <strong>bordered</strong></span>
                            </div>
                            <div class="toggle-switch-container">
                                <label class="toggle-switch" for="customize-striped-checkbox">
                                    <input type="checkbox" id="customize-striped-checkbox" class="hidden">
                                    <span class="toggle-switch-slider"></span>
                                </label>
                                <span class="toggle-switch-label text-gray-200">Add <strong>striped</strong></span>
                            </div>
                            <div class="toggle-switch-container">
                                <label class="toggle-switch" for="customize-hover-checkbox">
                                    <input type="checkbox" id="customize-hover-checkbox" class="hidden">
                                    <span class="toggle-switch-slider"></span>
                                </label>
                                <span class="toggle-switch-label text-gray-200">Add <strong>hover</strong></span>
                            </div>
                            <div class="toggle-switch-container">
                                <label class="toggle-switch" for="customize-bold-totals-checkbox">
                                    <input type="checkbox" id="customize-bold-totals-checkbox" class="hidden">
                                    <span class="toggle-switch-slider"></span>
                                </label>
                                <span class="toggle-switch-label text-gray-200">Bold Totals</span>
                            </div>
                            <div class="toggle-switch-container">
                                <label class="toggle-switch" for="customize-finance-table-checkbox">
                                    <input type="checkbox" id="customize-finance-table-checkbox" class="hidden">
                                    <span class="toggle-switch-slider"></span>
                                </label>
                                <span class="toggle-switch-label text-gray-200">Finance Tables</span>
                            </div>
                            
                        </div>
                    </div>

                    <div class="options-section">
                        <h4>Alignment</h4>
                        <div class="options-grid">
                            
                            

                            <div class="alignment-group-container">
                                <label for="customize-caption-alignment">Caption</label>
                                <div id="customize-caption-alignment-group" class="button-group">
                                    <button data-align="left" class="active">Left</button>
                                    <button data-align="center">Center</button>
                                    <button data-align="right">Right</button>
                                </div>
                            </div>

                            <div class="alignment-group-container">
                                <label for="customize-col-headers-alignment">Column Headers</label>
                                <div id="customize-col-headers-alignment-group" class="button-group">
                                    <button data-align="none" class="active">None</button>
                                    <button data-align="left">Left</button>
                                    <button data-align="center">Center</button>
                                    <button data-align="right">Right</button>
                                </div>
                            </div>

                            <div class="alignment-group-container">
                                <label for="customize-row-headers-alignment">Row Headers</label>
                                <div id="customize-row-headers-alignment-group" class="button-group">
                                    <button data-align="none" class="active">None</button>
                                    <button data-align="left">Left</button>
                                    <button data-align="center">Center</button>
                                    <button data-align="right">Right</button>
                                </div>
                            </div>

                            <div class="alignment-group-container">
                                <label for="customize-colspan-headers-alignment">Colspan Headers</label>
                                <div id="customize-colspan-headers-alignment-group" class="button-group">
                                    <button data-align="none" class="active">None</button>
                                    <button data-align="left">Left</button>
                                    <button data-align="center">Center</button>
                                    <button data-align="right">Right</button>
                                </div>
                            </div>

                            <div class="alignment-group-container">
                                <label for="customize-data-cells-alignment">Data Cells</label>
                                <div id="customize-data-cells-alignment-group" class="button-group">
                                    <button data-align="none" class="active">None</button>
                                    <button data-align="left">Left</button>
                                    <button data-align="center">Center</button>
                                    <button data-align="right">Right</button>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
            </div>

            
                 <div class="flex justify-between items-center mt-4 gap-4 flex-wrap border-t border-zinc-700 pt-4">
                    <div class="cell-actions-group">
                        <div class="attached-button-group font-semibold">
                        <button id="unbold-th-btn" title="Remove Bold from selected TH cells">Un-Bold TH</button>
                        <button id="bold-td-btn" title="Make selected TD cells Bold">Bold TD</button></div>
                        <div class="attached-button-group">
                        <button id="align-left-btn" title="Align text Left">Align Left</button>
                        <button id="align-center-btn" title="Align text Center">Center</button>
                        <button id="align-right-btn" title="Align text Right">Right</button>
                    <button id="align-none-btn" title="No alignment selected">None</button></div>
                        <div class="attached-button-group">
                        <button id="mrgn-sm-btn" title="Apply Small Margin">Margin SM</button>
                        <button id="mrgn-md-btn" title="Apply Medium Margin">MD</button>
                        <button id="mrgn-lg-btn" title="Apply Large Margin">LG</button>
                        <button id="mrgn-xl-btn" title="Apply Extra Large Margin">XL</button>
                    <button id="mrgn-0-btn" title="No margin">No margin</button></div>
                        <div class="attached-button-group">
                            <input type="text" id="custom-class-input" placeholder="custom-class" class="rounded-l-md">
                            <button id="add-class-btn" class="rounded-r-md">Add</button>
                            <button id="remove-class-btn" class="rounded-r-md">Remove</button>
                        </div>
                    </div>
                    <button id="format-specific-table-button" class="font-semibold">Format Table</button>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/min/vs/loader.js"></script>
<script>
    let monacoEditor; // Declare editor variable globally
    let entityDecorations = []; // Variable to store Monaco decorations for entities
    let messageTimeoutId; // Timeout for message box
    let tableDataMap = new Map(); // Stores {optionValue: {startIndex: ...}} for jump functionality
    let currentHighlightDecorationId = []; // Stores the ID of the current highlight decoration
    
    // --- NEW: Undo/Redo History Management ---
    let undoStack = [];
    let redoStack = [];
    let isUndoingOrRedoing = false; // Flag to prevent feedback loops

    // Initialize global state variables for alignment options
    // These are for the UNIVERSAL format modal
    window.captionAlignment = 'left'; // Changed to 'left'
    window.colHeaderAlignment = 'none';
    window.rowHeaderAlignment = 'none';
    window.colspanHeaderAlignment = 'none'; // Changed to 'none'
    window.dataCellsAlignment = 'none';

    // Global variables for CUSTOMIZE modal alignment options (initialize to default for specific table)
    window.customizeCaptionAlignment = 'left'; // Changed to 'left'
    window.customizeColHeaderAlignment = 'none';
    window.customizeRowHeaderAlignment = 'none';
    window.customizeColspanHeaderAlignment = 'none'; // Changed to 'none'
    window.customizeDataCellsAlignment = 'none';

    // --- NEW: Undo/Redo Functions ---
    /**
     * Pushes the current state of the editor to the undo stack.
     * Clears the redo stack as a new action invalidates the old redo history.
     */
    function pushUndoState() {
        if (isUndoingOrRedoing) return; // Don't push states when undoing/redoing
        const currentState = getEditorContent();
        // Only push if the state is different from the last one
        if (undoStack.length === 0 || undoStack[undoStack.length - 1] !== currentState) {
            undoStack.push(currentState);
            redoStack = []; // Clear redo stack on new action
            updateUndoRedoButtons();
        }
    }

    /**
     * Performs an undo action.
     */
    function undo() {
        if (undoStack.length > 1) { // Need at least one state to revert to
            isUndoingOrRedoing = true;
            const currentState = undoStack.pop();
            redoStack.push(currentState);
            const prevState = undoStack[undoStack.length - 1];
            setEditorContent(prevState);
            isUndoingOrRedoing = false;
            updateUndoRedoButtons();
             showMessage('Undo successful.', 'info');
        }
    }

    /**
     * Performs a redo action.
     */
    function redo() {
        if (redoStack.length > 0) {
            isUndoingOrRedoing = true;
            const nextState = redoStack.pop();
            undoStack.push(nextState);
            setEditorContent(nextState);
            isUndoingOrRedoing = false;
            updateUndoRedoButtons();
            showMessage('Redo successful.', 'info');
        }
    }

    /**
     * Updates the enabled/disabled state of the undo and redo buttons.
     */
    function updateUndoRedoButtons() {
        const undoBtn = document.getElementById('undoBtn');
        const redoBtn = document.getElementById('redoBtn');
        // This function is now called from within updateAllInteractiveButtonStates,
        // so we only need to manage the logic based on stack length.
        // The overall disabled state during an action is handled by the main function.
        if (undoBtn) undoBtn.disabled = undoBtn.disabled || undoStack.length <= 1;
        if (redoBtn) redoBtn.disabled = redoBtn.disabled || redoStack.length === 0;
    }


    // Helper function to get the current HTML from the editor
    function getEditorContent() {
        return monacoEditor ? monacoEditor.getValue() : '';
    }

    // Helper function to set the HTML content in the editor
    function setEditorContent(content) {
        if (monacoEditor) {
            monacoEditor.setValue(content);
        }
    }

    /**
     * Clears any active Monaco editor line highlighting.
     */
    function clearMonacoHighlight() {
        if (monacoEditor && currentHighlightDecorationId.length > 0) {
            // Corrected: deltaDecorations is on the model
            monacoEditor.getModel().deltaDecorations(currentHighlightDecorationId, []);
            currentHighlightDecorationId = [];
        }
    }

    /**
     * Applies highlighting to HTML character entities in the Monaco editor.
     */
    function applyEntityHighlighting() {
        if (!monacoEditor) return;

        const model = monacoEditor.getModel();
        if (!model) return;

        const newDecorations = [];
        const text = model.getValue();
        // Regex to find HTML entities like &nbsp; &#160; &amp;
        const regex = /&[a-zA-Z0-9#]+;/g;

        let match;
        while ((match = regex.exec(text)) !== null) {
            const startPos = model.getPositionAt(match.index);
            const endPos = model.getPositionAt(match.index + match[0].length);

            newDecorations.push({
                range: new monaco.Range(startPos.lineNumber, startPos.column, endPos.lineNumber, endPos.column),
                options: {
                    inlineClassName: 'entity-highlight',
                    hoverMessage: { value: 'HTML Character Entity' } // Optional: show tooltip on hover
                }
            });
        }

        // Corrected: deltaDecorations is on the model
        entityDecorations = model.deltaDecorations(entityDecorations, newDecorations);
    }

    /**
     * Encodes a string to Base64.
     * @param {string} str The string to encode.
     * @returns {string} The Base64 encoded string.
     */
    function encodeBase64(str) {
        return btoa(unescape(encodeURIComponent(str)));
    }

    /**
     * Decodes a Base64 string.
     * @param {string} str The Base64 string to decode.
     * @returns {string} The decoded string.
     */
    function decodeBase64(str) {
        return decodeURIComponent(escape(atob(str)));
    }

    /**
     * Protects all data- attributes by Base64 encoding their values and replacing them with a temporary attribute.
     * This function operates purely on the HTML string using regex to avoid DOM parsing issues with complex attribute values.
     * @param {string} htmlString - The HTML content to process.
     * @returns {string} The HTML with protected data- attributes.
     */
    function protectDataAttributes(htmlString) {
        const regex = /(data-[a-zA-Z0-9-]+)="([^"]*)"/g;
        return htmlString.replace(regex, (match, attrName, value) => {
            const encodedValue = encodeBase64(value);
            return `data-temp-protected-${attrName}="${encodedValue}"`;
        });
    }

    /**
     * Restores protected data- attributes by Base64 decoding their values and replacing them back.
     * The decoded value's internal double quotes are explicitly re-escaped as &quot; to prevent corruption during later DOM operations.
     * This function operates purely on the HTML string using regex.
     * @param {string} htmlString - The HTML content to process.
     * @returns {string} The HTML with original data- attributes restored.
     */
    function restoreDataAttributes(htmlString) {
        const regex = /data-temp-protected-(data-[a-zA-Z0-9-]+)="([^"]*)"/g;
        return htmlString.replace(regex, (match, originalAttrName, encodedValue) => {
            try {
                let decodedValue = decodeBase64(encodedValue);
                let safeValue = decodedValue.replace(/"/g, '&quot;');
                safeValue = safeValue.replace(/&#34;/g, '&quot;');
                return `${originalAttrName}="${safeValue}"`;
            } catch (e) {
                console.error("Error decoding or re-escaping Base64 data-attribute:", e);
                return '';
            }
        });
    }

    /**
     * Converts common character entities and named entities to their numeric HTML entity equivalents.
     * This function operates on an HTML string, parsing it to a temporary DOM, modifying text nodes,
     * and then serializing it back to a string, ensuring numeric entities are preserved.
     * @param {string} htmlString - The HTML content to process.
     * @returns {string} The processed HTML string with numeric entities.
     */
    function convertAllEntitiesToNumeric(htmlString) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlString; // This parses entities to characters

        const walker = document.createTreeWalker(
            tempDiv,
            NodeFilter.SHOW_TEXT,
            {
                acceptNode: function(textNode) {
                    let parent = textNode.parentNode;
                    while (parent) {
                        const tagName = parent.tagName ? parent.tagName.toLowerCase() : '';
                        if (tagName === 'script' || tagName === 'style' || tagName === 'time') {
                            return NodeFilter.FILTER_REJECT;
                        }
                        parent = parent.parentNode;
                    }
                    return NodeFilter.FILTER_ACCEPT;
                }
            },
            false

        );

        let currentNode;
        const textNodesToProcess = [];
        while (currentNode = walker.nextNode()) {
            textNodesToProcess.push(currentNode);
        }

        textNodesToProcess.forEach(textNode => {
            let text = textNode.nodeValue;
            // Replace specific named entities/characters with their numeric character references
            text = text.replace(/’/g, '&#8217;');     // literal ’
            text = text.replace(/&rsquo;/g, '&#8217;'); // &rsquo;
            text = text.replace(/“/g, '&#8220;');     // literal “
            text = text.replace(/&ldquo;/g, '&#8220;'); // &ldquo;
            text = text.replace(/”/g, '&#8221;');     // literal ”
            text = text.replace(/&rdquo;/g, '&#8221;'); // &rdquo;
            text = text.replace(/«/g, '&#171;');     // literal «
            text = text.replace(/&laquo;/g, '&#171;'); // &laquo;
            text = text.replace(/»/g, '&#187;');     // literal »
            text = text.replace(/&raquo;/g, '&#187;'); // &raquo;
            text = text.replace(/\u00A0/g, '&#160;'); // This converts literal NBSP char to numeric entity
            text = text.replace(/&nbsp;/g, '&#160;'); // This handles named NBSP entity to numeric

            textNode.nodeValue = text;
        });

        let processedHtml = tempDiv.innerHTML; // This re-serializes characters to entities

        // Final string-based replacements to ensure numeric entities are explicitly present
        // This is a safeguard against browser's innerHTML serialization re-converting entities.
        processedHtml = processedHtml.replace(/&nbsp;/g, '&#160;');
        processedHtml = processedHtml.replace(/&rsquo;/g, '&#8217;');
        processedHtml = processedHtml.replace(/&ldquo;/g, '&#8220;');
        processedHtml = processedHtml.replace(/&rdquo;/g, '&#8221;');
        processedHtml = processedHtml.replace(/&laquo;/g, '&#171;');
        processedHtml = processedHtml.replace(/&raquo;/g, '&#187;');

        // Handle double encoding if it occurs (e.g., &amp;#160; -> &#160;)
        processedHtml = processedHtml.replace(/&amp;#(\d+);/g, '&#$1;');

        return processedHtml;
    }

    // Array of all interactive buttons to control their disabled state
    const allInteractiveButtons = []; // Initialized here, populated later

    /**
     * Updates the disabled state of all interactive buttons.
     * Buttons are disabled if any button has 'data-temp-active' set to 'true'.
     */
    function updateAllInteractiveButtonStates() {
        const anyButtonActive = allInteractiveButtons.some(btn => btn.getAttribute('data-temp-active') === 'true');
        
        allInteractiveButtons.forEach(btn => {
            // If any button is in a temporary active state, disable all buttons.
            // The timeout function for the active button will re-enable them.
            btn.disabled = anyButtonActive;
        });

        // Specific handling for modal close buttons
        if (closeOptionsModalButton) {
            closeOptionsModalButton.disabled = anyButtonActive;
        }
        if (closeCustomizeModalButton) {
            closeCustomizeModalButton.disabled = anyButtonActive;
        }
        
        // If no button is active, then set the specific state for undo/redo
        if (!anyButtonActive) {
            updateUndoRedoButtons();
        }
    }

    /**
     * Displays a message in the message box with animation.
     * @param {string} message - The message to display.
     * @param {string} type - 'success', 'error', or 'info' for styling.
     */
    function showMessage(message, type) {
        // Clear any existing timeout to stop previous fade-out/reset sequence
        if (messageTimeoutId) {
            clearTimeout(messageTimeoutId);
            messageBox.classList.remove('message-box-fade-in', 'message-box-fade-out');
            messageBox.removeEventListener('animationend', messageBoxAnimationHandler);
            messageTimeoutId = null;
        }

        // A named function for the animationend handler to allow reliable removal
        function messageBoxAnimationHandler() {
            messageBox.classList.remove('message-box-fade-out');
            messageBox.classList.add('hidden'); // Hide it completely after fade out
            messageBox.removeEventListener('animationend', messageBoxAnimationHandler);
        }

        // Set content, apply styles, and start fade-in
        messageBox.textContent = message;
        messageBox.classList.remove('hidden', 'bg-green-700', 'bg-red-700', 'bg-blue-700', 'bg-gray-400');
        messageBox.classList.add('text-white');

        if (type === 'success') {
            messageBox.classList.add('bg-green-700');
        } else if (type === 'error') {
            messageBox.classList.add('bg-red-700');
        } else { // info
            messageBox.classList.add('bg-blue-700');
        }
        
        messageBox.classList.add('message-box-fade-in');
        console.log(`Message shown: "${message}" (${type})`);

        // Set timeout to start the fade-out process
        messageTimeoutId = setTimeout(() => {
            messageBox.classList.remove('message-box-fade-in');
            messageBox.classList.add('message-box-fade-out');
            messageBox.addEventListener('animationend', messageBoxAnimationHandler);
        }, 4500);
    }

    /**
     * Opens the options modal.
     */
    function openOptionsModal() {
        optionsModalOverlay.classList.remove('hidden');
        initializeToggleSwitchesVisuals(optionsModalOverlay); // Initialize visuals when opening
    }

    /**
     * Closes the options modal.
     * Also sends a message to the customize preview iframe to reset cell states.
     */
    function closeOptionsModal() {
        optionsModalOverlay.classList.add('hidden');
    }

    /**
     * Closes the customize table modal.
     * Also sends a message to the customize preview iframe to reset cell states.
     */
    function closeCustomizeModal() {
        customizeModalOverlay.classList.add('hidden');
        if (customizePreviewIframe && customizePreviewIframe.contentWindow) {
            // Send a message to the iframe to reset its cell states
            customizePreviewIframe.contentWindow.postMessage({ type: 'resetCellStates' }, '*');
        }
    }

    /**
     * Function to handle button group clicks for alignment
     * @param {string} groupId - The ID of the button group container.
     * @param {string} alignmentVarName - The name of the global window variable to update.
     * @param {HTMLElement} [parentContainer=document] - The parent element to search for the group in (e.g., a modal).
     * @param {Function} [callback] - Optional callback function to execute after updating.
     */
    function setupButtonGroup(groupId, alignmentVarName, parentContainer = document, callback = null) {
        const group = parentContainer.querySelector('#' + groupId);
        if (!group) {
            console.warn(`Button group with ID "${groupId}" not found in parentContainer.`);
            return;
        }
        Array.from(group.children).forEach(button => {
            button.addEventListener('click', () => {
                console.log(`Button "${button.dataset.align || button.dataset.mode}" clicked for group "${groupId}"`);
                // Remove 'active' class from all buttons in this group
                Array.from(group.children).forEach(btn => btn.classList.remove('active'));
                // Add 'active' class to the clicked button
                button.classList.add('active');

                // If a global alignment variable name is provided, update it
                if (alignmentVarName) {
                    window[alignmentVarName] = button.dataset.align;
                    console.log(`Global variable ${alignmentVarName} updated to: ${window[alignmentVarName]}`);
                }
                if (callback) {
                    callback();
                }
            });
        });
    }

    /**
     * Applies an alignment class to an element, removing any conflicting alignment classes first.
     * If 'none' is selected, existing alignment classes are preserved.
     * @param {HTMLElement} element - The HTML element to apply alignment to.
     * @param {string} alignment - The alignment to apply ('left', 'center', 'right', or 'none').
     * @param {string[]} alignmentClasses - An array of all possible alignment classes.
     */
    function applyAlignment(element, alignment, alignmentClasses) {
        if (!element) {
            console.warn("Attempted to apply alignment to a null or undefined element.");
            return;
        }
        
        // If a specific alignment (left, center, right) is selected, remove all conflicting ones first
        alignmentClasses.forEach(cls => {
            if (element.classList.contains(cls)) {
                element.classList.remove(cls);
            }
        });

        if (alignment === 'none') {
            if (element.hasAttribute('class') && element.classList.length === 0) {
                element.removeAttribute('class');
            }
            return; 
        }
        
        element.classList.add(`text-${alignment}`);
    }
    /**
     * Calculates the effective number of columns in a given row, considering colspans.
     * @param {HTMLTableRowElement} row - The table row element.
     * @returns {number} The total number of columns spanned by cells in the row.
     */
    function getEffectiveColumnCount(row) {
        if (!row) return 0;
        let count = 0;
        Array.from(row.children).forEach(cell => {
            count += parseInt(cell.getAttribute('colspan') || '1', 10);
        });
        return count;
    }

    /**
     * Populates the table search dropdown with IDs and captions from tables in the editor.
     * It also stores the starting character index of each table in the Monaco editor content
     * for efficient jumping.
     */
    function populateTableSearchDropdown(keepSelectionValue) {
        if (!monacoEditor || !tableSearchDropdown) return;

        // Store the currently selected value if not provided
        const currentSelectedValue = keepSelectionValue !== undefined ? keepSelectionValue : tableSearchDropdown.value;

        const htmlContent = monacoEditor.getValue();
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlContent, 'text/html');
        const tables = Array.from(doc.querySelectorAll('table'));

        // Clear existing options and map
        tableSearchDropdown.innerHTML = '<option value="">-- Select a table --</option>';
        tableDataMap = new Map();

        let unidCounter = 1;
        tables.forEach((table, originalTableIndex) => {
            let tableId = table.id;
            let tableCaption = '';

            const captionElement = table.querySelector('caption');
            if (captionElement && captionElement.textContent.trim()) {
                tableCaption = captionElement.textContent.trim();
            }

            let optionValue;
            let startIndex = -1;

            if (tableId) {
                optionValue = `id:${tableId}`;
                const idRegex = new RegExp(`<table[^>]*id=["']${tableId}["'][^>]*>`, 'i');
                const idMatch = htmlContent.match(idRegex);
                if (idMatch) {
                    startIndex = idMatch.index;
                }
            } else {
                optionValue = `unid:${unidCounter}`; // Unique ID for this dropdown option
                let tempHtml = htmlContent;
                let count = 0;
                let regex = /<table/gi;
                let match;
                while ((match = regex.exec(tempHtml)) !== null) {
                    if (count === originalTableIndex) {
                        startIndex = match.index;
                        break;
                    }
                    count++;
                }
                unidCounter++;
            }

            if (startIndex !== -1) {
                const option = document.createElement('option');
                option.value = optionValue;
                option.textContent = `${tableCaption ? captionElement.textContent.trim() + ' ' : ''}${tableId ? '(ID: ' + tableId + ')' : '(Table ' + (originalTableIndex + 1) + ')'}`;
                tableSearchDropdown.appendChild(option);

                const tableOuterHtml = table.outerHTML;
                tableDataMap.set(optionValue, {
                    startIndex: startIndex,
                    outerHTML: tableOuterHtml,
                    length: tableOuterHtml.length
                });
            } else {
                console.warn(`Could not find table "${tableId || ('Table ' + (originalTableIndex + 1))}" in editor content by regex.`);
            }
        });

        // --- NEW: Re-select the previously selected value ---
        if (currentSelectedValue) {
            // Check if the option still exists after re-population
            const optionExists = Array.from(tableSearchDropdown.options).some(
                option => option.value === currentSelectedValue
            );
            if (optionExists) {
                tableSearchDropdown.value = currentSelectedValue;
                // If the selected value is re-applied, and the modal is open, update preview
                if (!customizeModalOverlay.classList.contains('hidden') && customizeButton.disabled === false) {
                     // Check if customize button is not disabled to ensure it's an active interaction
                    // and not just a background update.
                    updateCustomizeModalPreview();
                }
            } else {
                // If the previously selected option no longer exists (e.g., table was removed),
                // reset to default and clear any highlights
                tableSearchDropdown.value = '';
                clearMonacoHighlight();
                updateCustomizeModalPreview(''); // Clear preview if table removed
            }
        } else {
            // If nothing was selected before, clear any highlights
            clearMonacoHighlight();
            updateCustomizeModalPreview(''); // Clear preview
        }
    }

    /**
     * Contains the core logic for formatting a single HTML table.
     * This function is designed to be reusable by both universal and specific table formatting.
     * @param {HTMLElement} table - The table DOM element to format.
     * @param {object} options - An object containing all formatting options (checkbox states, alignment values).
     */
    function formatTableLogic(table, options) {
        // *** FIX: List of classes this function GLOBALLY manages and should reset ***
        const globallyManagedClasses = [
            'table', 'table-condensed', 'table-bordered', 'table-striped', 'table-hover',
            'small', 'active', 'wb-inv'
            // NOTE: 'nowrap', 'fnt-nrml', and 'text-*' are now treated as cell-specific and are NOT reset here.
        ];
        const financeRegex = /^\s*[-+]?(?:\d{1,3}(?:[,\s]\d{3})*|\d+)(?:[.,]\d+)?\s*$/;
        const smallClass = 'small';
        const alignmentClasses = ['text-left', 'text-center', 'text-right'];

        // --- 1. MODIFIED Cleanup: Only remove globally managed classes and accessibility attributes ---
        table.classList.remove(...globallyManagedClasses);
        Array.from(table.querySelectorAll('*')).forEach(el => {
            el.removeAttribute('id');
            el.removeAttribute('headers');
            el.removeAttribute('scope');
            el.classList.remove('active', 'wb-inv'); // 'active' can be on rows, 'wb-inv' on captions
        });


        // --- 2. Apply Table-level ID and Classes ---
        if (options.specificTableId) {
            let customId = options.tableIdPrefix;
            if (customId && customId.trim() !== '') {
                table.id = customId.trim();
            } else {
                table.removeAttribute('id');
            }
        } else if (options.applyId) {
            let prefix = options.tableIdPrefix || 'tbl';
            if (options.isFigureTable) {
                prefix = options.figureDataIdPrefix || 'ftbl';
            }
            table.id = `${prefix}${options.assignedIdCounter}`;
        } else {
            table.removeAttribute('id');
        }

        if (options.applyClassTables) table.classList.add('table', 'table-condensed');
        if (options.applyBordered) table.classList.add('table-bordered');
        if (options.applyStriped) table.classList.add('table-striped');
        if (options.applyHover) table.classList.add('table-hover');
        if (options.applyClassSmall) table.classList.add(smallClass);


        // --- 3. Handle Caption ---
        let existingCaptionElement = table.querySelector('caption');
        const shouldHaveCaption = options.applyCaption || options.applyAutoCaption;

        if (shouldHaveCaption) {
            if (!existingCaptionElement) {
                existingCaptionElement = document.createElement('caption');
                table.insertBefore(existingCaptionElement, table.firstChild);
            }
            // MODIFIED: Only apply global alignment if no specific alignment exists
            const hasExistingAlignment = alignmentClasses.some(c => existingCaptionElement.classList.contains(c));
            if (!hasExistingAlignment) {
                applyAlignment(existingCaptionElement, options.currentCaptionAlignment, alignmentClasses);
            }

            if (options.applyInvisibleCaption) {
                existingCaptionElement.classList.add('wb-inv');
            }

            if (options.applyAutoCaption) {
                let extractedContent = '';
                 if (options.specificTableId) {
                    const firstRow = table.querySelector('tr');
                    if (firstRow) {
                        const firstCell = firstRow.firstElementChild;
                        if (firstCell && (firstCell.tagName.toLowerCase() === 'th' || firstCell.tagName.toLowerCase() === 'td')) {
                            const colspan = parseInt(firstCell.getAttribute('colspan') || '1', 10);
                            const totalColumns = getEffectiveColumnCount(firstRow);
                            if (colspan === totalColumns && firstCell.textContent.trim() !== '') {
                                extractedContent = firstCell.textContent.trim();
                            }
                        }
                    }
                } else {
                    let prevSibling = (table.parentNode.classList.contains('table-responsive') ? table.parentNode : table).previousElementSibling;
                    while (prevSibling) {
                        if (['P', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6'].includes(prevSibling.tagName)) {
                            extractedContent = prevSibling.textContent.trim();
                            prevSibling.remove();
                            break;
                        }
                        if (prevSibling.nodeType === Node.TEXT_NODE && prevSibling.textContent.trim() !== '') break;
                        prevSibling = prevSibling.previousElementSibling;
                    }
                }
                existingCaptionElement.textContent = extractedContent || `[insert table caption]`;
            } else if (!existingCaptionElement.textContent.trim() || existingCaptionElement.textContent.trim() === '[insert table caption]') {
                existingCaptionElement.textContent = `[insert table caption]`;
            }
        } else {
            if (existingCaptionElement) existingCaptionElement.remove();
        }


        // --- 4. Reconstruct thead, tbody, tfoot ---
        const rowsForThead = [];
        const rowsForTbody = [];
        const rowsForTfoot = [];
        const allDirectChildren = Array.from(table.children).filter(child => ['THEAD', 'TBODY', 'TFOOT', 'TR', 'CAPTION', 'COLGROUP'].includes(child.tagName));
        allDirectChildren.forEach(child => {
            if (child.tagName === 'CAPTION' || child.tagName === 'COLGROUP') {} 
            else if (child.tagName === 'THEAD') { rowsForThead.push(...Array.from(child.querySelectorAll('tr'))); child.remove(); } 
            else if (child.tagName === 'TFOOT') { rowsForTfoot.push(...Array.from(child.querySelectorAll('tr'))); child.remove(); } 
            else if (child.tagName === 'TBODY') { rowsForTbody.push(...Array.from(child.querySelectorAll('tr'))); child.remove(); } 
            else if (child.tagName === 'TR') { rowsForTbody.push(child); child.remove(); }
        });

        let headerRowCount = 0;
        if (options.applyHeader && rowsForThead.length === 0) {
            const potentialHeaderRows = [...rowsForTbody];
            let maxRowSpanEnd = -1;
            for (let i = 0; i < potentialHeaderRows.length; i++) {
                const currentRow = potentialHeaderRows[i];
                headerRowCount = i + 1;
                const cellsInCurrentRow = Array.from(currentRow.querySelectorAll('th, td'));
                cellsInCurrentRow.forEach(cell => {
                    const rowspan = parseInt(cell.getAttribute('rowspan') || '1', 10);
                    maxRowSpanEnd = Math.max(maxRowSpanEnd, i + rowspan - 1);
                });
                if (i >= maxRowSpanEnd) break;
            }
        }

        if (headerRowCount > 0) {
            const headerRowsToMove = rowsForTbody.splice(0, headerRowCount);
            headerRowsToMove.forEach(row => {
                const clonedRow = row.cloneNode(true);
                 Array.from(clonedRow.querySelectorAll('td')).forEach(td => {
                    const newTh = document.createElement('th');
                    Array.from(td.attributes).forEach(attr => newTh.setAttribute(attr.name, attr.value));
                    newTh.innerHTML = td.innerHTML;
                    td.parentNode.replaceChild(newTh, td);
                });
                rowsForThead.push(clonedRow);
            });
        }

        if (options.applyMakeTfootFromColspan && rowsForTfoot.length === 0 && rowsForTbody.length > 0) {
            const lastRowInTbodyTemp = rowsForTbody[rowsForTbody.length - 1];
            const firstRowForColCount = rowsForThead.length > 0 ? rowsForThead[0] : (rowsForTbody.length > 0 ? rowsForTbody[0] : null);
            if (firstRowForColCount) {
                const totalColumns = getEffectiveColumnCount(firstRowForColCount);
                if (totalColumns > 0 && lastRowInTbodyTemp.cells.length === 1) {
                    const singleCell = lastRowInTbodyTemp.firstElementChild;
                    const colspan = parseInt(singleCell.getAttribute('colspan') || '1', 10);
                    if (colspan >= totalColumns) {
                        rowsForTfoot.push(rowsForTbody.pop());
                    }
                }
            }
        }

        const newTheadElement = document.createElement('thead');
        rowsForThead.forEach(row => newTheadElement.appendChild(row));
        const newTbodyElement = document.createElement('tbody');
        rowsForTbody.forEach(row => newTbodyElement.appendChild(row));
        const newTfootElement = document.createElement('tfoot');
        rowsForTfoot.forEach(row => newTfootElement.appendChild(row));


        // --- 5. Apply Row Header and its Alignment (only to newTbodyElement rows) ---
        Array.from(newTbodyElement.querySelectorAll('tr')).forEach(row => {
            const firstCell = row.firstElementChild;
            if (firstCell) {
                if (options.applyRowHeader) {
                    if (firstCell.tagName.toLowerCase() !== 'th') {
                        const newTh = document.createElement('th');
                        Array.from(firstCell.attributes).forEach(attr => newTh.setAttribute(attr.name, attr.value));
                        newTh.innerHTML = firstCell.innerHTML;
                        row.replaceChild(newTh, firstCell);
                        const hasExistingAlignment = alignmentClasses.some(c => newTh.classList.contains(c));
                        if (!hasExistingAlignment) applyAlignment(newTh, options.currentRowHeaderAlignment, alignmentClasses);
                    } else {
                        const hasExistingAlignment = alignmentClasses.some(c => firstCell.classList.contains(c));
                        if (!hasExistingAlignment) applyAlignment(firstCell, options.currentRowHeaderAlignment, alignmentClasses);
                    }
                } else {
                    if (firstCell.tagName.toLowerCase() !== 'td') {
                        const newTd = document.createElement('td');
                        Array.from(firstCell.attributes).forEach(attr => newTd.setAttribute(attr.name, attr.value));
                        newTd.innerHTML = firstCell.innerHTML;
                        row.replaceChild(newTd, firstCell);
                    }
                }
            }
        });


        // --- 6. Apply Data Cells Alignment, Fix Empty Cells, Remove P Tags ---
        const allCells = [...newTheadElement.querySelectorAll('th, td'), ...newTbodyElement.querySelectorAll('th, td'), ...newTfootElement.querySelectorAll('th, td')];
        allCells.forEach(cell => {
            if (options.applyFixEmptyCells && cell.textContent.trim() === '' && !cell.innerHTML.includes('&nbsp;') && !cell.innerHTML.includes('&#160;')) {
                cell.innerHTML = '&#160;';
            }
            if (options.applyRemovePTags) {
                Array.from(cell.querySelectorAll('p')).forEach(p => {
                    while (p.firstChild) p.parentNode.insertBefore(p.firstChild, p);
                    p.remove();
                });
            }
            
            const isTfootCell = cell.closest('tfoot');
            const isTheadCell = cell.closest('thead');
            const isTbodyCell = cell.closest('tbody');
            const hasExistingAlignment = alignmentClasses.some(c => cell.classList.contains(c));

            if (cell.tagName.toLowerCase() === 'td' && isTbodyCell) {
                 if (options.applyFinanceTable && financeRegex.test(cell.textContent.trim())) {
                    applyAlignment(cell, 'right', alignmentClasses);
                    cell.classList.add('nowrap');
                } else if (!hasExistingAlignment) {
                    applyAlignment(cell, options.currentDataCellsAlignment, alignmentClasses);
                }
            } else if (cell.tagName.toLowerCase() === 'th' && !hasExistingAlignment) {
                if (isTheadCell) {
                    applyAlignment(cell, options.currentColHeaderAlignment, alignmentClasses);
                } else if (isTbodyCell && cell.hasAttribute('colspan')) {
                    applyAlignment(cell, options.currentColspanHeaderAlignment, alignmentClasses);
                }
            }
        });

        // --- 7. Apply Bold Totals (only to newTbodyElement rows) ---
        Array.from(newTbodyElement.querySelectorAll('tr')).forEach(row => {
            const thInRow = row.querySelector('th');
            if (options.applyBoldTotals && thInRow && (thInRow.textContent.trim().toLowerCase() === 'total' || thInRow.textContent.trim().toLowerCase() === 'subtotal')) {
                Array.from(row.querySelectorAll('td')).forEach(td => {
                    if (!td.querySelector('strong')) {
                        td.innerHTML = `<strong>${td.innerHTML}</strong>`;
                    }
                });
            }
        });

        // --- 8. Append the structural elements to the table in correct order ---
        if (newTheadElement.children.length > 0) table.appendChild(newTheadElement);
        if (options.applyTfootBeforeTbody) {
            if (newTfootElement.children.length > 0) table.appendChild(newTfootElement);
            if (newTbodyElement.children.length > 0) table.appendChild(newTbodyElement);
        } else {
            if (newTbodyElement.children.length > 0) table.appendChild(newTbodyElement);
            if (newTfootElement.children.length > 0) table.appendChild(newTfootElement);
        }

        // --- 9. Apply Small Class to TRs ---
        if (options.applyAddSmallToTr) {
            Array.from(table.querySelectorAll('tr')).forEach(tr => tr.classList.add(smallClass));
        }

        // --- 10. Apply Active Classes ---
        if (options.applyActiveColHeaders) Array.from(table.querySelectorAll('thead tr')).forEach(tr => tr.classList.add('active'));
        if (options.activeColspanHeadersCheckboxValue) Array.from(table.querySelectorAll('tbody th[colspan]')).forEach(th => th.classList.add('active'));
        if (options.activeRowHeadersCheckboxValue) Array.from(table.querySelectorAll('tbody tr > th:first-child')).forEach(th => th.classList.add('active'));

        // --- 11. FINAL GENERAL CLASS CLEANUP: Remove any remaining empty class attributes ---
        Array.from(table.querySelectorAll('*')).forEach(el => {
            if (el.hasAttribute('class') && el.classList.length === 0) {
                el.removeAttribute('class');
            }
        });

        return table;
    }


    /**
     * Formats all HTML tables in the editor based on universal options.
     */
    function formatHtmlTables() {
        pushUndoState(); // Save state before action
        closeOptionsModal();
        if (!monacoEditor) { showMessage('Editor is still loading, please hold on.', 'info'); return; }
        const htmlText = getEditorContent();
        if (!htmlText.trim()) { showMessage('No HTML content to format.', 'info'); return; }

        formatButton.textContent = 'Formatting...';
        formatButton.setAttribute('data-temp-active', 'true');
        updateAllInteractiveButtonStates();

        try {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlText;
            const tables = tempDiv.querySelectorAll('table');
            if (tables.length === 0) { showMessage('No HTML tables found to format.', 'info'); return; }

            let tblCounter = 1;
            let ftblCounter = 1;

            tables.forEach(table => {
                const isFigureTable = table.closest('figure') !== null;
                const options = {
                    applyId: idCheckbox.checked,
                    tableIdPrefix: pageIdPrefixInput.value.trim(),
                    figureDataIdPrefix: figureDataIdPrefixInput.value.trim(),
                    applyClassTables: classTablesCheckbox.checked,
                    applyCaption: captionCheckbox.checked,
                    applyAutoCaption: autoCaptionCheckbox.checked,
                    applyInvisibleCaption: invCaptionCheckbox.checked,
                    applyFixEmptyCells: fixEmptyCellsCheckbox.checked,
                    applyRemovePTags: removePTagsCheckbox.checked,
                    applyMakeTfootFromColspan: makeTfootFromColspanCheckbox.checked,
                    applyTfootBeforeTbody: document.getElementById('make-tfoot-before-tbody-checkbox').checked,
                    applyAddSmallToTr: addSmallToTrCheckbox.checked,
                    applyHeader: headerCheckbox.checked,
                    applyRowHeader: rowHeaderCheckbox.checked,
                    applyBordered: borderedCheckbox.checked,
                    applyStriped: stripedCheckbox.checked,
                    applyHover: hoverCheckbox.checked,
                    applyActiveColHeaders: activeColHeadersCheckbox.checked,
                    activeColspanHeadersCheckboxValue: activeColspanHeadersCheckbox.checked,
                    activeRowHeadersCheckboxValue: activeRowHeadersCheckbox.checked,
                    applyClassSmall: classSmallCheckboxElement.checked,
                    applyFinanceTable: financeTableCheckbox.checked,
                    applyBoldTotals: boldTotalsCheckbox.checked,
                    currentCaptionAlignment: window.captionAlignment,
                    currentColHeaderAlignment: window.colHeaderAlignment,
                    currentRowHeaderAlignment: window.rowHeaderAlignment,
                    currentColspanHeaderAlignment: window.colspanHeaderAlignment,
                    currentDataCellsAlignment: window.dataCellsAlignment,
                    assignedIdCounter: isFigureTable ? ftblCounter++ : tblCounter++,
                    isFigureTable: isFigureTable,
                    specificTableId: false
                };
                formatTableLogic(table, options);
            });

            let formattedContent = tempDiv.innerHTML;
            formattedContent = protectDataAttributes(formattedContent);
            formattedContent = html_beautify(formattedContent, { indent_size: 4, space_in_paren: true, preserve_newlines: false, extra_liners: [] });
            formattedContent = restoreDataAttributes(formattedContent);
            formattedContent = convertAllEntitiesToNumeric(formattedContent);
            setEditorContent(formattedContent);
            const prevSelectedTable = tableSearchDropdown.value; 
            applyEntityHighlighting();
            populateTableSearchDropdown(prevSelectedTable); 

        } catch (e) {
            console.error("Error formatting HTML tables:", e);
            showMessage('An error occurred during formatting.', 'error');
        } finally {
            setTimeout(() => {
                formatButton.textContent = 'Format Tables';
                formatButton.removeAttribute('data-temp-active');
                updateAllInteractiveButtonStates();
                showMessage('HTML tables formatted successfully!', 'success');
            }, 1500);
        }
    }
    
    // --- Refined autoScopeTableIDs Function (Handling empty A1 cell) ---
    function autoScopeTableIDs(tableElement, tableIndex, forceComplexity = undefined) {
        if (!tableElement || tableElement.tagName !== 'TABLE') {
            console.error("Invalid input: autoScopeTableIDs requires a TABLE element.");
            return "";
        }

        let tableBaseId = tableElement.id;
        if (!tableBaseId) {
            tableBaseId = `t${tableIndex + 1}`;
            tableElement.id = tableBaseId;
        }

        let a1Cell = null;
        const firstRow = tableElement.rows[0];
        if (firstRow && firstRow.cells.length > 0) {
            a1Cell = firstRow.cells[0];
        }
        const isA1Empty = a1Cell && a1Cell.textContent.trim() === '';

        Array.from(tableElement.querySelectorAll('thead th, thead td, tbody th, tbody td')).forEach(cell => {
            cell.removeAttribute('id');
            cell.removeAttribute('headers');
            cell.removeAttribute('scope');
            if (cell === a1Cell && isA1Empty) {
                cell.innerHTML = '&#160;';
            }
        });

        const firstRowForColCount = tableElement.querySelector('tr');
        const totalColumns = firstRowForColCount ? getEffectiveColumnCount(firstRowForColCount) : 0;

        let isComplexTable;
        if (forceComplexity === 'simple') {
            isComplexTable = false;
        } else if (forceComplexity === 'complex') {
            isComplexTable = true;
        } else {
            const tbodyCells = Array.from(tableElement.querySelectorAll('tbody th, tbody td'));
            isComplexTable = tbodyCells.some(cell => cell.hasAttribute('rowspan') || cell.hasAttribute('colspan'));
        }

        if (!isComplexTable) {
            Array.from(tableElement.querySelectorAll('thead th, tbody th')).forEach(th => {
                if (th === a1Cell && isA1Empty) return;

                const parentSection = th.closest('thead, tbody');
                if (parentSection && parentSection.tagName === 'THEAD') {
                    th.setAttribute('scope', th.hasAttribute('colspan') ? 'colgroup' : 'col');
                } else if (parentSection && parentSection.tagName === 'TBODY') {
                    if (th.hasAttribute('rowspan')) {
                        th.setAttribute('scope', 'rowgroup');
                    } else if (th.hasAttribute('colspan')) {
                        const colspanVal = parseInt(th.getAttribute('colspan') || '1', 10);
                        th.setAttribute('scope', (totalColumns > 0 && colspanVal >= totalColumns) ? 'colgroup' : 'row');
                    } else {
                        th.setAttribute('scope', 'row');
                    }
                }
            });
        } else {
            let colHeaderCounter = 0, colSpanHeaderCounter = 0, rowHeaderCounter = 0;
            let rowSpanHeaderCounter = 0, rowColSpanHeaderCounter = 0, headerIdCounter = 0;

            Array.from(tableElement.querySelectorAll('thead th, tbody th')).forEach(cell => {
                if (cell === a1Cell && isA1Empty) return;
                
                const parentSection = cell.closest('thead, tbody');
                let idPrefix = `${tableBaseId}-`;
                let counter;

                if (parentSection && parentSection.tagName === 'THEAD') {
                    if (cell.hasAttribute('colspan')) {
                        idPrefix += 'csh-'; counter = colSpanHeaderCounter++;
                    } else {
                        idPrefix += 'ch-'; counter = colHeaderCounter++;
                    }
                } else if (parentSection && parentSection.tagName === 'TBODY') {
                    if (cell.hasAttribute('colspan')) {
                        const colspanVal = parseInt(cell.getAttribute('colspan') || '1', 10);
                        if (totalColumns > 0 && colspanVal >= totalColumns) {
                            idPrefix += 'rcsh-'; counter = rowColSpanHeaderCounter++;
                        } else {
                            idPrefix += 'rh-'; counter = rowHeaderCounter++;
                        }
                    } else if (cell.hasAttribute('rowspan')) {
                        idPrefix += 'rsh-'; counter = rowSpanHeaderCounter++;
                    } else {
                        idPrefix += 'rh-'; counter = rowHeaderCounter++;
                    }
                } else {
                    idPrefix += 'th-'; counter = headerIdCounter++;
                }
                cell.id = `${idPrefix}${counter}`;
            });

            const rows = Array.from(tableElement.rows);
            const grid = [];
            const theadHeaders = Array(totalColumns).fill(null);

            rows.forEach((row, rowIndex) => {
                let currentCol = 0;
                Array.from(row.cells).forEach(cell => {
                    const parentSection = cell.closest('thead, tbody, tfoot');
                    if (parentSection && parentSection.tagName === 'TFOOT') return;

                    while (grid[rowIndex] && grid[rowIndex][currentCol]) {
                        currentCol++;
                    }
                    if (!grid[rowIndex]) grid[rowIndex] = [];

                    const colspan = parseInt(cell.getAttribute('colspan') || '1', 10);
                    const rowspan = parseInt(cell.getAttribute('rowspan') || '1', 10);

                    if (parentSection && parentSection.tagName === 'THEAD' && cell.tagName === 'TH') {
                        for (let c = 0; c < colspan; c++) {
                            theadHeaders[currentCol + c] = cell;
                        }
                    }

                    for (let r = 0; r < rowspan; r++) {
                        if (!grid[rowIndex + r]) grid[rowIndex + r] = [];
                        for (let c = 0; c < colspan; c++) {
                            grid[rowIndex + r][currentCol + c] = cell;
                        }
                    }
                    currentCol += colspan;
                });
            });

            rows.forEach((row, rowIndex) => {
                const parentSection = row.closest('thead, tbody, tfoot');
                if (!parentSection || parentSection.tagName !== 'TBODY') return;

                let rowHeadersInThisRow = [];
                let latestFullColspan = null;

                for (let r = rowIndex - 1; r >= 0; r--) {
                    const cellInColumnZero = grid[r] ? grid[r][0] : null;
                    if (cellInColumnZero && cellInColumnZero.tagName === 'TH' && parseInt(cellInColumnZero.getAttribute('colspan') || '1', 10) >= totalColumns) {
                        latestFullColspan = cellInColumnZero;
                        break;
                    }
                }
                
                Array.from(row.cells).forEach(cell => {
                    if (cell.tagName === 'TH') {
                        rowHeadersInThisRow.push(cell);
                    }
                });

                Array.from(row.cells).forEach((cell) => {
                    const isFullWidthColspanTH = cell.tagName === 'TH' &&
                                                 cell.hasAttribute('colspan') &&
                                                 parseInt(cell.getAttribute('colspan') || '1', 10) >= totalColumns;

                    if (isFullWidthColspanTH) {
                        cell.removeAttribute('headers');
                        return; 
                    }

                    const headersToApply = new Set();

                    if (latestFullColspan) {
                        headersToApply.add(latestFullColspan.id);
                    }
                    
                    let cellColIndex = -1;
                    for (let c = 0; c < (grid[rowIndex]?.length || 0); c++) {
                        if (grid[rowIndex][c] === cell) {
                            cellColIndex = c;
                            break;
                        }
                    }
                    if (cellColIndex !== -1 && theadHeaders[cellColIndex] && theadHeaders[cellColIndex].id) {
                        headersToApply.add(theadHeaders[cellColIndex].id);
                    }

                    rowHeadersInThisRow.forEach(rh => {
                        if (rh !== cell) {
                            headersToApply.add(rh.id);
                        }
                    });

                    if (headersToApply.size > 0) {
                        cell.setAttribute('headers', Array.from(headersToApply).join(' '));
                    } else {
                        cell.removeAttribute('headers');
                    }
                });
            });
        }

        Array.from(tableElement.querySelectorAll('*')).forEach(el => {
            if (el.hasAttribute('class') && el.classList.length === 0) {
                el.removeAttribute('class');
            }
        });

        return tableElement.outerHTML;
    }

    function cleanEmptyHeadersAttribute(htmlString) {
        // Use a regular expression to find headers="" or headers='' (case-insensitive for attribute name)
        // and replace them with an empty string.
        // This targets attributes with no content between the quotes.
        const cleanedHtml = htmlString.replace(/\sheaders=["']{2}/gi, '');
        return cleanedHtml;
    }
    /**
     * Gathers options from the customize modal and formats the selected table in memory.
     * @returns {string} The HTML string of the formatted table.
     */
    function generatePreviewTableHtml() {
        const selectedValue = tableSearchDropdown.value;
        const tableInfo = tableDataMap.get(selectedValue);
        if (!tableInfo) return '';

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = tableInfo.outerHTML;
        const clonedTable = tempDiv.querySelector('table');
        if (!clonedTable) { console.error("Failed to clone table for preview."); return ''; }

        const customId = customizePageIdPrefixInput.value.trim();
        
        const customizeOptions = {
            tableIdPrefix: customId,
            applyClassTables: customizeClassTablesCheckbox.checked,
            applyCaption: customizeCaptionCheckbox.checked,
            applyInvisibleCaption: customizeInvCaptionCheckbox.checked,
            applyFixEmptyCells: customizeFixEmptyCellsCheckbox.checked,
            applyRemovePTags: customizeRemovePTagsCheckbox.checked,
            applyMakeTfootFromColspan: customizeMakeTfootFromColspanCheckbox.checked,
            applyTfootBeforeTbody: document.getElementById('customize-make-tfoot-before-tbody-checkbox').checked,
            applyAddSmallToTr: customizeAddSmallToTrCheckbox.checked,
            applyHeader: customizeHeaderCheckbox.checked,
            applyRowHeader: customizeRowHeaderCheckbox.checked,
            applyBordered: customizeBorderedCheckbox.checked,
            applyStriped: customizeStripedCheckbox.checked,
            applyHover: customizeHoverCheckbox.checked,
            applyActiveColHeaders: customizeActiveColHeadersCheckbox.checked,
            activeColspanHeadersCheckboxValue: customizeActiveColspanHeadersCheckbox.checked,
            activeRowHeadersCheckboxValue: customizeActiveRowHeadersCheckbox.checked,
            applyClassSmall: customizeClassSmallCheckboxElement.checked,
            applyFinanceTable: customizeFinanceTableCheckbox.checked,
            applyBoldTotals: customizeBoldTotalsCheckbox.checked,
            currentCaptionAlignment: window.customizeCaptionAlignment,
            currentColHeaderAlignment: window.customizeColHeaderAlignment,
            currentRowHeaderAlignment: window.customizeRowHeaderAlignment,
            currentColspanHeaderAlignment: window.customizeColspanHeaderAlignment,
            currentDataCellsAlignment: window.customizeDataCellsAlignment,
            specificTableId: selectedValue
        };

        const formattedTableElement = formatTableLogic(clonedTable, customizeOptions);
        let formattedTableOuterHTML = formattedTableElement.outerHTML;
        formattedTableOuterHTML = protectDataAttributes(formattedTableOuterHTML);
        formattedTableOuterHTML = html_beautify(formattedTableOuterHTML, { indent_size: 4, space_in_paren: true, preserve_newlines: false, extra_liners: [] });
        formattedTableOuterHTML = restoreDataAttributes(formattedTableOuterHTML);
        formattedTableOuterHTML = convertAllEntitiesToNumeric(formattedTableOuterHTML);

        return formattedTableOuterHTML;
    }

    /**
     * Updates the customize modal's preview iframe based on current option selections.
     * @param {string} [htmlContentToPreview] - Optional. If provided, this HTML is used for the iframe.
     * Otherwise, generatePreviewTableHtml() is called to create the HTML.
     */
    function updateCustomizeModalPreview(htmlContentToPreview) {
        if (htmlContentToPreview === undefined) {
            htmlContentToPreview = generatePreviewTableHtml();
        }
        updateCustomizePreview(htmlContentToPreview);
    }

    /**
     * Updates the content of the customize preview iframe with enhanced selection capabilities.
     * @param {string} tableHtmlString - The HTML string of the table to display in the iframe.
     */
    function updateCustomizePreview(tableHtmlString) {
        if (!customizePreviewIframe) {
            console.warn("Customize preview iframe not found.");
            return;
        }

        // The complete HTML for the iframe content, including new styles and a more robust script
        const baseHtml = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Table Preview</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css">
    <link rel="stylesheet" href="https://www.canada.ca/etc/designs/canada/wet-boew/css/theme.min.css">
    <link rel="stylesheet" href="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@latest/dist/gcds/gcds.css">
    <style>
        /* --- Enhanced Selection and Hover Styles --- */
        body { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
        td, th, caption { transition: background-color 0.1s ease-in-out; }
        .cell-hover { background-color: rgba(173, 216, 230, 0.3) !important; /* Light blue transparent hover */ }
        .highlighted-cell { background-color: rgba(173, 216, 230, 0.7) !important; border: 1px solid #3b82f6 !important; }
        .fnt-nrml { font-weight: normal !important; }
        .mrgn-lft-sm { margin-left: 0.5rem; }
        .mrgn-lft-md { margin-left: 1rem; }
        .mrgn-lft-lg { margin-left: 1.5rem; }
        .mrgn-lft-xl { margin-left: 2rem; }
    </style>
</head>
<body>
    <main property="mainContentOfPage" resource="#wb-main" typeof="WebPageElement">
        <div class="container">
            <div class="table-responsive">
                ${tableHtmlString}
            </div>
        </div>
    </main>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"><\/script>
    <script src="https://www.canada.ca/etc/designs/canada/wet-boew/js/wet-boew.min.js"><\/script>
    <script src="https://www.canada.ca/etc/designs/canada/wet-boew/js/theme.min.js"><\/script>
    <script>
        // --- Robust Live Select System for Table Preview ---
        document.addEventListener('DOMContentLoaded', () => {
            const table = document.querySelector('table');
            if (!table) return;

            let isMouseDown = false;
            let startCell = null;
            const selectedCells = new Set();
            const grid = []; // Will store a map of the table cells for easy lookup

            // 1. Build a grid map of the table to handle colspan and rowspan correctly
            const rows = Array.from(table.rows);
            rows.forEach((row, rIndex) => {
                grid[rIndex] = grid[rIndex] || [];
                let cIndex = 0;
                Array.from(row.cells).forEach(cell => {
                    while(grid[rIndex][cIndex]) {
                        cIndex++;
                    }
                    const colspan = parseInt(cell.getAttribute('colspan') || '1');
                    const rowspan = parseInt(cell.getAttribute('rowspan') || '1');
                    for(let rs = 0; rs < rowspan; rs++) {
                        for (let cs = 0; cs < colspan; cs++) {
                            if (!grid[rIndex + rs]) grid[rIndex + rs] = [];
                            grid[rIndex + rs][cIndex + cs] = cell;
                        }
                    }
                    cIndex += colspan;
                });
            });

            // Helper function to clear all selections
            function clearAllHighlights() {
                document.querySelectorAll('.highlighted-cell').forEach(cell => cell.classList.remove('highlighted-cell'));
                selectedCells.clear();
            }

            // 2. Add event listeners to the table
            table.addEventListener('mousedown', (e) => {
                const targetCell = e.target.closest('th, td, caption');
                if (!targetCell) return;

                e.preventDefault();
                isMouseDown = true;
                startCell = targetCell;

                if (!e.ctrlKey) {
                    clearAllHighlights();
                }
                
                if (selectedCells.has(targetCell) && e.ctrlKey) {
                    targetCell.classList.remove('highlighted-cell');
                    selectedCells.delete(targetCell);
                } else {
                    targetCell.classList.add('highlighted-cell');
                    selectedCells.add(targetCell);
                }
            });

            table.addEventListener('mouseover', (e) => {
                const targetCell = e.target.closest('th, td, caption');
                
                document.querySelectorAll('.cell-hover').forEach(c => c.classList.remove('cell-hover'));
                if (targetCell) {
                    targetCell.classList.add('cell-hover');
                }

                if (!isMouseDown || !startCell || !targetCell) return;

                let startCoords = { r: -1, c: -1 };
                let endCoords = { r: -1, c: -1 };
                grid.forEach((row, r) => {
                    row.forEach((cell, c) => {
                        if (cell === startCell) startCoords = { r, c };
                        if (cell === targetCell) endCoords = { r, c };
                    });
                });

                if (startCoords.r === -1 || endCoords.r === -1) return;

                const minRow = Math.min(startCoords.r, endCoords.r);
                const maxRow = Math.max(startCoords.r, endCoords.r);
                const minCol = Math.min(startCoords.c, endCoords.c);
                const maxCol = Math.max(startCoords.c, endCoords.c);

                clearAllHighlights();
                for (let r = minRow; r <= maxRow; r++) {
                    for (let c = minCol; c <= maxCol; c++) {
                        if (grid[r] && grid[r][c]) {
                            const cellToSelect = grid[r][c];
                            cellToSelect.classList.add('highlighted-cell');
                            selectedCells.add(cellToSelect);
                        }
                    }
                }
            });

            document.addEventListener('mouseup', () => {
                isMouseDown = false;
                startCell = null;
            });
            
            table.addEventListener('mouseleave', () => {
                 document.querySelectorAll('.cell-hover').forEach(c => c.classList.remove('cell-hover'));
            });

            // Listen for messages from parent window
            window.addEventListener('message', (event) => {
                 if (!event.data) return;

                switch (event.data.type) {
                    case 'resetCellStates':
                        clearAllHighlights();
                        break;
                    case 'cellAction':
                        handleCellAction(event.data.payload);
                        break;
                }
            });

            function handleCellAction(payload) {
                const { action, value } = payload;
                if (selectedCells.size === 0) return;

                selectedCells.forEach(cell => {
                    switch(action) {
                        case 'toggle-unbold-th':
                            if (cell.tagName === 'TH') {
                                cell.classList.toggle('fnt-nrml');
                            }
                            break;
                        case 'toggle-bold-td':
                            if (cell.tagName === 'TD') {
                                const strong = cell.querySelector('strong');
                                if (strong && strong.parentElement === cell) {
                                    while(strong.firstChild) {
                                        strong.parentNode.insertBefore(strong.firstChild, strong);
                                    }
                                    strong.remove();
                                } else {
                                    const strongEl = document.createElement('strong');
                                    while(cell.firstChild) {
                                        strongEl.appendChild(cell.firstChild);
                                    }
                                    cell.appendChild(strongEl);
                                }
                            }
                            break;
                        case 'set-alignment':
                            cell.classList.remove('text-left', 'text-center', 'text-right');
                            if (value !== 'none') {
                                cell.classList.add('text-' + value);
                            }
                            break;
                        case 'set-margin':
                            const existingMarginDiv = cell.querySelector('div[class*="mrgn-lft-"]');
                            if (existingMarginDiv) {
                                while(existingMarginDiv.firstChild) {
                                    cell.insertBefore(existingMarginDiv.firstChild, existingMarginDiv);
                                }
                                existingMarginDiv.remove();
                            }
                            if (value !== '0') {
                                const marginDiv = document.createElement('div');
                                marginDiv.className = 'mrgn-lft-' + value;
                                while(cell.firstChild) {
                                    marginDiv.appendChild(cell.firstChild);
                                }
                                cell.appendChild(marginDiv);
                            }
                            break;
                        case 'add-custom-class':
                            if (value) cell.classList.add(value);
                            break;
                        case 'remove-custom-class':
                            if (value) cell.classList.remove(value);
                            break;
                    }
                });

                if (table) {
                    clearTimeout(window.updateParentTimeout);
                    window.updateParentTimeout = setTimeout(() => {
                        const tableClone = table.cloneNode(true);
                        tableClone.querySelectorAll('.highlighted-cell').forEach(c => c.classList.remove('highlighted-cell'));
                        window.parent.postMessage({ type: 'updateTableContent', tableHtml: tableClone.outerHTML }, '*');
                    }, 100);
                }
            }
        });
    <\/script>
</body>
</html>`;
        customizePreviewIframe.srcdoc = baseHtml;
    }


    /**
     * Formats a specific HTML table in the editor based on options from the customize modal.
     */
    async function formatSpecificTable() {
        pushUndoState(); // Save state before action
        closeCustomizeModal(); // Close the customize modal

        const selectedValue = tableSearchDropdown.value;
        if (!selectedValue) {
            showMessage('No table selected for customization.', 'info');
            return;
        }

        const tableInfo = tableDataMap.get(selectedValue);
        if (!tableInfo || tableInfo.startIndex === -1) {
            showMessage('Selected table not found in editor content.', 'error');
            return;
        }

        const currentEditorContent = getEditorContent();

        // Perform the formatting on a *copy* of the table HTML
        const formattedTableOuterHTML = generatePreviewTableHtml(); // Re-use logic for consistency

        // Replace the original table's content in the full editor content
        const newEditorContent = currentEditorContent.substring(0, tableInfo.startIndex) +
                                 formattedTableOuterHTML +
                                 currentEditorContent.substring(tableInfo.startIndex + tableInfo.length);

        setEditorContent(newEditorContent);
        applyEntityHighlighting();
        populateTableSearchDropdown(); // Re-populate dropdown as content/IDs might have changed

        // Temporarily disable buttons and show feedback
        const originalHtml = formatSpecificTableButton.innerHTML;
        formatSpecificTableButton.innerHTML = 'Formatting...';
        formatSpecificTableButton.classList.add('bg-green-500', 'hover:bg-green-600');
        formatSpecificTableButton.classList.remove('bg-blue-700', 'hover:bg-blue-800');
        formatSpecificTableButton.setAttribute('data-temp-active', 'true');
        updateAllInteractiveButtonStates();

        setTimeout(() => {
            formatSpecificTableButton.innerHTML = originalHtml;
            formatSpecificTableButton.classList.remove('bg-green-500', 'hover:bg-green-600');
            formatSpecificTableButton.classList.add('bg-blue-700', 'hover:bg-blue-800');
            formatSpecificTableButton.removeAttribute('data-temp-active');
            updateAllInteractiveButtonStates();
            showMessage('Selected table customized successfully!', 'success'); // Show success message
        }, 1500);
    }

    /**
     * Resets universal formatting for all tables in the editor.
     */
    function resetUniversalFormatting() {
        pushUndoState(); // Save state before action
        if (!monacoEditor) { showMessage('Editor is not ready.', 'info'); return; }

        const editorContent = getEditorContent();
        if (!editorContent.trim()) { showMessage('Nothing to reset.', 'info'); return; }

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = editorContent;

        const tables = tempDiv.querySelectorAll('table');
        if (tables.length === 0) {
            showMessage('No tables found to reset.', 'info');
            return;
        }

        // *** FIX: Define all classes that this tool's formatting functions might add. ***
        const managedClasses = [
            'table', 'table-bordered', 'table-striped', 'table-hover', 'table-condensed',
            'small', 'active', 'text-left', 'text-center', 'text-right', 'nowrap', 'wb-inv'
        ];

        tables.forEach(table => {
            // Iterate over the table itself and all its descendants
            [table, ...table.querySelectorAll('*')].forEach(el => {
                // Remove only the managed classes, preserving custom ones
                el.classList.remove(...managedClasses);
            });
            // Also remove the table's ID
            table.removeAttribute('id');
        });
        
        // Clean up any empty class attributes left behind
        tempDiv.querySelectorAll('*').forEach(el => {
            if (el.hasAttribute('class') && el.classList.length === 0) {
                el.removeAttribute('class');
            }
        });

        let finalHtml = tempDiv.innerHTML;
        finalHtml = html_beautify(finalHtml, { indent_size: 4, space_in_paren: true, preserve_newlines: false, extra_liners: [] });
        setEditorContent(finalHtml);
        applyEntityHighlighting();
        populateTableSearchDropdown();
        showMessage('Universal formatting has been reset.', 'success');
    }

    /**
     * Resets responsive wrappers from all tables.
     */
    function resetResponsiveWrappers() {
        pushUndoState(); // Save state before action
        if (!monacoEditor) { showMessage('Editor is not ready.', 'info'); return; }
        const editorContent = getEditorContent();
        if (!editorContent.trim()) { showMessage('Nothing to reset.', 'info'); return; }

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = editorContent;

        const responsiveDivs = tempDiv.querySelectorAll('div.table-responsive');
        if (responsiveDivs.length === 0) {
            showMessage('No responsive wrappers found to remove.', 'info');
            return;
        }

        responsiveDivs.forEach(div => {
            // Move all children of the div out, right before the div
            while (div.firstChild) {
                div.parentNode.insertBefore(div.firstChild, div);
            }
            // Remove the now-empty div
            div.parentNode.removeChild(div);
        });

        let finalHtml = tempDiv.innerHTML;
        finalHtml = html_beautify(finalHtml, { indent_size: 4, space_in_paren: true, preserve_newlines: false, extra_liners: [] });
        setEditorContent(finalHtml);
        applyEntityHighlighting();
        populateTableSearchDropdown();
        showMessage('Responsive wrappers have been removed.', 'success');
    }

    /**
     * Resets all scopes and IDs from all tables.
     */
    function resetAllScopesAndIDs() {
        pushUndoState(); // Save state before action
        if (!monacoEditor) { showMessage('Editor is not ready.', 'info'); return; }
        const editorContent = getEditorContent();
        if (!editorContent.trim()) { showMessage('Nothing to reset.', 'info'); return; }

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = editorContent;

        const cells = tempDiv.querySelectorAll('table th, table td');
        if (cells.length === 0) {
            showMessage('No table cells found to reset.', 'info');
            return;
        }

        cells.forEach(cell => {
            cell.removeAttribute('scope');
            cell.removeAttribute('id');
            cell.removeAttribute('headers');
        });

        let finalHtml = tempDiv.innerHTML;
        finalHtml = html_beautify(finalHtml, { indent_size: 4, space_in_paren: true, preserve_newlines: false, extra_liners: [] });
        setEditorContent(finalHtml);
        applyEntityHighlighting();
        populateTableSearchDropdown();
        showMessage('All scopes, IDs, and headers have been reset.', 'success');
    }

    /**
     * Resets formatting for a single, selected table.
     */
    function resetTableFormatting() {
        pushUndoState(); // Save state before action
        const selectedValue = tableSearchDropdown.value;
        if (!selectedValue) {
            showMessage('Please select a table to reset.', 'info');
            return;
        }
        const tableInfo = tableDataMap.get(selectedValue);
        if (!tableInfo) { return; }

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = tableInfo.outerHTML;
        const table = tempDiv.querySelector('table');

        // *** FIX: Define all classes that this tool's formatting functions might add. ***
        const managedClasses = [
            'table', 'table-bordered', 'table-striped', 'table-hover', 'table-condensed',
            'small', 'active', 'text-left', 'text-center', 'text-right', 'nowrap', 'wb-inv'
        ];

        // *** FIX: Iterate over the table itself and all its descendants ***
        [table, ...table.querySelectorAll('*')].forEach(el => {
            // Remove only the managed classes, preserving custom ones
            el.classList.remove(...managedClasses);
        });
        table.removeAttribute('id');

        // *** FIX: Clean up empty class attributes after removal ***
        [table, ...table.querySelectorAll('*')].forEach(el => {
             if (el.hasAttribute('class') && el.classList.length === 0) {
                el.removeAttribute('class');
            }
        });


        let modifiedTableHtml = tempDiv.innerHTML;
        modifiedTableHtml = html_beautify(modifiedTableHtml, { indent_size: 4, space_in_paren: true, preserve_newlines: false, extra_liners: [] });

        const currentEditorContent = getEditorContent();
        const newEditorContent = currentEditorContent.substring(0, tableInfo.startIndex) +
                                 modifiedTableHtml +
                                 currentEditorContent.substring(tableInfo.startIndex + tableInfo.length);
        
        setEditorContent(newEditorContent);
        applyEntityHighlighting();
        populateTableSearchDropdown();
        showMessage(`Formatting for table "${selectedValue}" has been reset.`, 'success');
    }

    /**
     * Resets scopes and IDs for a single, selected table.
     */
    function resetTableScopeAndID() {
        pushUndoState(); // Save state before action
         const selectedValue = tableSearchDropdown.value;
        if (!selectedValue) {
            showMessage('Please select a table to reset.', 'info');
            return;
        }
        const tableInfo = tableDataMap.get(selectedValue);
        if (!tableInfo) { return; }

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = tableInfo.outerHTML;
        const table = tempDiv.querySelector('table');

        table.querySelectorAll('th, td').forEach(cell => {
            cell.removeAttribute('scope');
            cell.removeAttribute('id');
            cell.removeAttribute('headers');
        });

        let modifiedTableHtml = tempDiv.innerHTML;
        modifiedTableHtml = html_beautify(modifiedTableHtml, { indent_size: 4, space_in_paren: true, preserve_newlines: false, extra_liners: [] });

        const currentEditorContent = getEditorContent();
        const newEditorContent = currentEditorContent.substring(0, tableInfo.startIndex) +
                                 modifiedTableHtml +
                                 currentEditorContent.substring(tableInfo.startIndex + tableInfo.length);
        
        setEditorContent(newEditorContent);
        applyEntityHighlighting();
        populateTableSearchDropdown();
        showMessage(`Scopes and IDs for table "${table.id || selectedValue}" have been reset.`, 'success');
    }

    /**
     * Applies unique IDs to all tables in the editor.
     */
    function autoTableIDs() {
        pushUndoState(); // Save state before action
        if (!monacoEditor) { showMessage('Editor is not ready.', 'info'); return; }
        const editorContent = getEditorContent();
        if (!editorContent.trim()) { showMessage('No content to add IDs to.', 'info'); return; }

        const originalHtml = autoTableIDBtn.innerHTML;
        autoTableIDBtn.innerHTML = 'IDing...';
        autoTableIDBtn.setAttribute('data-temp-active', 'true');
        updateAllInteractiveButtonStates();

        try {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = editorContent;

            const tables = tempDiv.querySelectorAll('table');
            if (tables.length === 0) {
                showMessage('No tables found to ID.', 'info');
                return; // finally block will still run
            }

            let tblCounter = 1;
            let ftblCounter = 1;

            tables.forEach(table => {
                if (table.closest('figure')) {
                    table.id = `ftbl${ftblCounter++}`;
                } else {
                    table.id = `tbl${tblCounter++}`;
                }
            });

            let finalHtml = tempDiv.innerHTML;
            finalHtml = html_beautify(finalHtml, { indent_size: 4, space_in_paren: true, preserve_newlines: false, extra_liners: [] });
            // MODIFICATION: Run auto-encode
            finalHtml = convertAllEntitiesToNumeric(finalHtml);
            setEditorContent(finalHtml);
            applyEntityHighlighting();
            populateTableSearchDropdown();
            showMessage('Table IDs have been automatically assigned.', 'success');
        } catch (e) {
            console.error("Error assigning table IDs:", e);
            showMessage('An error occurred while assigning IDs.', 'error');
        } finally {
            setTimeout(() => {
                autoTableIDBtn.innerHTML = originalHtml;
                autoTableIDBtn.removeAttribute('data-temp-active');
                updateAllInteractiveButtonStates();
            }, 1500);
        }
    }

    /**
     * Formats a string containing numbers to a specific language format.
     * @param {string} text - The string to format.
     * @param {string} lang - The target language ('eng' or 'fra').
     * @returns {string} The formatted string.
     */
    function formatNumberString(text, lang) {
        const regex = /([+\-]?)\s*([\$€]?)\s*([\d][\d\s,.'&#160;&nbsp;]*)\s*([\$€%]?)/g;

        return text.replace(regex, (match, sign, preSymbol, numberStr, postSymbol) => {
            if (!/\d/.test(numberStr)) return match;

            // Heuristic to ignore version numbers, IP addresses, or codes.
            if ((numberStr.match(/\./g) || []).length > 1 && (numberStr.match(/,/g) || []).length === 0) {
                return match;
            }

            let parsableStr = numberStr
                .replace(/&nbsp;/g, ' ')
                .replace(/&#160;/g, ' ')
                .trim();

            const hasComma = parsableStr.includes(',');
            const hasPeriod = parsableStr.includes('.');

            if (hasComma && hasPeriod) {
                // Both comma and period present. Determine decimal.
                // If comma appears after period, it's European style (1.234,56)
                if (parsableStr.indexOf(',') > parsableStr.indexOf('.')) {
                    parsableStr = parsableStr.replace(/\./g, '').replace(',', '.');
                } else {
                    // If period appears after comma, it's American style (1,234.56)
                    parsableStr = parsableStr.replace(/,/g, '');
                }
            } else if (hasComma) {
                // Only commas present. Heuristic: if last part is 1 or 2 digits, assume decimal.
                const parts = parsableStr.split(',');
                const lastPart = parts[parts.length - 1];
                if (lastPart.length === 1 || lastPart.length === 2) {
                    parsableStr = parsableStr.replace(/,/g, (m, offset, str) => {
                        if (offset === str.lastIndexOf(',')) return '.';
                        return '';
                    });
                } else {
                    // Otherwise, assume all commas are thousands separators.
                    parsableStr = parsableStr.replace(/,/g, '');
                }
            } else if (hasPeriod) {
                // Only periods present. Heuristic: if last part is 3 digits, assume thousands.
                const parts = parsableStr.split('.');
                const lastPart = parts[parts.length - 1];
                if (lastPart.length === 3 && parts.length > 1) {
                    parsableStr = parsableStr.replace(/\./g, '');
                }
                // Otherwise, assume it's a decimal separator, keep it as is.
            }
            parsableStr = parsableStr.replace(/\s/g, ''); // Remove any remaining spaces


            const num = parseFloat(parsableStr);
            if (isNaN(num)) {
                return match;
            }

            const symbol = preSymbol || postSymbol;
            const originalDecimalPartLength = (parsableStr.split('.')[1] || '').length;

            // Determine formatting options
            // For financial numbers, typically 2 decimal places are preferred.
            // But if the original number had more, we should preserve that.
            let minFractions = 0;
            let maxFractions = 0;

            if (num % 1 === 0) { // If it's an integer
                minFractions = 0;
                maxFractions = 0; // No decimals for integers unless specified by context
            } else { // If it has decimal places
                minFractions = originalDecimalPartLength;
                // Ensure at least 2 decimal places for financial numbers, but keep original if more
                maxFractions = Math.max(2, originalDecimalPartLength);
            }

            // 2. Format to the target locale
            if (lang === 'eng') {
                let formattedNum = num.toLocaleString('en-CA', {
                    minimumFractionDigits: minFractions,
                    maximumFractionDigits: maxFractions
                });

                // Specific check for integers to avoid '.00' if original had no decimals
                // `toLocaleString` handles thousands separators automatically based on locale.
                if (num % 1 === 0 && originalDecimalPartLength === 0) {
                     formattedNum = num.toLocaleString('en-CA', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    });
                }

                if (symbol === '$' || symbol === '€') return `${sign}${symbol}${formattedNum}`;
                if (symbol === '%') return `${sign}${formattedNum}${symbol}`;
                return `${sign}${formattedNum}`;
            } else if (lang === 'fra') {
                let formattedNum = num.toLocaleString('fr-CA', {
                    minimumFractionDigits: minFractions,
                    maximumFractionDigits: maxFractions
                });

                formattedNum = formattedNum.replace(/\u00A0/g, ' '); // Convert system NBSP to normal space temporarily
                formattedNum = formattedNum.replace(/ /g, '\u00A0'); // Replace normal spaces with NBSP for thousands
                formattedNum = formattedNum.replace(/,/g, ','); // Ensure decimal comma is preserved

                // Specific check for integers to avoid ',00' if original had no decimals
                if (num % 1 === 0 && originalDecimalPartLength === 0) {
                    formattedNum = num.toLocaleString('fr-CA', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    });
                    // Re-apply NBSP if the integer formatting removed them
                    formattedNum = formattedNum.replace(/\u00A0/g, ' ');
                    formattedNum = formattedNum.replace(/ /g, '\u00A0');
                }


                if (symbol === '$' || symbol === '€' || symbol === '%') {
                    return `${sign}${formattedNum}\u00A0${symbol}`;
                }
                return `${sign}${formattedNum}`;
            }
            return match;
        });
    }

    /**
     * Main function to trigger number formatting across all tables.
     * @param {string} lang - The target language ('eng' or 'fra').
     */
    function formatTableNumbers(lang) {
        pushUndoState(); // Save state before action
        if (!monacoEditor) {
            showMessage('Editor is not ready.', 'info');
            return;
        }
        const editorContent = getEditorContent();
        if (!editorContent.trim()) {
            showMessage('No content to format.', 'info');
            return;
        }

        const btn = lang === 'eng' ? document.getElementById('eng-number-button') : document.getElementById('fra-number-button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = 'Formatting...';
        btn.setAttribute('data-temp-active', 'true');
        updateAllInteractiveButtonStates();

        try {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = editorContent;

            const cells = tempDiv.querySelectorAll('table td, table th');

            cells.forEach(cell => {
                const walker = document.createTreeWalker(cell, NodeFilter.SHOW_TEXT, null, false);
                const nodesToProcess = [];
                let node;
                while (node = walker.nextNode()) {
                    nodesToProcess.push(node);
                }

                nodesToProcess.forEach(textNode => {
                    const formattedText = formatNumberString(textNode.nodeValue, lang);
                    textNode.nodeValue = formattedText;
                });
            });

            let finalHtml = tempDiv.innerHTML;
            
            // After DOM manipulation, replace literal non-breaking spaces with the desired entity for editor consistency.
            finalHtml = finalHtml.replace(/\u00A0/g, '&#160;');
            
            // Run auto-encode logic
            finalHtml = convertAllEntitiesToNumeric(finalHtml);

            finalHtml = html_beautify(finalHtml, { indent_size: 4, space_in_paren: true, preserve_newlines: false, extra_liners: [] });
            setEditorContent(finalHtml);
            applyEntityHighlighting();
            populateTableSearchDropdown();
            showMessage(`Numbers formatted for ${lang === 'eng' ? 'English' : 'French'}.`, 'success');

        } catch (e) {
            console.error(`Error formatting numbers for ${lang}:`, e);
            showMessage('An error occurred during number formatting.', 'error');
        } finally {
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.removeAttribute('data-temp-active');
                updateAllInteractiveButtonStates();
            }, 1500);
        }
    }


    // DOM element references (moved after functions to ensure they are available)
    const formatButton = document.getElementById('format-button-modal');
    const autoScopeBtn = document.getElementById('auto-scope-btn');
    const openOptionsModalButton = document.getElementById('open-options-modal-btn');
    const optionsModalOverlay = document.getElementById('options-modal-overlay');
    const closeOptionsModalButton = document.getElementById('close-options-modal-btn');

    // Universal Format Modal controls
    const idCheckbox = document.getElementById('id-checkbox');
    const pageIdPrefixInput = document.getElementById('page-id-prefix-input');
    const figureDataIdPrefixInput = document.getElementById('figure-data-id-prefix-input');
    const classTablesCheckbox = document.getElementById('class-tables-checkbox');
    const captionCheckbox = document.getElementById('caption-checkbox');
    const autoCaptionCheckbox = document.getElementById('auto-caption-checkbox');
    const invCaptionCheckbox = document.getElementById('inv-caption-checkbox');
    const fixEmptyCellsCheckbox = document.getElementById('fix-empty-cells-checkbox');
    const removePTagsCheckbox = document.getElementById('remove-p-tags-checkbox');
    const makeTfootFromColspanCheckbox = document.getElementById('make-tfoot-from-colspan-checkbox');
    const makeTfootBeforeTbodyCheckbox = document.getElementById('make-tfoot-before-tbody-checkbox');
    const addSmallToTrCheckbox = document.getElementById('add-small-to-tr-checkbox');
    const headerCheckbox = document.getElementById('header-checkbox');
    const rowHeaderCheckbox = document.getElementById('row-header-checkbox');

    const borderedCheckbox = document.getElementById('bordered-checkbox');
    const stripedCheckbox = document.getElementById('striped-checkbox');
    const hoverCheckbox = document.getElementById('hover-checkbox');
    const activeColHeadersCheckbox = document.getElementById('active-col-headers-checkbox');
    const activeColspanHeadersCheckbox = document.getElementById('active-colspan-headers-checkbox');
    const activeRowHeadersCheckbox = document.getElementById('active-row-headers-checkbox');
    const classSmallCheckboxElement = document.getElementById('class-small-checkbox');

    const financeTableCheckbox = document.getElementById('finance-table-checkbox');
    const boldTotalsCheckbox = document.getElementById('bold-totals-checkbox');

    const messageBox = document.getElementById('message-box');

    // New button references for integrated features
    const clearAllBtn = document.getElementById('clearAllBtn');
    const autoEncodeBtn = document.getElementById('autoEncodeBtn');
    const autoFormatBtn = document.getElementById('autoFormatBtn');
    const copyCodeBtn = document.getElementById('copyCodeBtn');
    const importHtmlBtn = document.getElementById('importHtmlBtn');
    const exportHtmlBtn = document.getElementById('exportHtmlBtn');
    const htmlFileInput = document.getElementById('htmlFileInput');
    const autoResponsiveBtn = document.getElementById('auto-responsive-btn');
    const autoTableIDBtn = document.getElementById('autoTableIDBtn');
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');
    const engNumberButton = document.getElementById('eng-number-button');
    const fraNumberButton = document.getElementById('fra-number-button');

    // New dropdown for table search and customize button
    const tableSearchDropdown = document.getElementById('table-search-dropdown');
    const customizeButton = document.getElementById('customize-button');
    const forceScopeButton = document.getElementById('force-scope-button');
    const forceIdButton = document.getElementById('force-id-button');
    const resetUniversalBtn = document.getElementById('reset-universal-btn');
    const resetResponsiveBtn = document.getElementById('reset-responsive-btn');
    const resetScopeIdBtn = document.getElementById('reset-scopeid-btn');
    const resetTableFormatBtn = document.getElementById('reset-tableformat-btn');
    const resetTableScopeIDBtn = document.getElementById('reset-tablescopeid-btn');

    // Customize Table Modal elements
    const customizeModalOverlay = document.getElementById('customize-modal-overlay');
    const closeCustomizeModalButton = document.getElementById('close-customize-modal-btn');
    const formatSpecificTableButton = document.getElementById('format-specific-table-button');
    const customizePreviewIframe = document.getElementById('customize-preview-iframe');

    // Customize Modal controls (all prefixed with customize-)
    const customizePageIdPrefixInput = document.getElementById('customize-page-id-prefix-input'); // Renamed to Custom ID
    const customizeMakeTfootFromColspanCheckbox = document.getElementById('customize-make-tfoot-from-colspan-checkbox');
    const customizeMakeTfootBeforeTbodyCheckbox = document.getElementById('customize-make-tfoot-before-tbody-checkbox');
    const customizeCaptionCheckbox = document.getElementById('customize-caption-checkbox');
    const customizeInvCaptionCheckbox = document.getElementById('customize-inv-caption-checkbox');
    const customizeFixEmptyCellsCheckbox = document.getElementById('customize-fix-empty-cells-checkbox');
    const customizeRemovePTagsCheckbox = document.getElementById('customize-remove-p-tags-checkbox');
    const customizeClassSmallCheckboxElement = document.getElementById('customize-class-small-checkbox');
    const customizeAddSmallToTrCheckbox = document.getElementById('customize-add-small-to-tr-checkbox');
    const customizeClassTablesCheckbox = document.getElementById('customize-class-tables-checkbox');
    const customizeHeaderCheckbox = document.getElementById('customize-header-checkbox');
    const customizeRowHeaderCheckbox = document.getElementById('customize-row-header-checkbox');
    const customizeBorderedCheckbox = document.getElementById('customize-bordered-checkbox');
    const customizeStripedCheckbox = document.getElementById('customize-striped-checkbox');
    const customizeHoverCheckbox = document.getElementById('customize-hover-checkbox');
    const customizeActiveColHeadersCheckbox = document.getElementById('customize-active-col-headers-checkbox');
    const customizeActiveColspanHeadersCheckbox = document.getElementById('customize-active-colspan-headers-checkbox');
    const customizeActiveRowHeadersCheckbox = document.getElementById('customize-active-row-headers-checkbox');
    const customizeFinanceTableCheckbox = document.getElementById('customize-finance-table-checkbox');
    const customizeBoldTotalsCheckbox = document.getElementById('customize-bold-totals-checkbox');


    // Populate allInteractiveButtons array after all button elements are defined
    allInteractiveButtons.push(
        formatButton,
        openOptionsModalButton,
        clearAllBtn,
        autoEncodeBtn,
        autoFormatBtn,
        copyCodeBtn,
        importHtmlBtn,
        exportHtmlBtn,
        customizeButton,
        formatSpecificTableButton,
        autoScopeBtn,       
        forceScopeButton,     
        forceIdButton,
        autoResponsiveBtn,
        autoTableIDBtn,
        resetUniversalBtn,
        resetResponsiveBtn,
        resetScopeIdBtn,
        resetTableFormatBtn,
        resetTableScopeIDBtn,
        undoBtn,
        redoBtn,
        engNumberButton,
        fraNumberButton
    );

    // Event listeners for modals
    openOptionsModalButton.addEventListener('click', openOptionsModal);
    closeOptionsModalButton.addEventListener('click', closeOptionsModal);
    formatButton.addEventListener('click', formatHtmlTables); // Universal Format button
    
    if (autoResponsiveBtn) {
        autoResponsiveBtn.addEventListener('click', () => {
            pushUndoState(); // Save state before action
            if (!monacoEditor) { showMessage('Editor is still loading.', 'info'); return; }

            // Temporarily disable buttons and show feedback
            const originalHtml = autoResponsiveBtn.innerHTML;
            autoResponsiveBtn.innerHTML = 'Applying...';
            autoResponsiveBtn.setAttribute('data-temp-active', 'true');
            updateAllInteractiveButtonStates();

            try {
                const editorContent = getEditorContent();
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = editorContent;
                
                const tables = tempDiv.querySelectorAll('table');
                if (tables.length === 0) {
                    showMessage('No tables found to apply responsive wrappers.', 'info');
                    // Use finally block to reset button state
                    return;
                }

                let wrappedCount = 0;

                tables.forEach(table => {
                    const parent = table.parentElement;
                    // Check if parent is NOT a responsive div
                    if (!parent || !parent.classList.contains('table-responsive')) {
                        // It's not wrapped, so wrap it
                        const responsiveDiv = document.createElement('div');
                        responsiveDiv.className = 'table-responsive';
                        if (table.parentNode) {
                            table.parentNode.insertBefore(responsiveDiv, table);
                            responsiveDiv.appendChild(table);
                            wrappedCount++;
                        }
                    }
                });

                let finalHtml = tempDiv.innerHTML;
                finalHtml = html_beautify(finalHtml, { indent_size: 4, space_in_paren: true, preserve_newlines: false, extra_liners: [] });
                // MODIFICATION: Run auto-encode
                finalHtml = convertAllEntitiesToNumeric(finalHtml);
                setEditorContent(finalHtml);
                applyEntityHighlighting();
                populateTableSearchDropdown();

                showMessage(`${wrappedCount} responsive wrappers added.`, 'success');

            } catch (e) {
                console.error("Error applying responsive wrappers:", e);
                showMessage('An error occurred. Check console for details.', 'error');
            } finally {
                setTimeout(() => {
                    autoResponsiveBtn.innerHTML = originalHtml;
                    autoResponsiveBtn.removeAttribute('data-temp-active');
                    updateAllInteractiveButtonStates();
                }, 1500);
            }
        });
    }
    
    if (autoScopeBtn) {
        autoScopeBtn.addEventListener('click', () => {
            pushUndoState(); // Save state before action
            // Temporarily disable buttons and show feedback
            const originalHtml = autoScopeBtn.innerHTML;
            autoScopeBtn.innerHTML = 'Scoping...';
            autoScopeBtn.setAttribute('data-temp-active', 'true'); // Set temp active
            updateAllInteractiveButtonStates(); // Update states for ALL buttons

            const editorContent = monacoEditor.getValue();
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = editorContent;
            const allTables = tempDiv.querySelectorAll('table');

            if (allTables.length === 0) {
                // ... (no tables found handling) ...
                return;
            }

            allTables.forEach((table, index) => {
                autoScopeTableIDs(table, index);
            });

            let finalFormattedHtml = tempDiv.innerHTML;
            finalFormattedHtml = cleanEmptyHeadersAttribute(finalFormattedHtml);
            // MODIFICATION: Run auto-encode
            finalFormattedHtml = convertAllEntitiesToNumeric(finalFormattedHtml);

            monacoEditor.setValue(finalFormattedHtml);
            applyEntityHighlighting();
            populateTableSearchDropdown();

            // Re-enable and revert specific button state after operation
            setTimeout(() => {
                autoScopeBtn.innerHTML = originalHtml;
                autoScopeBtn.removeAttribute('data-temp-active'); // Remove temp active
                updateAllInteractiveButtonStates(); // Update states for ALL buttons
                showMessage('Auto-scoping complete!', 'success');
            }, 1500);
        });
    }

    if (forceScopeButton) {
        forceScopeButton.addEventListener('click', () => {
            pushUndoState(); // Save state before action
            const selectedValue = tableSearchDropdown.value;
            if (!selectedValue) {
                showMessage('Please select a table to force scope.', 'info');
                return;
            }

            // ... (temp-active and other button state management) ...

            try {
                const tableInfo = tableDataMap.get(selectedValue);
                if (!tableInfo || tableInfo.startIndex === -1) {
                    showMessage('Selected table not found in editor content.', 'error');
                    return;
                }

                const currentEditorContent = monacoEditor.getValue();
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = tableInfo.outerHTML;
                const tableToProcess = tempDiv.querySelector('table');

                autoScopeTableIDs(tableToProcess, 0, 'simple');

                const modifiedTableHtml = tableToProcess.outerHTML;

                // CHANGE 'const' to 'let' here
                let newEditorContent = currentEditorContent.substring(0, tableInfo.startIndex) +
                                       modifiedTableHtml +
                                       currentEditorContent.substring(tableInfo.startIndex + tableInfo.length);

                newEditorContent = cleanEmptyHeadersAttribute(newEditorContent); // Reassignment happens here
                // MODIFICATION: Run auto-encode
                newEditorContent = convertAllEntitiesToNumeric(newEditorContent);

                monacoEditor.setValue(newEditorContent);
                applyEntityHighlighting();
                populateTableSearchDropdown();

                showMessage('Force Scope applied successfully!', 'success');

            } catch (e) {
                console.error("Error forcing scope:", e);
                showMessage('An error occurred during force scope. Check console.', 'error');
            } finally {
                // Re-enable and revert button state after operation
                forceScopeButton.textContent = 'Force Scope';
                forceScopeButton.classList.remove('bg-green-500', 'hover:bg-green-600');
                forceScopeButton.classList.add('bg-green-700', 'hover:bg-green-600');
                forceScopeButton.removeAttribute('data-temp-active');
                updateAllInteractiveButtonStates(); // Re-enable other buttons
            }
        });
    }


    // Event listener for Force ID/Headers button
    if (forceIdButton) {
        forceIdButton.addEventListener('click', () => {
            pushUndoState(); // Save state before action
            const selectedValue = tableSearchDropdown.value;
            if (!selectedValue) {
                showMessage('Please select a table to force ID/Headers.', 'info');
                return;
            }

            // ... (temp-active and other button state management) ...

            try {
                const tableInfo = tableDataMap.get(selectedValue);
                if (!tableInfo || tableInfo.startIndex === -1) {
                    showMessage('Selected table not found in editor content.', 'error');
                    return;
                }

                const currentEditorContent = monacoEditor.getValue();
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = tableInfo.outerHTML;
                const tableToProcess = tempDiv.querySelector('table');

                autoScopeTableIDs(tableToProcess, 0, 'complex');

                const modifiedTableHtml = tableToProcess.outerHTML;

                // CHANGE 'const' to 'let' here
                let newEditorContent = currentEditorContent.substring(0, tableInfo.startIndex) +
                                       modifiedTableHtml +
                                       currentEditorContent.substring(tableInfo.startIndex + tableInfo.length);

                newEditorContent = cleanEmptyHeadersAttribute(newEditorContent); // Reassignment happens here
                // MODIFICATION: Run auto-encode
                newEditorContent = convertAllEntitiesToNumeric(newEditorContent);

                monacoEditor.setValue(newEditorContent);
                applyEntityHighlighting();
                populateTableSearchDropdown();

                showMessage('Force ID/Headers applied successfully!', 'success');

            } catch (e) {
                console.error("Error forcing ID/Headers:", e); // This is the line reported by user (3189:23 for them)
                showMessage('An error occurred during force ID/Headers. Check console for details.', 'error');
            } finally {
                // Re-enable and revert button state after operation
                forceIdButton.textContent = 'Force ID/Headers';
                forceIdButton.classList.remove('bg-green-500', 'hover:bg-green-600');
                forceIdButton.classList.add('bg-green-700', 'hover:bg-green-600');
                forceIdButton.removeAttribute('data-temp-active');
                updateAllInteractiveButtonStates(); // Re-enable other buttons
            }
        });
    }

    // NEW: Event listeners for reset buttons
    resetUniversalBtn.addEventListener('click', resetUniversalFormatting);
    resetResponsiveBtn.addEventListener('click', resetResponsiveWrappers);
    resetScopeIdBtn.addEventListener('click', resetAllScopesAndIDs);
    resetTableFormatBtn.addEventListener('click', resetTableFormatting);
    resetTableScopeIDBtn.addEventListener('click', resetTableScopeAndID);
    autoTableIDBtn.addEventListener('click', autoTableIDs);

    // NEW: Event listeners for number formatting buttons
    engNumberButton.addEventListener('click', () => formatTableNumbers('eng'));
    fraNumberButton.addEventListener('click', () => formatTableNumbers('fra'));


    customizeButton.addEventListener('click', () => {
        if (!tableSearchDropdown.value) {
            showMessage('Please select a table from the dropdown first.', 'info');
            return;
        }
        customizeModalOverlay.classList.remove('hidden'); 
        tableSearchDropdown.dispatchEvent(new Event('change'));
    });
    closeCustomizeModalButton.addEventListener('click', closeCustomizeModal);
    formatSpecificTableButton.addEventListener('click', formatSpecificTable); // Specific Table Format button


    // Setup all new alignment button groups for UNIVERSAL modal
    setupButtonGroup('caption-alignment-group', 'captionAlignment');
    setupButtonGroup('col-headers-alignment-group', 'colHeaderAlignment');
    setupButtonGroup('row-headers-alignment-group', 'rowHeaderAlignment');
    setupButtonGroup('colspan-headers-alignment-group', 'colspanHeaderAlignment');
    setupButtonGroup('data-cells-alignment-group', 'dataCellsAlignment');

    // Setup all new alignment button groups for CUSTOMIZE modal, with preview update callback
    setupButtonGroup('customize-caption-alignment-group', 'customizeCaptionAlignment', customizeModalOverlay, updateCustomizeModalPreview);
    setupButtonGroup('customize-col-headers-alignment-group', 'customizeColHeaderAlignment', customizeModalOverlay, updateCustomizeModalPreview);
    setupButtonGroup('customize-row-headers-alignment-group', 'customizeRowHeaderAlignment', customizeModalOverlay, updateCustomizeModalPreview);
    setupButtonGroup('customize-colspan-headers-alignment-group', 'customizeColspanHeaderAlignment', customizeModalOverlay, updateCustomizeModalPreview);
    setupButtonGroup('customize-data-cells-alignment-group', 'customizeDataCellsAlignment', customizeModalOverlay, updateCustomizeModalPreview);

    
    // Mutual exclusivity logic for Finance Table checkbox and Alignment button groups
    if (financeTableCheckbox) {
         financeTableCheckbox.addEventListener('change', function() {
            const parentLabel = this.closest('.toggle-switch');
            parentLabel.classList.toggle('is-checked', this.checked);
        });
    }
    if (customizeFinanceTableCheckbox) {
         customizeFinanceTableCheckbox.addEventListener('change', function() {
            const parentLabel = this.closest('.toggle-switch');
            parentLabel.classList.toggle('is-checked', this.checked);
            updateCustomizeModalPreview(); // Trigger preview update
        });
    }

    

    // Mutual exclusivity logic for Captions (placeholder) and Auto-Caption (Universal Modal)
    captionCheckbox.addEventListener('change', function() {
        const parentLabel = this.closest('.toggle-switch');
        parentLabel.classList.toggle('is-checked', this.checked);
        if (this.checked) {
            autoCaptionCheckbox.checked = false;
            autoCaptionCheckbox.closest('.toggle-switch').classList.remove('is-checked');
        }
    });

    autoCaptionCheckbox.addEventListener('change', function() {
        const parentLabel = this.closest('.toggle-switch');
        parentLabel.classList.toggle('is-checked', this.checked);
        if (this.checked) {
            captionCheckbox.checked = false;
            captionCheckbox.closest('.toggle-switch').classList.remove('is-checked');
        }
    });
    
    // Mutual exclusivity logic for Captions (placeholder) and Auto-Caption (Customize Modal)
    customizeCaptionCheckbox.addEventListener('change', function() {
        const parentLabel = this.closest('.toggle-switch');
        parentLabel.classList.toggle('is-checked', this.checked);
        updateCustomizeModalPreview(); // Ensure preview updates when caption is toggled
    });


    /**
     * Initializes the visual state of toggle switches.
     * This function ONLY applies the 'is-checked' class based on the checkbox's 'checked' property.
     * @param {HTMLElement} [container=document] - The container element to search for toggle switches.
     */
    function initializeToggleSwitchesVisuals(container = document) {
        container.querySelectorAll('.toggle-switch input[type="checkbox"]').forEach(checkbox => {
            const parentLabel = checkbox.closest('.toggle-switch');
            if (checkbox.checked) {
                parentLabel.classList.add('is-checked');
            } else {
                parentLabel.classList.remove('is-checked');
            }
        });
    }


    function openOptionsModalCustomize() {
        const selectedValue = tableSearchDropdown.value;
        const tableInfo = tableDataMap.get(selectedValue);
        let selectedTableElement = null;

        if (tableInfo) {
            const doc = new DOMParser().parseFromString(tableInfo.outerHTML, 'text/html');
            selectedTableElement = doc.querySelector('table');
        }

        customizePageIdPrefixInput.value = selectedTableElement ? selectedTableElement.id : '';

        if (selectedTableElement) {
            const tableClasses = Array.from(selectedTableElement.classList);
            
            customizeMakeTfootFromColspanCheckbox.checked = true; // Default to true, as it's an action
            customizeFixEmptyCellsCheckbox.checked = true; // Default to true, as it's an action
            customizeRemovePTagsCheckbox.checked = false; // Default to false, as it's a destructive action

            customizeCaptionCheckbox.checked = !!selectedTableElement.querySelector('caption');

            customizeClassSmallCheckboxElement.checked = tableClasses.includes('small');
            const allTrs = Array.from(selectedTableElement.querySelectorAll('tr'));
            customizeAddSmallToTrCheckbox.checked = allTrs.length > 0 && allTrs.every(tr => tr.classList.contains('small'));

            customizeClassTablesCheckbox.checked = tableClasses.includes('table') && tableClasses.includes('table-condensed');
            const thead = selectedTableElement.querySelector('thead');
            customizeHeaderCheckbox.checked = thead && thead.querySelector('tr th') !== null;
            const tbody = selectedTableElement.querySelector('tbody');
            customizeRowHeaderCheckbox.checked = tbody && Array.from(tbody.querySelectorAll('tr')).some(row => row.firstElementChild?.tagName.toLowerCase() === 'th');

            customizeBorderedCheckbox.checked = tableClasses.includes('table-bordered');
            customizeStripedCheckbox.checked = tableClasses.includes('table-striped');
            customizeHoverCheckbox.checked = tableClasses.includes('table-hover');
            
            customizeActiveColHeadersCheckbox.checked = thead && Array.from(thead.querySelectorAll('tr')).some(tr => tr.classList.contains('active'));
            customizeActiveColspanHeadersCheckbox.checked = Array.from(selectedTableElement.querySelectorAll('th[colspan]')).some(th => th.classList.contains('active'));
            customizeActiveRowHeadersCheckbox.checked = Array.from(selectedTableElement.querySelectorAll('tbody tr > th:first-child')).some(th => th.classList.contains('active'));
            
            const lastTbodyRow = selectedTableElement.querySelector('tbody > tr:last-child');
            const lastRowIsTotal = lastTbodyRow && lastTbodyRow.querySelector('th')?.textContent.toLowerCase().includes('total');
            customizeBoldTotalsCheckbox.checked = lastRowIsTotal && Array.from(lastTbodyRow.querySelectorAll('td')).some(td => td.querySelector('strong'));

            customizeFinanceTableCheckbox.checked = Array.from(selectedTableElement.querySelectorAll('td')).some(td => td.classList.contains('nowrap'));
            
            const setAlignmentButtonState = (groupId, element, defaultAlign) => {
                let inferredAlignment = defaultAlign;
                if (element) {
                    if (element.classList.contains('text-left')) inferredAlignment = 'left';
                    else if (element.classList.contains('text-center')) inferredAlignment = 'center';
                    else if (element.classList.contains('text-right')) inferredAlignment = 'right';
                }
                customizeModalOverlay.querySelectorAll(`#${groupId} button`).forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.align === inferredAlignment);
                });
                return inferredAlignment;
            };

            const captionElement = selectedTableElement.querySelector('caption');
            window.customizeCaptionAlignment = setAlignmentButtonState('customize-caption-alignment-group', captionElement, 'left');
            window.customizeColHeaderAlignment = setAlignmentButtonState('customize-col-headers-alignment-group', thead?.querySelector('th'), 'none');
            window.customizeRowHeaderAlignment = setAlignmentButtonState('customize-row-headers-alignment-group', tbody?.querySelector('tr > th:first-child'), 'none');
            window.customizeColspanHeaderAlignment = setAlignmentButtonState('customize-colspan-headers-alignment-group', selectedTableElement.querySelector('th[colspan]'), 'none');
            window.customizeDataCellsAlignment = setAlignmentButtonState('customize-data-cells-alignment-group', selectedTableElement.querySelector('tbody td'), 'none');

        } else {
            // Default resets if no table selected
            customizePageIdPrefixInput.value = '';
            [
                customizeMakeTfootFromColspanCheckbox, customizeFixEmptyCellsCheckbox,
                customizeCaptionCheckbox, customizeClassSmallCheckboxElement, customizeAddSmallToTrCheckbox,
                customizeClassTablesCheckbox, customizeHeaderCheckbox, customizeRowHeaderCheckbox,
                customizeBorderedCheckbox, customizeActiveColHeadersCheckbox, customizeActiveColspanHeadersCheckbox
            ].forEach(cb => cb.checked = true);

            // Reset alignments
            customizeModalOverlay.querySelectorAll('.button-group button.active').forEach(b => b.classList.remove('active'));
            customizeModalOverlay.querySelector('#customize-caption-alignment-group button[data-align="left"]').classList.add('active');
            customizeModalOverlay.querySelectorAll('#customize-col-headers-alignment-group button[data-align="none"], #customize-row-headers-alignment-group button[data-align="none"], #customize-colspan-headers-alignment-group button[data-align="none"], #customize-data-cells-alignment-group button[data-align="none"]').forEach(b => b.classList.add('active'));
            window.customizeCaptionAlignment = 'left';
            window.customizeColHeaderAlignment = 'none';
            window.customizeRowHeaderAlignment = 'none';
            window.customizeColspanHeaderAlignment = 'none';
            window.customizeDataCellsAlignment = 'none';
        }
        
        initializeToggleSwitchesVisuals(customizeModalOverlay);
        updateCustomizeModalPreview(tableInfo ? tableInfo.outerHTML : '');
    }

    // New button event listeners for Clear All, Auto-Encode, Auto-Indent, Copy Code, Import/Export
    copyCodeBtn.addEventListener('click', async () => {
        const codeContent = monacoEditor ? monacoEditor.getValue() : '';
        try {
            // Use a temporary textarea for copying to clipboard as navigator.clipboard.writeText might not work in iframes
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = codeContent;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);

            const originalHtml = copyCodeBtn.innerHTML;
            copyCodeBtn.innerHTML = 'Copied!';
            copyCodeBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            copyCodeBtn.classList.remove('bg-zinc-700', 'hover:bg-zinc-600');
            copyCodeBtn.setAttribute('data-temp-active', 'true');
            updateAllInteractiveButtonStates();
            setTimeout(() => {
                copyCodeBtn.innerHTML = originalHtml;
                copyCodeBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                copyCodeBtn.classList.add('bg-zinc-700', 'hover:bg-zinc-600');
                copyCodeBtn.removeAttribute('data-temp-active');
                updateAllInteractiveButtonStates();
            }, 1500);
        } catch (err) {
            console.error('Failed to copy text: ', err);
            showMessage('Failed to copy code. Please try again or copy manually.', 'error');
        }
    });

    autoFormatBtn.addEventListener('click', () => {
        pushUndoState(); // Save state before action
        if (monacoEditor) {
            let currentContent = monacoEditor.getValue();
            currentContent = protectDataAttributes(currentContent); // Protect attributes

            let formattedContent = html_beautify(currentContent, {
                indent_size: 4,
                space_in_paren: true,
                preserve_newlines: false, // Add this line
                extra_liners: []
            });

            formattedContent = restoreDataAttributes(formattedContent); // Restore attributes
            formattedContent = convertAllEntitiesToNumeric(formattedContent); // Ensure entities are correct

            monacoEditor.setValue(formattedContent);
            applyEntityHighlighting();

            const originalHtml = autoFormatBtn.innerHTML;
            autoFormatBtn.innerHTML = 'Formatted!';
            autoFormatBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            autoFormatBtn.classList.remove('bg-red-700', 'hover:bg-red-800');
            autoFormatBtn.setAttribute('data-temp-active', 'true');
            updateAllInteractiveButtonStates();
            setTimeout(() => {
                autoFormatBtn.innerHTML = originalHtml;
                autoFormatBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                autoFormatBtn.classList.add('bg-red-700', 'hover:bg-red-800');
                autoFormatBtn.removeAttribute('data-temp-active');
                updateAllInteractiveButtonStates();
            }, 1500);
        }
    });

    autoEncodeBtn.addEventListener('click', () => {
        pushUndoState(); // Save state before action
        if (monacoEditor) {
            let currentContent = monacoEditor.getValue();
            currentContent = protectDataAttributes(currentContent); // Protect attributes
            let encodedContent = convertAllEntitiesToNumeric(currentContent); // Apply encoding
            encodedContent = restoreDataAttributes(encodedContent); // Restore attributes

            monacoEditor.setValue(encodedContent);
            applyEntityHighlighting();

            const originalHtml = autoEncodeBtn.innerHTML;
            autoEncodeBtn.innerHTML = 'Encoded!';
            autoEncodeBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            autoEncodeBtn.classList.remove('bg-red-700', 'hover:bg-red-800');
            autoEncodeBtn.setAttribute('data-temp-active', 'true');
            updateAllInteractiveButtonStates();
            setTimeout(() => {
                autoEncodeBtn.innerHTML = originalHtml;
                autoEncodeBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                autoEncodeBtn.classList.add('bg-red-700', 'hover:bg-red-800');
                autoEncodeBtn.removeAttribute('data-temp-active');
                updateAllInteractiveButtonStates();
            }, 1500);
        }
    });

    exportHtmlBtn.addEventListener('click', () => {
        const htmlContent = monacoEditor ? monacoEditor.getValue() : '';
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'table_formatter_output.html'; // Default filename
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        const originalHtml = exportHtmlBtn.innerHTML;
        exportHtmlBtn.innerHTML = 'Exported!';
        exportHtmlBtn.classList.add('bg-green-500', 'hover:bg-green-600');
        exportHtmlBtn.classList.remove('bg-red-700', 'hover:bg-red-800');
        exportHtmlBtn.setAttribute('data-temp-active', 'true');
        updateAllInteractiveButtonStates();
        setTimeout(() => {
            exportHtmlBtn.innerHTML = originalHtml;
            exportHtmlBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
            exportHtmlBtn.classList.add('bg-red-700', 'hover:bg-red-800');
            exportHtmlBtn.removeAttribute('data-temp-active');
            updateAllInteractiveButtonStates();
        }, 1500);
    });

    importHtmlBtn.addEventListener('click', () => htmlFileInput.click());
    htmlFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const importedContent = e.target.result;
                if (monacoEditor) {
                    pushUndoState(); // Save state before action
                    monacoEditor.setValue(importedContent);
                    applyEntityHighlighting();
                }
                const originalHtml = importHtmlBtn.innerHTML;
                importHtmlBtn.innerHTML = 'Imported!';
                importHtmlBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                importHtmlBtn.classList.remove('bg-purple-700', 'hover:bg-purple-800');
                importHtmlBtn.setAttribute('data-temp-active', 'true');
                updateAllInteractiveButtonStates();
                setTimeout(() => {
                    importHtmlBtn.innerHTML = originalHtml;
                    importHtmlBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                    importHtmlBtn.classList.add('bg-purple-700', 'hover:bg-purple-800');
                    htmlFileInput.value = null; // Clear the input so same file can be imported again
                    importHtmlBtn.removeAttribute('data-temp-active');
                    updateAllInteractiveButtonStates();
                }, 1500);
            };
            reader.readAsText(file);
        }
    });

    clearAllBtn.addEventListener('click', () => {
        if (monacoEditor) {
            pushUndoState(); // Save state before action
            monacoEditor.setValue('');
            showMessage('Editor content cleared.', 'info');
            const originalHtml = clearAllBtn.innerHTML;
            clearAllBtn.innerHTML = 'Cleared!';
            clearAllBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            clearAllBtn.classList.remove('bg-zinc-700', 'hover:bg-zinc-600');
            clearAllBtn.setAttribute('data-temp-active', 'true');
            updateAllInteractiveButtonStates();
            setTimeout(() => {
                clearAllBtn.innerHTML = originalHtml;
                clearAllBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                clearAllBtn.classList.add('bg-zinc-700', 'hover:bg-zinc-600');
                clearAllBtn.removeAttribute('data-temp-active');
                updateAllInteractiveButtonStates();
            }, 1500);
        }
    });

    // Event listener for the table search dropdown
    tableSearchDropdown.addEventListener('change', () => {
        const selectedValue = tableSearchDropdown.value;
        clearMonacoHighlight();

        if (selectedValue && monacoEditor) {
            const model = monacoEditor.getModel();
            const tableInfo = tableDataMap.get(selectedValue);

            if (tableInfo && tableInfo.startIndex !== -1) {
                const position = model.getPositionAt(tableInfo.startIndex);
                monacoEditor.revealLineInCenter(position.lineNumber, monaco.editor.ScrollType.Smooth);
                
                const endPosition = model.getPositionAt(tableInfo.startIndex + tableInfo.length);

                currentHighlightDecorationId = model.deltaDecorations([], [{
                    range: new monaco.Range(position.lineNumber, position.column, endPosition.lineNumber, endPosition.column),
                    options: { isTransparent: true, className: 'selected-line-highlight' }
                }]);
                
                openOptionsModalCustomize();
            } else {
                updateCustomizePreview('');
            }
        } else {
            updateCustomizePreview('');
        }
    });

    // Listen for messages from the iframe (for content updates)
    window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'iframeReady') {
            // When iframe is ready, send the initial mode (no longer needed, but keeping for general iframe communication)
        } else if (event.data && event.data.type === 'updateTableContent') {
            const updatedTableHtml = event.data.tableHtml;
            const selectedValue = tableSearchDropdown.value;
            const tableInfo = tableDataMap.get(selectedValue);

            if (tableInfo && monacoEditor) {
                const newLength = updatedTableHtml.length;
                
                monacoEditor.executeEdits('iframe-update', [{
                    range: new monaco.Range(
                        monacoEditor.getModel().getPositionAt(tableInfo.startIndex).lineNumber,
                        monacoEditor.getModel().getPositionAt(tableInfo.startIndex).column,
                        monacoEditor.getModel().getPositionAt(tableInfo.startIndex + tableInfo.length).lineNumber,
                        monacoEditor.getModel().getPositionAt(tableInfo.startIndex + tableInfo.length).column
                    ),
                    text: updatedTableHtml
                }]);

                tableInfo.length = newLength;
                tableInfo.outerHTML = updatedTableHtml;
                applyEntityHighlighting();
                tableSearchDropdown.value = selectedValue;
            }
        }
    });

    // Wrap Monaco editor initialization and main event listener attachments in window.onload
    window.onload = function() {
        console.log('Window loaded, initializing Monaco Editor...'); // Debugging log
        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            monacoEditor = monaco.editor.create(document.getElementById('editor-container'), {
                value: `<table>
  <tbody>
    <tr>
      <td>&nbsp;</td>
      <td>North</td>
      <td>South</td>
      <td>East</td>
      <td>West</td>
    </tr>
    <tr>
      <td>Electronics</td>
      <td>100</td>
      <td>150,50</td>
      <td>120 000</td>
      <td>180.75</td>
    </tr>
    <tr>
      <td>Apparel</td>
      <td>80.00</td>
      <td>-120</td>
      <td>90,000.50</td>
      <td>+110,25</td>
    </tr>
    <tr>
      <td>Books</td>
      <td>50</td>
      <td>70</td>
      <td>60</td>
      <td>90</td>
    </tr>
     <tr>
      <td>Food</td>
      <td>120</td>
      <td>100</td>
      <td>140</td>
      <td>140</td>
    </tr>
    <tr>
      <td colspan="5">This is a colspan spanning the entire table.</td>
    </tr>
  </tbody>
</table>
<figure>
<table id="tbl11">
    <thead>
        <tr>
            <th rowspan="2">Category</th>
            <th colspan="2">Q1 Sales</th>
            <th colspan="2">Q2 Sales</th>
        </tr>
        <tr>
            <th>Jan</th>
            <th>Feb</th>
            <th>Mar</th>
            <th>Apr</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <th>Electronics</th>
            <td>100</td>
            <td>150</td>
            <td>120</td>
            <td>180</td>
        </tr>
        <tr>
            <th>Apparel</th>
            <td>80</td>
            <td>-120</td>
            <td>90</td>
            <td>110</td>
        </tr>
        <tr>
            <th>Books</th>
            <td>50</td>
            <td>70</td>
            <td>60</td>
            <td>90</td>
        </tr>
    </tbody>
    <tfoot>
        <tr>
            <th>Total</th>
            <td>230</td>
            <td>100</td>
            <td>270</td>
            <td>380</td>
        </tr>
    </tfoot>
</table>
<p>Table with existing ID and caption:</p>
<table id="myExistingTable" class="some-custom-class">
    <caption>Existing Caption with more info</caption>
    <thead>
        <tr><th colspan="2">Existing Header Group</th></tr>
    </thead>
    <tbody>
        <tr><td>Data 1</td><td>Data 2</td></tr>
    </tbody>
</table>
<table>
    <thead>
        <tr>
            <th>Header 1</th>
            <th>Header 2</th>
            <th>Header 3</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <th>Row Header A</th>
            <td></td> <td>Data A2</td>
        </tr>
        <tr>
            <th></th> <td>Data B1</td>
            <td>Data B2</td>
        </tr>
        <tr>
            <td> <p></p> </td> <td>Data C1</td>
            <td>Data C2</td>
        </tr>
        <tr>
            <td>  </td> <td>Data D1</td>
            <td>Data D2</td>
        </tr>
        <tr>
            <td>&nbsp;</td> <td>Data E1</td>
            <td>Data E2</td>
        </tr>
    </tbody>
</table>
`,
                language: 'html',
                theme: 'vs-dark',
                automaticLayout: true,
                minimap: { enabled: false }
            });

            // --- NEW: Initialize Undo/Redo ---
            pushUndoState(); // Push the initial state
            document.getElementById('undoBtn').addEventListener('click', undo);
            document.getElementById('redoBtn').addEventListener('click', redo);


            populateTableSearchDropdown();

            monacoEditor.onDidChangeModelContent(() => {
                if(isUndoingOrRedoing) return; // Prevent loop
                pushUndoState(); // Push state on manual user edits
                clearTimeout(window.monacoUpdateTimeout);
                window.monacoUpdateTimeout = setTimeout(() => {
                    applyEntityHighlighting();
                    const currentSelection = tableSearchDropdown.value;
                    populateTableSearchDropdown(currentSelection);
                }, 500); // 500ms delay
            });


            applyEntityHighlighting();

            customizePageIdPrefixInput.addEventListener('input', function() {
                updateCustomizeModalPreview();
                if (customizePreviewIframe.contentWindow) {
                    customizePreviewIframe.contentWindow.postMessage({ type: 'updateTableId', newId: this.value.trim() }, '*');
                }
            });

            const allCustomizeCheckboxes = [
                customizeMakeTfootFromColspanCheckbox, customizeCaptionCheckbox, customizeFixEmptyCellsCheckbox, customizeRemovePTagsCheckbox,
                customizeClassSmallCheckboxElement, customizeAddSmallToTrCheckbox, customizeClassTablesCheckbox,
                customizeHeaderCheckbox, customizeRowHeaderCheckbox, customizeBorderedCheckbox,
                customizeStripedCheckbox, customizeHoverCheckbox, customizeActiveColHeadersCheckbox,
                customizeActiveColspanHeadersCheckbox, customizeActiveRowHeadersCheckbox, customizeBoldTotalsCheckbox,
                customizeFinanceTableCheckbox, customizeInvCaptionCheckbox
            ];

            allCustomizeCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const parentLabel = this.closest('.toggle-switch');
                    parentLabel.classList.toggle('is-checked', this.checked);
                    updateCustomizeModalPreview();
                });
            });

            const universalFormatCheckboxes = [
                idCheckbox, makeTfootFromColspanCheckbox, captionCheckbox,
                autoCaptionCheckbox, fixEmptyCellsCheckbox, removePTagsCheckbox,
                classSmallCheckboxElement, addSmallToTrCheckbox, classTablesCheckbox, headerCheckbox,
                rowHeaderCheckbox, activeColHeadersCheckbox, activeColspanHeadersCheckbox, activeRowHeadersCheckbox,
                borderedCheckbox, stripedCheckbox, hoverCheckbox, boldTotalsCheckbox, financeTableCheckbox, invCaptionCheckbox
            ];

            universalFormatCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    this.closest('.toggle-switch').classList.toggle('is-checked', this.checked);
                });
            });

            // --- FIX: Default TFOOT before TBODY to ON and DISABLED ---
            const universalTfootToggle = document.getElementById('make-tfoot-before-tbody-checkbox');
            const customTfootToggle = document.getElementById('customize-make-tfoot-before-tbody-checkbox');

            if (universalTfootToggle) {
                universalTfootToggle.checked = true;
                universalTfootToggle.disabled = true;
                const universalParentLabel = universalTfootToggle.closest('.toggle-switch');
                if (universalParentLabel) {
                    universalParentLabel.classList.add('is-checked');
                    universalParentLabel.style.opacity = '0.6';
                    universalParentLabel.style.cursor = 'not-allowed';
                }
            }

            if (customTfootToggle) {
                customTfootToggle.checked = true;
                customTfootToggle.disabled = true;
                const customParentLabel = customTfootToggle.closest('.toggle-switch');
                if (customParentLabel) {
                    customParentLabel.classList.add('is-checked');
                    customParentLabel.style.opacity = '0.6';
                    customParentLabel.style.cursor = 'not-allowed';
                }
            }

            // --- NEW: Cell Action Button Event Listeners ---
            const cellActionButtons = {
                'unbold-th-btn': { action: 'toggle-unbold-th' },
                'bold-td-btn': { action: 'toggle-bold-td' },
                'align-left-btn': { action: 'set-alignment', value: 'left' },
                'align-center-btn': { action: 'set-alignment', value: 'center' },
                'align-right-btn': { action: 'set-alignment', value: 'right' },
                'align-none-btn': { action: 'set-alignment', value: 'none' },
                'mrgn-sm-btn': { action: 'set-margin', value: 'sm' },
                'mrgn-md-btn': { action: 'set-margin', value: 'md' },
                'mrgn-lg-btn': { action: 'set-margin', value: 'lg' },
                'mrgn-xl-btn': { action: 'set-margin', value: 'xl' },
                'mrgn-0-btn': { action: 'set-margin', value: '0' }
            };

            Object.keys(cellActionButtons).forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.addEventListener('click', () => {
                        if (customizePreviewIframe && customizePreviewIframe.contentWindow) {
                            customizePreviewIframe.contentWindow.postMessage({
                                type: 'cellAction',
                                payload: cellActionButtons[id]
                            }, '*');
                        }
                    });
                }
            });

            const customClassInput = document.getElementById('custom-class-input');
            const addClassBtn = document.getElementById('add-class-btn');
            const removeClassBtn = document.getElementById('remove-class-btn');

            if (addClassBtn) {
                addClassBtn.addEventListener('click', () => {
                    const className = customClassInput.value.trim();
                    if (className && customizePreviewIframe && customizePreviewIframe.contentWindow) {
                        customizePreviewIframe.contentWindow.postMessage({
                            type: 'cellAction',
                            payload: { action: 'add-custom-class', value: className }
                        }, '*');
                    }
                });
            }
            if (removeClassBtn) {
                removeClassBtn.addEventListener('click', () => {
                    const className = customClassInput.value.trim();
                    if (className && customizePreviewIframe && customizePreviewIframe.contentWindow) {
                        customizePreviewIframe.contentWindow.postMessage({
                            type: 'cellAction',
                            payload: { action: 'remove-custom-class', value: className }
                        }, '*');
                    }
                });
            }
        });
    };
</script>


</body>
</html>
