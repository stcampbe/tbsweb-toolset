<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeMirror HTML Table Formatter</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <!-- CodeMirror Theme CSS (explicitly loading default theme) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/default.min.css">
    <style>
        /* Custom styles to ensure CodeMirror fits well and for general aesthetics */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter font */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f4f8; /* Light background */
            padding: 1rem;
        }
        .container {
            background-color: #ffffff;
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            width: 100%;
            max-width: 900px; /* Max width for larger screens */
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .CodeMirror {
            border: 1px solid #cbd5e1; /* Light border */
            border-radius: 0.5rem; /* Rounded corners for editor */
            height: 400px; /* Fixed height for the editor */
            font-size: 0.95rem; /* Slightly smaller font for code */
        }
        /* Responsive tables styling for horizontal scrolling */
        .table-responsive {
            overflow-x: auto; /* Enable horizontal scrolling */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        /* CodeMirror syntax highlighting colors */
        .cm-s-default .cm-tag { color: #ef4444; } /* HTML tags */
        .cm-s-default .cm-attribute { color: #059669; } /* HTML attributes */
        .cm-s-default .cm-string { color: #3b82f6; } /* Attribute values, strings */
        .cm-s-default .cm-keyword { color: #d946ef; } /* JS keywords (if JS is mixed) */
        .cm-s-default .cm-comment { color: #6b7280; font-style: italic; } /* Comments */
        .cm-s-default .cm-atom { color: #f97316; } /* Booleans, null */
        .cm-s-default .cm-number { color: #10b981; } /* Numbers */
        .cm-s-default .cm-variable { color: #007bff; } /* JS variables (if JS is mixed) */
        .cm-s-default .cm-error { color: #ef4444; } /* Errors */
        .cm-s-default .cm-builtin { color: #8a2be2; } /* Built-in functions/objects */
        .cm-s-default .cm-property { color: #20b2aa; } /* Object properties */
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800">HTML Table Formatter</h1>
        <p class="text-gray-600 text-center">
            Paste your HTML table code below. The formatter will clean up the table structure and apply chosen options.
        </p>

        <!-- Options Checkboxes and ID Prefix Input -->
        <div class="flex flex-wrap items-center justify-center gap-4 p-4 bg-gray-50 rounded-lg shadow-inner">
            <label class="inline-flex items-center">
                <input type="checkbox" id="auto-id-checkbox" class="form-checkbox text-blue-600 h-5 w-5" checked>
                <span class="ml-2 text-gray-700">Auto ID Tables</span>
            </label>
            <div class="flex items-center gap-2">
                <label for="id-prefix-input" class="text-gray-700">ID Prefix:</label>
                <input type="text" id="id-prefix-input" value="tbl" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm w-24">
            </div>
            <label class="inline-flex items-center">
                <input type="checkbox" id="auto-class-checkbox" class="form-checkbox text-blue-600 h-5 w-5" checked>
                <span class="ml-2 text-gray-700">Auto Class Tables</span>
            </label>
            <label class="inline-flex items-center">
                <input type="checkbox" id="auto-caption-checkbox" class="form-checkbox text-blue-600 h-5 w-5" checked>
                <span class="ml-2 text-gray-700">Auto Caption Tables</span>
            </label>
            <label class="inline-flex items-center">
                <input type="checkbox" id="auto-header-checkbox" class="form-checkbox text-blue-600 h-5 w-5" checked>
                <span class="ml-2 text-gray-700">Auto Header Tables</span>
            </label>
            <label class="inline-flex items-center">
                <input type="checkbox" id="auto-row-header-checkbox" class="form-checkbox text-blue-600 h-5 w-5" checked>
                <span class="ml-2 text-gray-700">Auto Row Header</span>
            </label>
             <label class="inline-flex items-center">
                <input type="checkbox" id="auto-finance-table-checkbox" class="form-checkbox text-blue-600 h-5 w-5">
                <span class="ml-2 text-gray-700">Auto Finance Table</span>
            </label>
            <label class="inline-flex items-center">
                <input type="checkbox" id="bold-totals-checkbox" class="form-checkbox text-blue-600 h-5 w-5">
                <span class="ml-2 text-gray-700">Bold Totals</span>
            </label>
            <label class="inline-flex items-center">
                <input type="checkbox" id="center-column-headers-checkbox" class="form-checkbox text-blue-600 h-5 w-5">
                <span class="ml-2 text-gray-700">Center Column Headers</span>
            </label>
            <label class="inline-flex items-center">
                <input type="checkbox" id="center-body-headers-checkbox" class="form-checkbox text-blue-600 h-5 w-5">
                <span class="ml-2 text-gray-700">Center Body Headers</span>
            </label>
            <label class="inline-flex items-center">
                <input type="checkbox" id="active-colspan-headers-checkbox" class="form-checkbox text-blue-600 h-5 w-5">
                <span class="ml-2 text-gray-700">Active Colspan Headers</span>
            </label>
            <label class="inline-flex items-center">
                <input type="checkbox" id="active-row-headers-checkbox" class="form-checkbox text-blue-600 h-5 w-5">
                <span class="ml-2 text-gray-700">Active Row Headers</span>
            </label>
            <label class="inline-flex items-center">
                <input type="checkbox" id="responsive-tables-checkbox" class="form-checkbox text-blue-600 h-5 w-5">
                <span class="ml-2 text-gray-700">Responsive Tables</span>
            </label>
            <label class="inline-flex items-center">
                <input type="checkbox" id="auto-scope-checkbox" class="form-checkbox text-blue-600 h-5 w-5" checked>
                <span class="ml-2 text-gray-700">Auto Scope Tables</span>
            </label>
        </div>

        <!-- Textarea for CodeMirror -->
        <textarea id="code-editor" class="hidden"></textarea>

        <!-- Format Button -->
        <button id="format-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
            Format Tables
        </button>

        <!-- Message Box for alerts/errors -->
        <div id="message-box" class="hidden p-4 rounded-lg text-sm text-center" role="alert"></div>
    </div>

    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/selection/active-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.js"></script>

    <script>
        // Initialize CodeMirror editor
        const editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            mode: 'htmlmixed', // Use htmlmixed mode for HTML
            lineNumbers: true,
            matchBrackets: true,
            autoCloseBrackets: true,
            styleActiveLine: true,
            theme: 'default' // Default CodeMirror theme
        });

        // Set initial example HTML content with tables to demonstrate auto-ID reordering
        editor.setValue(`<table>
      <tbody>
        <tr>
          <th rowspan="2">Category</th>
          <th colspan="2">Q1 Sales</th>
          <th colspan="2">Q2 Sales</th>
        </tr>
        <tr>
          <th class="text-left">North</th>
          <th>South</th>
          <th>East</th>
          <th class="text-right">West</th>
        </tr>
        <tr>
          <td>Electronics</td>
          <td>100</td>
          <td>150,50</td>
          <td>120 000</td>
          <td>180.75</td>
        </tr>
        <tr>
          <td>Apparel</td>
          <td>80.00</td>
          <td>-120</td>
          <td>90 000.50</td>
          <td>+110,25</td>
        </tr>
        <tr>
          <th>Subtotal</th>
          <td>1000</td>
          <td>2000</td>
          <td>3000</td>
          <td>4000</td>
        </tr>
        <tr>
          <td>Books</td>
          <td>50</td>
          <td rowspan="2">70 (merged)</td>
          <td>60</td>
          <td>90</td>
        </tr>
         <tr>
          <td>Food</td>
          <td>120</td>
          <td>100</td>
          <td>140</td>
        </tr>
        <tr>
          <th colspan="2" class="text-right">Grand Total</th>
          <td>3000</td>
          <td>5000</td>
          <td>8100</td>
        </tr>
        <tr>
          <th>Total</th>
          <td>1500</td>
          <td>2500</td>
          <td>3600</td>
          <td>4500</td>
        </tr>
      </tbody>
    </table>

    <p>Simple Table (no col/rowspan):</p>
    <table>
        <thead>
            <tr>
                <th>Header 1</th>
                <th>Header 2</th>
                <th>Header 3</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <th>Row Header A</th>
                <td>Data A1</td>
                <td>Data A2</td>
            </tr>
            <tr>
                <th>Row Header B</th>
                <td>Data B1</td>
                <td>Data B2</td>
            </tr>
        </tbody>
    </table>

    <p>Table with existing ID and caption:</p>
    <table id="myExistingTable" class="some-custom-class">
        <caption>Existing Caption with more info</caption>
        <thead>
            <tr><th colspan="2">Existing Header Group</th></tr>
        </thead>
        <tbody>
            <tr><td>Data 1</td><td>Data 2</td></tr>
        </tbody>
    </table>
    `);

        const formatButton = document.getElementById('format-button');
        const autoIdCheckbox = document.getElementById('auto-id-checkbox');
        const idPrefixInput = document.getElementById('id-prefix-input');
        const autoClassCheckbox = document.getElementById('auto-class-checkbox');
        const autoCaptionCheckbox = document.getElementById('auto-caption-checkbox');
        const autoHeaderCheckbox = document.getElementById('auto-header-checkbox');
        const autoRowHeaderCheckbox = document.getElementById('auto-row-header-checkbox');
        const autoFinanceTableCheckbox = document.getElementById('auto-finance-table-checkbox');
        const boldTotalsCheckbox = document.getElementById('bold-totals-checkbox');
        const centerColumnHeadersCheckbox = document.getElementById('center-column-headers-checkbox');
        const centerBodyHeadersCheckbox = document.getElementById('center-body-headers-checkbox');
        const activeColspanHeadersCheckbox = document.getElementById('active-colspan-headers-checkbox');
        const activeRowHeadersCheckbox = document.getElementById('active-row-headers-checkbox');
        const responsiveTablesCheckbox = document.getElementById('responsive-tables-checkbox');
        const autoScopeCheckbox = document.getElementById('auto-scope-checkbox');
        const messageBox = document.getElementById('message-box');

        /**
         * Displays a message in the message box.
         * @param {string} message - The message to display.
         * @param {string} type - 'success', 'error', or 'info' for styling.
         */
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800');
            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-800');
            } else { // info
                messageBox.classList.add('bg-blue-100', 'text-blue-800');
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000); // Hide after 5 seconds
        }

        /**
         * This function simply returns the trimmed original string.
         * @param {string} str - The string to trim.
         * @returns {string} The original string, trimmed.
         */
        function padString(str) {
            return str.trim(); // Just return the trimmed string
        }

        /**
         * Formats the HTML content, specifically targeting and cleaning up tables,
         * and optionally applies various styling and structural enhancements.
         */
        function formatHtmlTables() {
            const htmlText = editor.getValue();
            if (!htmlText.trim()) {
                showMessage('No HTML content to format.', 'info');
                return;
            }

            try {
                // We use a dummy div to parse the HTML snippet without needing full document structure.
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlText;

                // Select all table elements within the parsed snippet
                const tables = tempDiv.querySelectorAll('table');

                if (tables.length === 0) {
                    showMessage('No HTML tables found to format.', 'info');
                    return;
                }

                const applyAutoId = autoIdCheckbox.checked;
                const customIdPrefix = idPrefixInput.value.trim();
                const currentIdRegex = new RegExp(`^${customIdPrefix}\\d+$`);

                const applyAutoClass = autoClassCheckbox.checked;
                const applyAutoCaption = autoCaptionCheckbox.checked;
                const applyAutoHeader = autoHeaderCheckbox.checked;
                const applyAutoRowHeader = autoRowHeaderCheckbox.checked;
                const applyAutoFinanceTable = autoFinanceTableCheckbox.checked;
                const boldTotals = boldTotalsCheckbox.checked;
                const centerColumnHeaders = centerColumnHeadersCheckbox.checked;
                const centerBodyHeaders = centerBodyHeadersCheckbox.checked;
                const activeColspanHeaders = activeColspanHeadersCheckbox.checked;
                const activeRowHeaders = activeRowHeadersCheckbox.checked;
                const responsiveTables = responsiveTablesCheckbox.checked;
                const applyAutoScope = autoScopeCheckbox.checked;

                const defaultClasses = "table table-bordered table-condensed table-hover mrgn-tp-lg mrgn-bttm-lg small".split(' ');
                const activeRowClass = 'active'; // Class for <tr> in <thead>
                const financeClasses = ['text-right', 'nowrap'];
                const centerClass = 'text-center';
                const alignmentClasses = ['text-left', 'text-center', 'text-right'];
                const financeRegex = /^\s*[-+]?(?:\d+|\d{1,3}(?:\s\d{3})*)(?:[.,]\d+)?\s*$/;
                const responsiveDivClass = 'table-responsive';


                let tableCounter = 1;

                tables.forEach(table => {
                    // --- Handle Responsive Tables Wrapping/Unwrapping FIRST ---
                    const parentIsResponsiveDiv = table.parentNode && table.parentNode.classList.contains(responsiveDivClass);

                    if (responsiveTables) {
                        if (!parentIsResponsiveDiv) {
                            const responsiveDiv = document.createElement('div');
                            responsiveDiv.classList.add(responsiveDivClass);
                            table.parentNode.insertBefore(responsiveDiv, table);
                            responsiveDiv.appendChild(table);
                        }
                    } else {
                        if (parentIsResponsiveDiv) {
                            const parentDiv = table.parentNode;
                            parentDiv.parentNode.insertBefore(table, parentDiv);
                            parentDiv.remove();
                        }
                    }

                    const allRows = Array.from(table.querySelectorAll('tr'));
                    table.querySelectorAll('thead, tbody, tfoot').forEach(el => el.remove());

                    // --- Clean 'active' class from all TH elements before re-applying ---
                    Array.from(table.querySelectorAll('th')).forEach(th => {
                        th.classList.remove('active');
                    });

                    // --- Clean up all auto-generated scope/id/headers attributes from previous runs ---
                    Array.from(table.querySelectorAll('th, td')).forEach(cell => {
                        if (cell.id && cell.id.startsWith(`${table.id}_th_`)) { // Check if ID was auto-generated
                            cell.removeAttribute('id');
                        }
                        cell.removeAttribute('scope');
                        cell.removeAttribute('headers');
                    });


                    if (applyAutoId) {
                        const existingId = table.id;
                        const isCurrentPrefixId = existingId && currentIdRegex.test(existingId);

                        if (!existingId || isCurrentPrefixId) {
                            table.removeAttribute('id');
                            table.id = `${customIdPrefix}${tableCounter}`;
                        }
                    } else {
                        if (table.id && currentIdRegex.test(table.id)) {
                            table.removeAttribute('id');
                        }
                    }

                    if (applyAutoClass) {
                        const currentClasses = new Set(table.className.split(' ').filter(c => c.trim() !== ''));
                        defaultClasses.forEach(c => currentClasses.add(c));
                        table.className = Array.from(currentClasses).join(' ');
                    } else {
                        const currentClasses = table.className.split(' ').filter(c => c.trim() !== '');
                        const filteredClasses = currentClasses.filter(c => !defaultClasses.includes(c));
                        table.className = Array.from(new Set(filteredClasses)).join(' ');
                    }

                    let headerRowCount = 0;
                    if (applyAutoHeader) {
                        let maxRowSpanEnd = -1;

                        for (let i = 0; i < allRows.length; i++) {
                            const currentRow = allRows[i];
                            headerRowCount = i + 1;

                            const cellsInCurrentRow = Array.from(currentRow.querySelectorAll('th, td'));
                            cellsInCurrentRow.forEach(cell => {
                                const rowspan = parseInt(cell.getAttribute('rowspan') || '1', 10);
                                maxRowSpanEnd = Math.max(maxRowSpanEnd, i + rowspan - 1);
                            });

                            if (i >= maxRowSpanEnd) {
                                break;
                            }
                        }
                    }

                    const newThead = document.createElement('thead');
                    const newTbody = document.createElement('tbody');

                    allRows.forEach((row, index) => {
                        row.classList.remove(activeRowClass);

                        if (index < headerRowCount) {
                            newThead.appendChild(row);
                            if (applyAutoHeader) {
                                row.classList.add(activeRowClass);
                            }
                        } else {
                            newTbody.appendChild(row);
                        }
                    });

                    if (newThead.children.length > 0) {
                        table.appendChild(newThead);
                    }
                    table.appendChild(newTbody);

                    if (applyAutoCaption) {
                        let captionElement = table.querySelector('caption');
                        if (!captionElement) {
                            captionElement = document.createElement('caption');
                            if (table.firstChild) {
                                table.insertBefore(captionElement, table.firstChild);
                            } else {
                                table.appendChild(captionElement);
                            }
                        }

                        captionElement.className = 'text-left';

                        const currentCaptionText = captionElement.textContent.trim();
                        const regex = /^(Table\s+\d+\.)(\s.*)?$/i;

                        if (regex.test(currentCaptionText)) {
                            captionElement.textContent = currentCaptionText.replace(regex, `Table ${tableCounter}.$2`);
                        } else {
                            captionElement.textContent = `Table ${tableCounter}.`;
                        }

                    } else {
                        const existingCaption = table.querySelector('caption');
                        if (existingCaption) {
                            existingCaption.remove();
                        }
                    }

                    const tbodyRows = Array.from(newTbody.querySelectorAll('tr'));
                    tbodyRows.forEach(row => {
                        const firstCell = row.firstElementChild;
                        if (firstCell) {
                            if (applyAutoRowHeader) {
                                if (firstCell.tagName.toLowerCase() === 'td') {
                                    const newTh = document.createElement('th');
                                    Array.from(firstCell.attributes).forEach(attr => {
                                        newTh.setAttribute(attr.name, attr.value);
                                    });
                                    newTh.innerHTML = firstCell.innerHTML;
                                    newTh.classList.add('text-left');
                                    row.replaceChild(newTh, firstCell);
                                }
                            } else {
                                if (firstCell.tagName.toLowerCase() === 'th') {
                                    const newTd = document.createElement('td');
                                    Array.from(firstCell.attributes).forEach(attr => {
                                        newTd.setAttribute(attr.name, attr.value);
                                    });
                                    newTd.innerHTML = firstCell.innerHTML;
                                    newTd.classList.remove('text-left');
                                    row.replaceChild(newTd, firstCell);
                                }
                            }
                        }
                    });

                    // Re-fetch all cells after potential td to th conversion
                    const currentTableCells = Array.from(table.querySelectorAll('th, td'));

                    // --- Auto Scope Logic (Revised based on new definitions) ---
                    if (applyAutoScope) {
                        let isComplexTable = false;
                        // A table is 'complex' if it has colspan/rowspan *within tbody or tfoot*
                        for (const cell of Array.from(table.querySelectorAll('tbody th, tbody td, tfoot th, tfoot td'))) {
                            const colspanVal = parseInt(cell.getAttribute('colspan') || '1', 10);
                            const rowspanVal = parseInt(cell.getAttribute('rowspan') || '1', 10);
                            if (colspanVal > 1 || rowspanVal > 1) {
                                isComplexTable = true;
                                break;
                            }
                        }

                        if (isComplexTable) {
                            // Per new definition: if complex (spans in tbody/tfoot), do NOT add IDs or headers.
                            // The cleanup at the top ensures no previous auto-generated attributes remain.
                        } else {
                            // This is a "simple" table (spans only in thead, or no spans at all)
                            currentTableCells.forEach(cell => {
                                if (cell.tagName.toLowerCase() === 'th') {
                                    const colspan = parseInt(cell.getAttribute('colspan') || '1', 10);
                                    const rowspan = parseInt(cell.getAttribute('rowspan') || '1', 10);

                                    if (cell.closest('thead')) {
                                        if (colspan > 1) {
                                            cell.setAttribute('scope', 'colgroup');
                                        } else if (rowspan > 1) {
                                            cell.setAttribute('scope', 'col'); // As requested: rowspan in thead is 'col'
                                        } else {
                                            cell.setAttribute('scope', 'col'); // Single th in thead is 'col'
                                        }
                                    } else if (cell.closest('tbody') && cell.parentNode.firstElementChild === cell) {
                                        // TH in tbody and it's the first cell of the row: row header
                                        cell.setAttribute('scope', 'row');
                                    }
                                    // Other THs in tbody/tfoot (not first in row, no colspan) remain without scope
                                    // if not covered by these rules, matching the WET-BOEW simplicity for simple tables.
                                }
                            });
                        }
                    } else {
                        // If auto-scope is OFF, ensure all auto-generated scope attributes are removed
                        currentTableCells.forEach(cell => {
                            cell.removeAttribute('scope');
                        });
                    }
                    // --- End Auto Scope Logic ---


                    currentTableCells.forEach(cell => {
                        if (cell.tagName.toLowerCase() === 'td') {
                            if (applyAutoFinanceTable) {
                                if (financeRegex.test(cell.textContent.trim())) {
                                    financeClasses.forEach(cls => cell.classList.add(cls));
                                } else {
                                    financeClasses.forEach(cls => cell.classList.remove(cls));
                                }
                            }
                        } else {
                            financeClasses.forEach(cls => cell.classList.remove(cls));
                        }
                    });

                    const boldableRows = Array.from(table.querySelectorAll('tbody tr'));
                    boldableRows.forEach(row => {
                        const thInRow = row.querySelector('th');
                        let isTotalRow = false;

                        if (thInRow && (thInRow.textContent.trim().toLowerCase() === 'total' || thInRow.textContent.trim().toLowerCase() === 'subtotal')) {
                            isTotalRow = true;
                        }

                        const tdsInRow = Array.from(row.querySelectorAll('td'));
                        tdsInRow.forEach(td => {
                            if (boldTotals && isTotalRow) {
                                if (td.firstElementChild && td.firstElementChild.tagName.toLowerCase() === 'strong') {
                                    td.firstElementChild.innerHTML = td.textContent.trim();
                                } else {
                                    const strongElement = document.createElement('strong');
                                    strongElement.innerHTML = td.innerHTML;
                                    td.innerHTML = '';
                                    td.appendChild(strongElement);
                                }
                            } else {
                                if (td.firstElementChild && td.firstElementChild.tagName.toLowerCase() === 'strong') {
                                    const originalContent = td.firstElementChild.innerHTML;
                                    td.innerHTML = originalContent;
                                }
                            }
                        });
                    });

                    // Apply 'active' class to tbody THs based on new options (moved after Auto Scope to ensure IDs are set)
                    const currentTbodyThs = Array.from(newTbody.querySelectorAll('th'));
                    currentTbodyThs.forEach(th => {
                        // Apply active if colspan option is checked and it has colspan
                        if (activeColspanHeaders && th.hasAttribute('colspan')) {
                            th.classList.add('active');
                        }
                        // Apply active if row header option is checked and it's the first TH in its parent row
                        if (activeRowHeaders && th.parentNode.firstElementChild === th) {
                             th.classList.add('active');
                        }
                    });


                    const theadThs = Array.from(newThead.querySelectorAll('th'));
                    theadThs.forEach(th => {
                        const hasExistingAlignment = alignmentClasses.some(cls => th.classList.contains(cls));

                        if (centerColumnHeaders) {
                            if (!hasExistingAlignment) {
                                th.classList.add(centerClass);
                            }
                        } else {
                            th.classList.remove(centerClass);
                        }
                    });

                    const finalTbodyThsForCentering = Array.from(newTbody.querySelectorAll('th'));
                    finalTbodyThsForCentering.forEach(th => {
                        const hasExistingAlignment = alignmentClasses.some(cls => th.classList.contains(cls));

                        if (th.hasAttribute('colspan')) {
                            if (centerBodyHeaders) {
                                if (!hasExistingAlignment) {
                                    th.classList.add(centerClass);
                                }
                            } else {
                                th.classList.remove(centerClass);
                            }
                        } else if (!centerBodyHeaders) {
                            th.classList.remove(centerClass);
                        }
                    });

                    const finalTableRows = Array.from(table.querySelectorAll('tr'));
                    finalTableRows.forEach((row) => {
                        const cells = Array.from(row.querySelectorAll('th, td'));
                        cells.forEach((cell) => {
                            if (cell.firstElementChild && cell.firstElementChild.tagName.toLowerCase() === 'strong') {
                                cell.firstElementChild.textContent = cell.firstElementChild.textContent.trim();
                            } else {
                                cell.textContent = cell.textContent.trim();
                            }
                        });
                    });

                    tableCounter++;
                });

                editor.setValue(tempDiv.innerHTML);
                showMessage('HTML tables formatted successfully!', 'success');

            } catch (e) {
                console.error("Error formatting HTML tables:", e);
                showMessage('An error occurred during formatting. Please check your HTML.', 'error');
            }
        }

        formatButton.addEventListener('click', formatHtmlTables);
    </script>
</body>
</html>
