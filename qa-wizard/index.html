<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeforeYouPost™ - QA/Prototype Wizard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.15.4/beautify-html.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.52.2/min/vs/loader.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Custom styles for the editor */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent overall body scroll */
        }

        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column; /* Stack header and main content vertically */
            background-color: #1a202c; /* Dark background */
            color: #ffffff;
        }

        /* New header for the QA Wizard title */
        .qa-wizard-header {
            padding: 1rem;
            display: flex; /* Use flexbox for alignment */
            align-items: center; /* Vertically align items */
            gap: 1rem; /* Space between title and buttons */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }

        .qa-wizard-header h1 {
            font-size: 1.25rem; /* text-4xl */
            font-weight: bold;
            color: #ffffff;
            margin-right: auto; /* Push buttons to the right */
        }

        /* Container for sidebar and editor panel */
        .main-content-area {
            display: flex;
            flex-grow: 1; /* Allow this area to take up remaining vertical space */
            padding: 0 1rem 1rem 1rem; /* Padding on sides and bottom */
            gap: 1rem;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden; /* Prevent horizontal scroll in this container */
        }


        .code-panel {
            background-color: #2d3748;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            padding: 1rem;
            display: flex;
            flex-direction: column; /* Stack editor and results vertically */
            min-width: 200px;
            height: 100%; /* Fill available height in main-content-area */
            box-sizing: border-box;
            overflow: hidden; /* Prevent content inside from overflowing its own boundaries */
            flex-grow: 1; /* Ensure it takes up available space */
        }

        /* Monaco Editor Container */
        #monacoEditorContainer {
            border: 1px solid #4a5568;
            border-radius: 0.5rem;
            width: 100%;
            flex-grow: 1; /* Allow editor to grow and fill space */
            min-height: 200px; /* Minimum height for editor */
            margin-bottom: 1rem; /* Space between editor and results */
        }

        /* Validation Results Section */
        #validationResultsContainer {
            /* Removed fixed height and overflow from here */
            background-color: transparent; /* Let the inner div handle the background */
            border-radius: 0.75rem;
            /* margin-top: 1rem; -- moved to monacoEditorContainer */
            color: #ffffff;
            flex-shrink: 0; /* Prevent results from shrinking */
            display: flex; /* Use flexbox for results and sidebar */
            min-height: 50px; /* Minimum height for the container */
        }

        #validationResults {
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            line-height: 1.5;
            flex-grow: 1; /* Allow results to take up remaining space */
            height: 200px; /* Fixed height for results area */
            overflow-y: auto; /* Enable scrolling for results */
            /* Default background for validation results */
            background-color: #f9fafb; /* bg-gray-50 */
            color: #4a5568; /* text-gray-700 */
            border: 1px solid #e2e8f0; /* border-gray-200 */
        }

        /* Specific styles for validation results based on success/error */
        #validationResults.bg-green-100 {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #34d399;
        }
        #validationResults.bg-red-100 {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #f87171;
        }

        /* Styling for clickable error list items */
        #validationResults ul li {
            cursor: pointer;
            padding: 4px 0;
            transition: background-color 0.2s ease;
        }

        #validationResults ul li:hover {
            background-color: rgba(255, 255, 255, 0.1);
            text-decoration: underline;
        }

        /* Monaco Editor custom highlight style for clicked line */
        .monaco-editor .highlighted-line {
            background-color: rgba(100, 149, 237, 0.4); /* Muted cornflower blue, more subtle */
            border-radius: 4px;
        }

        /* Monaco Editor custom highlight style for HTML entities */
        .monaco-editor .entity-highlight {
            color: gold; /* Changed from background-color to color */
            border-radius: 2px;
        }

        /* Toggle Switch Styles (copied from index.html) */
        .toggle-switch-container {
            display: flex;
  align-items: center;
  margin-bottom: 0.25rem;
  padding: 0.25rem 0;
  gap: 0.5rem;
  justify-content: flex-start;
        }

        .toggle-switch-label {
            color: #CBD5E1; /* Light slate for label text */
            font-size: 0.9rem;
            flex-shrink: 1; /* Allow label to shrink */
            min-width: 0; /* Allow text to wrap within the label */
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px; /* Width of the pill */
            height: 24px; /* Height of the pill */
            border-radius: 12px; /* Half of height for pill shape */
            background-color: #64748B; /* Grayish slate for off state */
            cursor: pointer;
            transition: background-color 0.3s ease;
            flex-shrink: 0; /* Prevent the switch from shrinking */
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-switch-slider {
            position: absolute;
            content: "";
            height: 20px; /* Height of the inner circle */
            width: 20px; /* Width of the inner circle */
            left: 2px; /* Initial position for off state */
            bottom: 2px;
            background-color: #ffffff; /* Circle color */
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        /* Checked state styles (applied to the .toggle-switch label itself) */
        .toggle-switch.is-checked {
            background-color: #22c55e; /* Green for on state */
        }

        .toggle-switch.is-checked .toggle-switch-slider {
            transform: translateX(20px); /* Move circle to the right */
        }

        /* Styling for disabled button */
        button:disabled {
            background-color: #4a4a4a !important; /* Darker gray for disabled state, use !important to override other styles */
            cursor: not-allowed !important;
            opacity: 0.6 !important;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #2d3748;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            color: #ffffff;
            text-align: left; /* Left align content */
            max-width: 90%;
            width: 400px;
            position: relative; /* For absolute positioning of close button */
        }

        .modal-content h3 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            text-align: left; /* Ensure title is left aligned */
        }

        .modal-content p {
            margin-bottom: 1.5rem;
        }

        .modal-content button {
            color: white;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: background-color 0.2s ease;
        }

        .modal-content button:hover {
            background-color: #3182ce; /* Blue-600 */
        }

        /* Preview Modal Specific Styles */
        #previewModal .modal-content {
            width: 98%; /* Wider for better preview */
            max-width: 1500px; /* Max width for large screens */
            height: 95%; /* Taller for better preview */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Prevent modal content from scrolling, iframe handles it */
            padding: 1.5rem; /* Reduced padding for modal content */
        }

        #previewModal .modal-content .modal-header-controls {
            display: flex;
            align-items: center; /* Vertically align items */
            /* Removed justify-content: space-between; to allow title and buttons to be close */
            margin-bottom: 0.75rem; /* Reduced space below header */
            flex-wrap: wrap;
        }

        #previewModal .modal-content h3 {
            font-size: 1.25rem; /* Slightly smaller title */
            text-align: left; /* Keep title left-aligned */
            margin-bottom: 0; /* Adjusted for inline elements */
            /* Removed flex-grow: 1; to prevent it from pushing buttons too far */
            margin-right: 0.75rem; /* Space between title and buttons */
        }

        #previewModal iframe {
            width: 100%;
            height: 100%;
            border: 1px solid #4a5568;
            border-radius: 0.5rem;
            background-color: #ffffff;
            flex-grow: 1; /* Allow iframe to take available space */
        }

        /* Customize section styles for modal */
        #previewModal .customize-section {
            background-color: #3b455a;
            border-radius: 0.5rem;
            padding: 0.75rem; /* Reduced padding */
            margin-bottom: 0.75rem; /* Reduced margin */
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #previewModal .customize-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        #previewModal .customize-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        #previewModal .customize-content.expanded {
            max-height: 500px; /* Adjust as needed to fit content */
            transition: max-height 0.5s ease-in;
            padding-top: 0.5rem;
        }

        #previewModal .customize-header svg {
            transition: transform 0.3s ease;
        }

        #previewModal .customize-header.expanded svg {
            transform: rotate(180deg);
        }

        /* Button group styles for modal customize section (from index.html) */
        #previewModal .button-group {
            display: flex;
            width: 100%; /* Make it span full width */
            border-radius: 0.5rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            border: 1px solid #4a5568; /* Darker border for button group */
            flex-wrap: wrap; /* Keep for responsiveness on smaller screens */
        }

        #previewModal .button-group button {
            flex: 1; /* Make buttons take up equal space */
            border-radius: 0; /* Remove individual button rounded corners */
            border: none; /* Remove individual button borders */
            margin: 0; /* Remove individual button margins */
            padding: 0.5rem 0.75rem; /* Consistent padding */
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem; /* leading-5 */
            position: relative; /* For z-index if needed */
            color: #ffffff; /* White text for all buttons */
            font-weight: bold; /* Make buttons bold */
        }

        #previewModal .button-group button:hover {
            background-color: #3182ce; /* Blue-600 */
        }

        /* Adjust border between buttons in the main button groups */
        #previewModal .button-group:not(.no-border-buttons) button:not(:last-child) {
            border-right: 1px solid rgba(74, 85, 104, 0.5); /* Darker separator between buttons */
        }
        #previewModal .button-group.no-border-buttons button:not(:last-child) {
            border-right: none; /* Remove border for this specific group */
        }

        /* Specific styling for the byline and URL/Image source button groups */
        #previewModal .button-group.individual-rounded-buttons {
            border: none; /* Remove group border */
            box-shadow: none; /* Remove group shadow */
            width: auto; /* Allow the group to size to content */
            gap: 0.5rem; /* Add gap between individual buttons */
        }

        #previewModal .button-group.individual-rounded-buttons button {
            flex: none; /* Do not make buttons take equal space */
            border-radius: 0.5rem; /* Ensure rounded corners */
            border: 1px solid #4a5568; /* Add individual button border */
            padding: 0.5rem 0.75rem; /* Consistent padding */
        }
        /* Remove right border for individual rounded buttons */
        #previewModal .button-group.individual-rounded-buttons button:not(:last-child) {
            border-right: 1px solid #4a5568; /* Keep individual border */
        }

        #previewModal .button-group button:first-child {
            border-top-left-radius: 0.5rem;
            border-bottom-left-radius: 0.5rem;
        }

        #previewModal .button-group button:last-child {
            border-top-right-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }

        #previewModal .button-group button.active:hover {
            z-index: 1; /* Bring hovered button to front to show full border/shadow */
			background-color: #3182ce !important;
        }
		#previewModal .button-group button.active:hover {
            z-index: 1; /* Bring hovered button to front to show full border/shadow */
			background-color: #3182ce !important;
        }

        /* Active states for buttons in modal, matching QA Wizard */
        #previewModal .button-group button.active {
			color: white !important;
			background-color: #4a5568 !important;
		}
        /* Specific active state for WET4 button */
        #previewModal #modalWetGcdsToggleBtn.active {
            background-color: #2563eb !important; /* Blue-600 for WET4 active */
            border-color: #2563eb !important;
        }
        #previewModal #modalWetGcdsToggleBtn.hover {
            background-color: #2563eb !important; /* Blue-600 for WET4 active */
            border-color: #2563eb !important;
        }
        /* Specific active state for GCDS/WET+ button */
        #previewModal #modalWetGcdsToggleBtn[class*="indigo-600"].active {
            background-color: #4f46e5 !important; /* Indigo-600 for GCDS/WET+ active */
            border-color: #4f46e5 !important;
        }

        /* Specific styling for the Sections and Headings buttons in modal */
        #previewModal #modalToggleSectionsBtn,
        #previewModal #modalToggleHeadingsBtn {
            flex: none; /* Override flex: 1; for these specific buttons */
            width: auto; /* Allow buttons to size based on content */
            border: 1px solid #4a5568; /* Add border back for individual buttons */
            border-radius: 0.5rem; /* Add rounded corners back for individual buttons */
            padding: 0.3rem 0.6rem; /* Reduced padding */
            font-size: 0.75rem; /* Smaller font size */
        }
        #previewModal #modalToggleSectionsBtn.active,
        #previewModal #modalToggleHeadingsBtn.active {
            background-color: #facc15 !important; /* Tailwind yellow-400 */
            color: #1f2937 !important; /* Dark gray for text */
            border-color: #facc15 !important;
        }
        /* Default state for Sections/Headings buttons */
        #previewModal #modalToggleSectionsBtn,
        #previewModal #modalToggleHeadingsBtn {
            background-color: #374151; /* Tailwind gray-700 */
            color: #ffffff;
        }
        #previewModal #modalToggleSectionsBtn:hover,
        #previewModal #modalToggleHeadingsBtn:hover {
            background-color: #4b5563; /* Tailwind gray-600 */
        }

        /* Input and Label styles for modal */
        #previewModal input[type="text"] {
            background-color: #4a5568; /* Darker background for input */
            color: #ffffff; /* White text for input */
            border-color: #4a5568; /* Darker border for input */
            border-radius: 0.5rem; /* rounded-md */
            padding: 0.5rem 0.75rem; /* Consistent padding */
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem; /* leading-5 */
        }
        #previewModal input[type="text"]::placeholder {
            color: #a0aec0; /* Lighter placeholder text */
        }
        #previewModal label {
            color: #cbd5e0; /* Lighter gray for labels */
        }

        /* Styles for Prev/Next buttons in modal */
        #modalPreviewFindPrevBtn,
        #modalPreviewFindNextBtn {
            padding: 0.25rem 0.5rem !important; /* px-2 py-1 */
            font-size: 0.75rem !important; /* text-xs */
            background-color: #2563eb !important;
            color: #ffffff !important; /* White text */
            border-radius: 0.375rem !important; /* rounded-md */
            transition: background-color 0.2s ease;
        }
        #modalPreviewFindPrevBtn:hover,
        #modalPreviewFindNextBtn:hover {
            background-color: #3182ce !important; /* Blue-600 */
        }

        /* Styles for WET4, EN, FR buttons in modal header */
        #modalWetGcdsToggleBtn,
        #modalLangEnBtn, /* Apply to both EN and FR buttons */
        #modalLangFrBtn {
            padding: 0.3rem 0.6rem; /* Reduced padding */
            font-size: 0.75rem; /* Smaller font size */
        }
        /* EN/FR active state */
        #modalLangEnBtn.active,
        #modalLangFrBtn.active {
            background-color: #2563eb !important; /* Indigo-600 for active state */
            color: white !important;
            border-color: #2563eb !important;
        }

        /* EN/FR hover state */
        #modalLangEnBtn:hover,
        #modalLangFrBtn:hover {
            background-color: #3182ce !important; /* Blue-600 */
        }

        /* "X" Close Button styling */
        #closePreviewModalBtn {
            background-color: transparent; /* Make it transparent by default */
            color: #cbd5e0; /* Lighter gray for the X symbol */
            border: none;
            transition: background-color 0.2s ease, color 0.2s ease;
            cursor: pointer;
            border-radius: 50%; /* Make it round */
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2rem; /* w-8 */
            height: 2rem; /* h-8 */
            font-size: 1.5rem; /* text-2xl */
            font-weight: bold;
            line-height: none; /* Remove extra line height */
            padding: 0; /* Remove padding */
        }
        #closePreviewModalBtn:hover {
            background-color: rgba(255, 255, 255, 0.1); /* Subtle background on hover */
            color: #ffffff; /* White on hover */
        }

        /* Sidebar for validation controls */
        .sidebar-panel {
            flex-basis: 300px;
  flex-grow: 0;
  flex-shrink: 0;
  overflow-y: auto;
  overflow-x: hidden;
  min-height: 0;
  background-color: #2d3748;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
  border-radius: 0.75rem;
  padding: 1rem;
  display: flex;
  flex-direction: column;
  box-sizing: border-box;
        }
    </style>
</head>
<body>
    <!-- QA Wizard Title Header -->
    <header class="qa-wizard-header">
        <h1 class="text-left"><i class="fa-solid fa-clipboard-check"></i> BeforeYouPost™ - QA/Prototype Wizard</h1>
        <a href="/tbsweb-toolset/rich-content-wizard/" class="px-3 py-1 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 font-bold">Content Wizard</a>
        <a href="/tbsweb-toolset/table-wizard/" class="px-3 py-1 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 font-bold">Table Wizard</a>
        <a href="/tbsweb-toolset/qa-wizard/" class="px-3 py-1 text-sm text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 font-bold bg-gray-400 cursor-not-allowed opacity-60" disabled="">QA Wizard</a>
    </header>

    <!-- Main content area: Sidebar + Editor Panel -->
    <div class="main-content-area">
        

        <div class="code-panel">
            <div class="flex items-center mb-4 flex-wrap">
                <button id="previewBtn" class="px-4 py-2 text-base bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 font-bold">
                        <i class="fa-solid fa-eye"></i> View Preview
                    </button>
            <!-- Auto-Check Toggle -->
            <div class="ml-4 p-2 bg-slate-700 rounded-lg flex items-center gap-2">
                <label class="toggle-switch is-checked" for="toggleAutoCheckOnSwitch">
                    <input type="checkbox" id="toggleAutoCheckOnSwitch" checked>
                    <span class="toggle-switch-slider"></span>
                </label>
                <span class="toggle-switch-label text-white text-sm">Auto-Validate</span>
            </div>
            <!-- Validate Button -->
            <button id="validateNowBtn" class="ml-4 px-4 py-2 text-base bg-blue-700 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 font-bold" disabled>
               <i class="fa-solid fa-check-double"></i> Validate
            </button>
            </div>
            <!-- Removed the h2 "QA Wizard" from here -->
            <div class="flex items-center mb-4 flex-wrap">
                    <div class="inline-flex rounded-md shadow-sm" role="group">
                        <button id="copyCodeBtn" class="px-4 py-1 text-sm bg-zinc-700 text-white rounded-l-md hover:bg-zinc-600 focus:outline-none focus:ring-2 focus:ring-zinc-500 focus:ring-opacity-50 font-semibold">
                            Copy Code <i class="fa-solid fa-copy"></i>
                        </button>
                        <button id="clearAllBtn" class="px-4 py-1 text-sm bg-zinc-700 text-white rounded-r-md hover:bg-zinc-600 focus:outline-none focus:ring-2 focus:ring-zinc-500 focus:ring-opacity-50 font-semibold">
                            Clear All <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                    <div class="inline-flex rounded-md shadow-sm ml-4" role="group">
    <button id="undoBtn" class="px-4 py-1 text-sm bg-zinc-700 text-white rounded-l-md hover:bg-zinc-600 focus:outline-none focus:ring-2 focus:ring-zinc-500 focus:ring-opacity-50 font-semibold disabled:opacity-50 disabled:cursor-not-allowed" title="Undo">
        <i class="fas fa-undo"></i>
    </button>
    <button id="redoBtn" class="px-4 py-1 text-sm bg-zinc-700 text-white rounded-r-md hover:bg-zinc-600 focus:outline-none focus:ring-2 focus:ring-zinc-500 focus:ring-opacity-50 font-semibold disabled:opacity-50 disabled:cursor-not-allowed" title="Redo">
        <i class="fas fa-redo"></i>
    </button>
</div>
                    <div class="inline-flex rounded-md shadow-sm ml-4" role="group">
                        <button id="importHtmlBtn" class="px-3 py-1 text-sm bg-purple-700 text-white rounded-l-md hover:bg-purple-800 focus:outline-none focus:ring-2 focus:ring-purple-600 focus:ring-opacity-50 font-bold">Import HTML <i class="fa-solid fa-file-import"></i></button>
                        <button id="exportHtmlBtn" class="px-3 py-1 text-sm bg-red-700 text-white rounded-r-md hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-opacity-50 font-bold">Export HTML <i class="fa-solid fa-file-export"></i></button>
                        <input type="file" id="htmlFileInput" accept=".html" style="display: none;">
                    </div>
                    
                </div>

            <div id="monacoEditorContainer" class="flex-grow border border-slate-700 rounded-lg overflow-hidden"></div>

            <!-- Validation Results Section - Always visible at the bottom -->
            <div id="validationResultsContainer">
                <div id="validationResults" class="bg-gray-50 p-4 border border-gray-200 rounded-lg min-h-[50px] text-gray-700 text-sm leading-relaxed">
                    <p class="text-gray-500">Type HTML above to see validation results here.</p>
                </div>
            </div>
        </div>
        <!-- Right Sidebar for Validation Controls -->
        <div class="sidebar-panel">
            
            <h3 class="text-lg font-semibold text-white mb-4">Quick Formatting</h3>
            <div class="button-list">
                    <!-- Clean Spaces Toggle -->
                    <div class="toggle-switch-container">
                        <label class="toggle-switch is-checked" for="toggleCleanSpaces">
                            <input type="checkbox" id="toggleCleanSpaces" checked>
                            <span class="toggle-switch-slider"></span>
                        </label>
                        <span class="toggle-switch-label text-white text-sm">Clean Spaces</span>
                    </div>

                    <!-- Clean URLs Toggle -->
                    <div class="toggle-switch-container">
                        <label class="toggle-switch is-checked" for="toggleCleanUrls">
                            <input type="checkbox" id="toggleCleanUrls" checked>
                            <span class="toggle-switch-slider"></span>
                        </label>
                        <span class="toggle-switch-label text-white text-sm">Clean URLs</span>
                    </div>
                    
                    <!-- Set Time Tags Toggle -->
                    <div class="toggle-switch-container">
                        <label class="toggle-switch is-checked" for="toggleTimeTags">
                            <input type="checkbox" id="toggleTimeTags" checked>
                            <span class="toggle-switch-slider"></span>
                        </label>
                        <span class="toggle-switch-label text-white text-sm">Set Time Tags</span>
                    </div>

                    <!-- Fix FN ID's Toggle -->
                    <div class="toggle-switch-container">
                        <label class="toggle-switch is-checked" for="toggleFixFnIds">
                            <input type="checkbox" id="toggleFixFnIds" checked>
                            <span class="toggle-switch-slider"></span>
                        </label>
                        <span class="toggle-switch-label text-white text-sm">Fix FN ID's</span>
                    </div>
                </div>
            
            <button id="formatSelectedBtn" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 font-bold mb-2 mt-2">
                    Format
                </button>
            <button id="autoEncodeBtn" class="px-4 py-2 text-sm bg-red-700 text-white rounded-md hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-opacity-50  font-bold mb-2">
                    Auto-Encode
                </button>
                <button id="autoFormatBtn" class="px-4 py-2 text-sm bg-red-700 text-white rounded-md hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-opacity-50  font-bold mb-2">
                    Auto-Indent
                </button>
            <h3 class="text-lg font-semibold text-white mb-4 mt-4">Quick Insert</h3>
            <button id="colophonBtn" class="px-4 py-2 text-sm bg-slate-600 text-white hover:bg-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 rounded-md font-bold">Colophon</button>
        </div>
    </div>

    <!-- Preview Modal Structure -->
    <div id="previewModal" class="modal-overlay hidden">
        <div class="modal-content">
            <!-- "X" Close Button -->
            
            <button id="closePreviewModalBtn" class="absolute top-4 right-4">
                &times;
            </button>

            <!-- Header with Title and Language/Framework Toggles -->
            <div class="modal-header-controls">
                <h3 class="text-xl font-semibold text-white">Live Preview</h3>
                <div class="inline-flex space-x-1"> <!-- Removed ml-auto -->
                    <button id="modalWetGcdsToggleBtn" class="px-2 py-1 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 font-bold">WET4</button>
                    <button id="modalLangEnBtn" class="px-2 py-1 text-sm bg-gray-700 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 font-bold">EN</button>
                    <button id="modalLangFrBtn" class="px-2 py-1 text-sm bg-gray-700 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 font-bold">FR</button>
                    <button id="exportPrototypeBtn" class="px-2 py-1 text-sm bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 font-bold">Export Prototype</button>
                </div>
            </div>

            <!-- Customize Section in Modal -->
            <div class="customize-section">
                <div id="modalCustomizeHeader" class="customize-header">
                    <h3 class="text-lg font-semibold text-white">Customize</h3>
                    <svg id="modalCustomizeToggleIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-white">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </div>
                <div id="modalCustomizeContent" class="customize-content">
                    <div class="flex flex-col space-y-2 w-full mb-4">
                        <div class="flex flex-col items-start w-full">
                            <div class="button-group flex-wrap w-full">
                                <button id="modalToggleContainerBtn" class="bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">Custom Width</button>
                                <button id="modalToggleTitleBtn" class="bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">Hide Title</button>
                                <button id="modalToggleCssBtn" class="bg-gray-700 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">Disable CSS</button>
                            </div>
                        </div>
                    </div>
                    <div class="mb-4" id="modalH1TitleInputContainer">
                        <input type="text" id="modalH1TitleInput" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., My Custom ENG Title">
                    </div>
                    <div class="flex flex-col space-y-2 w-full">
                        <div class="flex flex-row flex-wrap justify-center sm:justify-start w-full mt-2 space-x-4">
                            <div class="flex flex-col items-start mt-2 sm:mt-0">
                                <span class="text-sm font-medium text-gray-200 mb-1">Byline:</span>
                                <div class="button-group individual-rounded-buttons flex-wrap justify-center sm:justify-start">
                                    <button id="modalNoneBylineBtn" class="bg-gray-700 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">None</button>
                                    <button id="modalEnglishBylineBtn" class="bg-gray-700 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">English</button>
                                    <button id="modalFrenchBylineBtn" class="bg-gray-700 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">French</button>
                                </div>
                            </div>
                            <div class="flex flex-col items-start">
                                <span class="text-sm font-medium text-gray-200 mb-1">Image source:</span>
                                <div class="button-group individual-rounded-buttons flex-wrap justify-center sm:justify-start">
                                    <button id="modalLocalImagesBtn" class="bg-gray-700 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">Local</button>
                                    <button id="modalPreviewImagesBtn" class="bg-gray-700 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50" title="Users MUST be on TBS network">Preview</button>
                                    <button id="modalToggleLiveImagesBtn" class="bg-gray-700 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">Live</button>
                                </div>
                            </div>
                            <div class="flex flex-col items-start mt-2 sm:mt-0">
                                <span class="text-sm font-medium text-gray-200 mb-1">URL source:</span>
                                <div class="button-group individual-rounded-buttons flex-wrap justify-center sm:justify-start">
                                    <button id="modalLocalUrlsBtn" class="bg-gray-700 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">Local</button>
                                    <button id="modalPreviewUrlsBtn" class="bg-gray-700 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50" title="Users MUST be on TBS network">Preview</button>
                                    <button id="modalToggleLiveUrlsBtn" class="bg-gray-700 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">Live</button>
                                </div>
                            </div>
                            <!-- New Breakpoint buttons -->
                            <div class="flex flex-col items-start mt-2 sm:mt-0">
                                <span class="text-sm font-medium text-gray-200 mb-1">Breakpoint:</span>
                                <div class="button-group individual-rounded-buttons flex-wrap justify-center sm:justify-start">
                                    <button id="modalBreakpointXsBtn" class="bg-gray-700 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">XS</button>
                                    <button id="modalBreakpointSmBtn" class="bg-gray-700 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">SM</button>
                                    <button id="modalBreakpointMdBtn" class="bg-gray-700 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">MD</button>
                                    <button id="modalBreakpointFullBtn" class="bg-gray-700 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">Full</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <iframe id="modalPreviewFrame" title="Live HTML Preview"></iframe>

            <!-- Search and Section/Headings Toggles (moved below iframe) -->
            <div class="mt-auto pt-4 flex flex-col space-y-2 w-full">
                <div class="flex items-center space-x-2 w-full flex-wrap">
                    <input type="text" id="modalPreviewSearchInput" placeholder="Find in preview..." class="px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 flex-grow">
                    <button id="modalPreviewFindPrevBtn" class="px-3 py-1 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 font-bold">Prev</button>
                    <button id="modalPreviewFindNextBtn" class="px-3 py-1 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 font-bold">Next</button>
                    <button id="modalToggleSectionsBtn" class="px-3 py-1 text-sm bg-gray-700 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 font-bold">Sections</button>
                    <button id="modalToggleHeadingsBtn" class="px-3 py-1 text-sm bg-gray-700 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 font-bold">Headings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Monaco Editor Loader -->
    <script>
    let editor;
    let htmlModel;
    let currentLineDecorations = []; // To manage Monaco decorations for line highlighting
    let currentEntityDecorations = []; // To manage Monaco decorations for entity highlighting

    // Get button references
    const autoEncodeBtn = document.getElementById('autoEncodeBtn');
    const autoFormatBtn = document.getElementById('autoFormatBtn');
    const copyCodeBtn = document.getElementById('copyCodeBtn');
    const importHtmlBtn = document.getElementById('importHtmlBtn');
    const exportHtmlBtn = document.getElementById('exportHtmlBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const htmlFileInput = document.getElementById('htmlFileInput');
    const validationResultsDiv = document.getElementById('validationResults');

    // Undo/Redo buttons
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');

    // New elements for Auto-Check feature
    const toggleAutoCheckOnSwitch = document.getElementById('toggleAutoCheckOnSwitch');
    const validateNowBtn = document.getElementById('validateNowBtn');
    let isAutoCheckEnabled = true; // Default to ON

    // New Preview button and modal elements
    const previewBtn = document.getElementById('previewBtn');
    const previewModal = document.getElementById('previewModal');
    const modalPreviewFrame = document.getElementById('modalPreviewFrame');
    const closePreviewModalBtn = document.getElementById('closePreviewModalBtn');
    const exportPrototypeBtn = document.getElementById('exportPrototypeBtn');

    // New Sidebar Buttons
    const formatSelectedBtn = document.getElementById('formatSelectedBtn');
    const colophonBtn = document.getElementById('colophonBtn');
    const toggleCleanSpaces = document.getElementById('toggleCleanSpaces');
    const toggleCleanUrls = document.getElementById('toggleCleanUrls');
    const toggleTimeTags = document.getElementById('toggleTimeTags');
    const toggleFixFnIds = document.getElementById('toggleFixFnIds');


    // All interactive buttons for disabling/enabling
    const allInteractiveButtons = [
        copyCodeBtn,
        importHtmlBtn,
        exportHtmlBtn,
        clearAllBtn,
        previewBtn,
        validateNowBtn,
        formatSelectedBtn,
        colophonBtn,
        autoEncodeBtn,
        autoFormatBtn,
        undoBtn, // Add undo/redo to the list
        redoBtn
    ];

    // Modal Preview Controls
    const modalCustomizeHeader = document.getElementById('modalCustomizeHeader');
    const modalCustomizeContent = document.getElementById('modalCustomizeContent');
    const modalCustomizeToggleIcon = document.getElementById('modalCustomizeToggleIcon');
    const modalToggleContainerBtn = document.getElementById('modalToggleContainerBtn');
    const modalToggleTitleBtn = document.getElementById('modalToggleTitleBtn');
    const modalToggleCssBtn = document.getElementById('modalToggleCssBtn');
    const modalH1TitleInput = document.getElementById('modalH1TitleInput');
    const modalH1TitleInputContainer = document.getElementById('modalH1TitleInputContainer');
    const modalNoneBylineBtn = document.getElementById('modalNoneBylineBtn');
    const modalEnglishBylineBtn = document.getElementById('modalEnglishBylineBtn');
    const modalFrenchBylineBtn = document.getElementById('modalFrenchBylineBtn');
    const modalLocalImagesBtn = document.getElementById('modalLocalImagesBtn');
    const modalPreviewImagesBtn = document.getElementById('modalPreviewImagesBtn');
    const modalToggleLiveImagesBtn = document.getElementById('modalToggleLiveImagesBtn');
    const modalLocalUrlsBtn = document.getElementById('modalLocalUrlsBtn');
    const modalPreviewUrlsBtn = document.getElementById('modalPreviewUrlsBtn');
    const modalToggleLiveUrlsBtn = document.getElementById('modalToggleLiveUrlsBtn');
    const modalPreviewSearchInput = document.getElementById('modalPreviewSearchInput');
    const modalPreviewFindPrevBtn = document.getElementById('modalPreviewFindPrevBtn');
    const modalPreviewFindNextBtn = document.getElementById('modalPreviewFindNextBtn');
    const modalToggleSectionsBtn = document.getElementById('modalToggleSectionsBtn');
    const modalToggleHeadingsBtn = document.getElementById('modalToggleHeadingsBtn');
    const modalWetGcdsToggleBtn = document.getElementById('modalWetGcdsToggleBtn');
    const modalLangEnBtn = document.getElementById('modalLangEnBtn');
    const modalLangFrBtn = document.getElementById('modalLangFrBtn');
    const modalBreakpointXsBtn = document.getElementById('modalBreakpointXsBtn');
    const modalBreakpointSmBtn = document.getElementById('modalBreakpointSmBtn');
    const modalBreakpointMdBtn = document.getElementById('modalBreakpointMdBtn');
    const modalBreakpointFullBtn = document.getElementById('modalBreakpointFullBtn');


    // State variables for Preview Modal
    let modalShowSections = false;
    let modalShowHeadings = false;
    let modalUseContainerDiv = true;
    let modalShowTitle = true;
    let modalImageSourceMode = 'local';
    let modalBylineMode = 'none';
    let modalIsCustomizeExpanded = false;
    let modalEnableCss = true;
    let modalUrlSourceMode = 'local';
    let modalCurrentLanguage = 'en';
    let modalCurrentFramework = 'wet';
    let modalH1TitleEn = '';
    let modalH1TitleFr = '';
    let modalLastSearchTerm = '';
    let modalCurrentBreakpoint = 'full';

    const NBSP_PLACEHOLDER = '&#160;';

    // Sets of elements for HTML validation
    const selfClosingTags = new Set(['area','base','br','col','embed','hr','img','input','link','meta','param','source','track','wbr']);
    const deprecatedTags = new Set(['acronym','applet','basefont','big','center','dir','font','frame','frameset','noframes','strike','tt','u']);
    const blockElements = new Set(['address','article','aside','blockquote','canvas','dd','div','dl','dt','fieldset','figcaption','figure','footer','form','h1','h2','h3','h4','h5','h6','header','hr','li','main','nav','noscript','ol','p','pre','section','table','tfoot','ul','video']);
    const inlineElements = new Set(['a','abbr','b','bdo','br','button','cite','code','dfn','em','i','img','input','kbd','label','map','object','q','samp','script','select','small','span','strong','sub','sup','textarea','time','var']);
    const mediaSizingElements = new Set(['img','iframe','video','canvas','object','embed']);
    const targetValidElements = new Set(['a', 'form']);
    const ignoredTags = new Set(['doc']);
    
    /**
     * Replaces all forms of non-breaking spaces with a single, unique placeholder.
     * @param {string} htmlString - The HTML string to process.
     * @returns {string} The HTML string with NBSP replaced by placeholders.
     */
    function applyNBSPPlaceholders(htmlString) {
        let processedString = htmlString;
        processedString = processedString.replace(/&nbsp;|&#160;|\u00A0/g, NBSP_PLACEHOLDER);
        return processedString;
    }

    /**
     * Reverts the unique placeholder back to the numeric HTML entity for non-breaking space.
     * @param {string} htmlString - The HTML string with NBSP placeholders.
     * @returns {string} The HTML string with original NBSP entities restored.
     */
    function revertNBSPPlaceholders(htmlString) {
        let processedString = htmlString;
        processedString = processedString.replace(new RegExp(NBSP_PLACEHOLDER, 'g'), '&#160;');
        return processedString;
    }
    
    /**
     * Applies URL cleaning to HTML content.
     * @param {string} htmlString - The HTML content to clean.
     * @returns {string} The cleaned HTML content.
     */
    function applyUrlCleaning(htmlString) {
        const parser = new DOMParser();
        const tempDiv = parser.parseFromString(htmlString, 'text/html').body;
        const urlMappings = [{'old':'https://canada-preview.adobecqms.net/en/treasury-board-secretariat','new':'/content/canadasite/en/treasury-board-secretariat'},{'old':'https://canada-preview.adobecqms.net/fr/secretariat-conseil-tresor','new':'/content/canadasite/fr/secretariat-conseil-tresor'},{'old':'https://canada-preview.adobecqms.net/en/government','new':'/content/canadasite/en/government'},{'old':'https://canada-preview.adobecqms.net/fr/gouvernement','new':'/content/canadasite/fr/gouvernement'},{'old':'https://www.canada.ca/en/treasury-board-secretariat','new':'/content/canadasite/en/treasury-board-secretariat'},{'old':'https://www.canada.ca/fr/secretariat-conseil-tresor','new':'/content/canadasite/fr/secretaria-conseil-tresor'},{'old':'https://www.canada.ca/en/government','new':'/content/canadasite/en/government'},{'old':'https://www.canada.ca/fr/gouvernement','new':'/content/canadasite/fr/gouvernement'}];
        const prependPatterns = ['/en/treasury-board-secretariat','en/treasury-board-secretariat','/fr/secretariat-conseil-tresor','fr/secretariat-conseil-tresor','/en/government','en/government','/fr/gouvernement','fr/gouvernement'];
        const aElements = tempDiv.querySelectorAll('a');
        aElements.forEach(a=>{let href=a.getAttribute('href');const name=a.getAttribute('name');if(name&&!href){const parent=a.parentNode;if(parent){while(a.firstChild){parent.insertBefore(a.firstChild,a)}parent.removeChild(a)}return}
        if(href){if(href.startsWith('https://can01.safelinks.protection.outlook.com')){try{const urlObj=new URL(href);const actualUrlParam=urlObj.searchParams.get('url');if(actualUrlParam){href=decodeURIComponent(actualUrlParam);a.setAttribute('href',href)}}catch(e){console.error("Error parsing Outlook Safelink URL:",e)}}
        let prepended=false;for(const pattern of prependPatterns){if(href.startsWith(pattern)){if(href.startsWith('/')){href='/content/canadasite'+href}else{href='/content/canadasite/'+href}a.setAttribute('href',href);prepended=true;break}}
        if(prepended){if(a.hasAttribute('target'))a.removeAttribute('target');if(a.hasAttribute('rel'))a.removeAttribute('rel');return}
        if(href.includes('/content/canadasite')||href.includes('/content/dam')){const contentPath=href.includes('/content/canadasite')?'/content/canadasite':'/content/dam';const contentIndex=href.indexOf(contentPath);if(contentIndex!==0){href=href.substring(contentIndex)}a.setAttribute('href',href)}else{for(const mapping of urlMappings){if(href.startsWith(mapping.old)){href=href.replace(mapping.old,mapping.new);a.setAttribute('href',href);break}}}}
        if(a.hasAttribute('target'))a.removeAttribute('target');if(a.hasAttribute('rel'))a.removeAttribute('rel')});
        const imgElements=tempDiv.querySelectorAll('img');imgElements.forEach(img=>{let src=img.getAttribute('src');if(src&&src.includes('/content/dam')){const contentDamIndex=src.indexOf('/content/dam');if(contentDamIndex!==0){src=src.substring(contentDamIndex);img.setAttribute('src',src)}}
        if(img.hasAttribute('target'))img.removeAttribute('target');if(img.hasAttribute('rel'))img.removeAttribute('rel')});
        return tempDiv.innerHTML;
    }

    /**
     * Applies auto-spacing and cleans multiple <br> tags in HTML content.
     * @param {string} htmlString - The HTML content to clean.
     * @returns {string} The cleaned HTML content.
     */
    function applyAutoSpacing(htmlString) {
        const parser = new DOMParser();
        let doc = parser.parseFromString(htmlString, 'text/html');
        const body = doc.body;
        const elementsToUnwrap=Array.from(body.querySelectorAll('div, span'));elementsToUnwrap.forEach(element=>{if(element.attributes.length===0){const parent=element.parentNode;if(parent){while(element.firstChild){parent.insertBefore(element.firstChild,element)}parent.removeChild(element)}}});
        const spacerunSpans=body.querySelectorAll('span[style*="mso-spacerun: yes"]');spacerunSpans.forEach(span=>{const parent=span.parentNode;if(parent){if(span.textContent.includes(' ')){parent.replaceChild(doc.createTextNode(' '),span)}else{parent.removeChild(span)}}});
        const walker=doc.createTreeWalker(body,NodeFilter.SHOW_TEXT,{acceptNode:function(node){const txt=node.nodeValue;if(txt.trim()===''&&(txt.length>1||/[\r\n\t]/.test(txt))){return NodeFilter.FILTER_ACCEPT}return NodeFilter.FILTER_REJECT}},false);
        const nodesToRemove=[];let currentNode;while(currentNode=walker.nextNode()){nodesToRemove.push(currentNode)}
        nodesToRemove.forEach(node=>{if(node.parentNode){node.parentNode.removeChild(node)}});
        let cleanedHtml=body.innerHTML;cleanedHtml=cleanedHtml.replace(/(?:&#160;|\u00A0|&nbsp;){2,}/gi,'&#160;');cleanedHtml=cleanedHtml.replace(/\s+(&#160;|\u00A0|&nbsp;)/gi,'&#160;');cleanedHtml=cleanedHtml.replace(/(&#160;|\u00A0|&nbsp;)\s+/gi,'&#160;');cleanedHtml=cleanedHtml.replace(/(<br\s*\/?>\s*){2,}/gi,'</p><p>');cleanedHtml=cleanedHtml.replace(/<br\s+clear=["']?(all|ALL)["']?\s*\/?>/gi,'');
        doc.body.innerHTML=cleanedHtml;const finalBody=doc.body;
        const elementsToCheckForEmptiness=Array.from(finalBody.querySelectorAll('p, li, div, span, strong, em, u, b, i, section'));for(let i=elementsToCheckForEmptiness.length-1;i>=0;i--){const element=elementsToCheckForEmptiness[i];const tagName=element.tagName.toLowerCase();const trimmedContent=element.innerHTML.trim();const containsOnlyNBSP=(trimmedContent==='&#160;'||trimmedContent==='&nbsp;'||trimmedContent==='\u00A0');const containsOnlySpace=(trimmedContent===' ');
        if(tagName==='p'){const isInsideTable=element.closest('table');if(!isInsideTable&&(trimmedContent===''||containsOnlyNBSP)){if(element.parentNode)element.parentNode.removeChild(element)}else if(!isInsideTable&&containsOnlySpace){if(element.parentNode)element.parentNode.replaceChild(doc.createTextNode(' '),element)}}else{if(['div','span','section'].includes(tagName)&&element.attributes.length>0){continue}
        if(element.textContent===' '&&['strong','em','u','b','i'].includes(tagName)){element.parentNode.replaceChild(doc.createTextNode(' '),element);continue}
        if(trimmedContent===''||containsOnlyNBSP){if(element.parentNode)element.parentNode.removeChild(element)}else if(containsOnlySpace){if(element.parentNode)element.parentNode.replaceChild(doc.createTextNode(' '),element)}}}
        const elementsToTrim=finalBody.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li');elementsToTrim.forEach(element=>{let currentHtml=element.innerHTML;currentHtml=currentHtml.replace(/^(?:&nbsp;|\s|&#160;|\u00A0)+/,'');currentHtml=currentHtml.replace(/(?:&nbsp;|\s|&#160;|\u00A0)+$/,'');element.innerHTML=currentHtml});
        return finalBody.innerHTML;
    }

    /**
     * Applies time tagging to dates found in the HTML content.
     * @param {string} htmlContent - The HTML content to process.
     * @returns {string} The processed HTML content with <time> tags.
     */
    function applyTimeTagging(htmlContent) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlContent, 'text/html');
        const body = doc.body;
        body.querySelectorAll('time').forEach(timeEl => {
            const parent = timeEl.parentNode;
            if (parent) {
                while (timeEl.firstChild) {
                    parent.insertBefore(timeEl.firstChild, timeEl);
                }
                parent.removeChild(timeEl);
            }
        });
        const walker = doc.createTreeWalker(body, NodeFilter.SHOW_TEXT, {
            acceptNode: function(node) {
                const parentTag = node.parentNode.tagName.toLowerCase();
                if (['script', 'style', 'time'].includes(parentTag)) {
                    return NodeFilter.FILTER_REJECT;
                }
                return NodeFilter.FILTER_ACCEPT;
            }
        }, false);
        const textNodes = [];
        let currentNode;
        while (currentNode = walker.nextNode()) {
            textNodes.push(currentNode);
        }
        const monthMap = {'january':'01','jan':'01','janvier':'01','february':'02','feb':'02','février':'02','march':'03','mar':'03','mars':'03','april':'04','apr':'04','avril':'04','may':'05','mai':'05','june':'06','jun':'06','juin':'06','july':'07','jul':'07','juillet':'07','august':'08','aug':'08','août':'08','september':'09','sep':'09','septembre':'09','october':'10','oct':'10','octobre':'10','november':'11','nov':'11','novembre':'11','december':'12','dec':'12','décembre':'12'};
        function getMonthNumber(monthName){return monthMap[monthName.toLowerCase()]||null}
        const sortedMonthKeys=Object.keys(monthMap).sort((a,b)=>b.length-a.length);
        const monthPattern=sortedMonthKeys.map(m=>m.replace(/[-\/\\^$*+?.()|[\]{}]/g,'\\$&')).join('|');
        const spaceOrNBSPChar=`(?:\\s|${NBSP_PLACEHOLDER})+`;
        const daySuffixPattern='(?:<sup>er<\\/sup>|<sup>st<\\/sup>|<sup>nd<\\/sup>|<sup>rd<\\/sup>|<sup>th<\\/sup>|er|st|nd|rd|th)?';
        const regexIsoDateFull=/(?<!\d)(\d{4}-(?:0[1-9]|1[0-2])-(?:0[1-9]|[12]\d|3[01]))(?!\d)/g;
        const regexMonthDayYear=new RegExp(`(?<!\\d)\\b(${monthPattern})\\b${spaceOrNBSPChar}(\\d{1,2}${daySuffixPattern})\\s*,?${spaceOrNBSPChar}(\\d{4})(?!\\d)`,'gi');
        const regexDayMonthYear=new RegExp(`(?<!\\d)(?:(?:le|the)${spaceOrNBSPChar})?(\\d{1,2}${daySuffixPattern})${spaceOrNBSPChar}\\b(${monthPattern})\\b\\s*,?${spaceOrNBSPChar}(\\d{4})(?!\\d)`,'gi');
        const regexMonthYear=new RegExp(`(?<!\\d)\\b(${monthPattern})\\b${spaceOrNBSPChar}(\\d{4})(?!\\d|(?:${spaceOrNBSPChar}\\d{1,2}))`,'gi');
        const regexMonthDayNoYear=new RegExp(`(?<!\\d)\\b(${monthPattern})\\b${spaceOrNBSPChar}(\\d{1,2}${daySuffixPattern})(?!\\d|(?:${spaceOrNBSPChar}\\d{4}))(?!-)`,'gi');
        const regexDayMonthNoYear=new RegExp(`(?<!\\d)(?:(?:le|the)${spaceOrNBSPChar})?(\\d{1,2}${daySuffixPattern})${spaceOrNBSPChar}\\b(${monthPattern})\\b(?!\d|(?:${spaceOrNBSPChar}\\d{4}))(?!-)`,'gi');
        const patternsToTest=[{name:'IsoDateFull',regex:regexIsoDateFull,handler:(match)=>match[1],priority:3},{name:'MonthDayYear',regex:regexMonthDayYear,handler:(match)=>{const[,month,dayPart,year]=match;const monthNum=getMonthNumber(month);let cleanDay=dayPart.replace(/(?:<sup>er<\/sup>|<sup>st<\/sup>|<sup>nd<\/sup>|<sup>rd<\/sup>|<sup>th<\/sup>|er|st|nd|rd|th)/gi,'').trim();const parsedDay=parseInt(cleanDay);if(!monthNum||isNaN(parsedDay)||parsedDay<1||parsedDay>31)return null;return`${year}-${monthNum}-${String(parsedDay).padStart(2,'0')}`},priority:2},{name:'DayMonthYear',regex:regexDayMonthYear,handler:(match)=>{const[,dayPart,month,year]=match;const monthNum=getMonthNumber(month);let cleanDay=dayPart.replace(/(?:<sup>er<\/sup>|<sup>st<\/sup>|<sup>nd<\/sup>|<sup>rd<\/sup>|<sup>th<\/sup>|er|st|nd|rd|th)/gi,'').trim();const parsedDay=parseInt(cleanDay);if(!monthNum||isNaN(parsedDay)||parsedDay<1||parsedDay>31)return null;return`${year}-${monthNum}-${String(parsedDay).padStart(2,'0')}`},priority:2},{name:'MonthYear',regex:regexMonthYear,handler:(match)=>{const[,month,year]=match;const monthNum=getMonthNumber(month);if(!monthNum)return null;return`${year}-${monthNum}`},priority:2},{name:'MonthDayNoYear',regex:regexMonthDayNoYear,handler:(match)=>{const[,month,dayPart]=match;const monthNum=getMonthNumber(month);let cleanDay=dayPart.replace(/(?:<sup>er<\/sup>|<sup>st<\/sup>|<sup>nd<\/sup>|<sup>rd<\/sup>|<sup>th<\/sup>|er|st|nd|rd|th)/gi,'').trim();const parsedDay=parseInt(cleanDay);if(!monthNum||isNaN(parsedDay)||parsedDay<1||parsedDay>31)return null;return`${monthNum}-${String(parsedDay).padStart(2,'0')}`},priority:1},{name:'DayMonthNoYear',regex:regexDayMonthNoYear,handler:(match)=>{const[,dayPart,month]=match;const monthNum=getMonthNumber(month);let cleanDay=dayPart.replace(/(?:<sup>er<\/sup>|<sup>st<\/sup>|<sup>nd<\/sup>|<sup>rd<\/sup>|<sup>th<\/sup>|er|st|nd|rd|th)/gi,'').trim();const parsedDay=parseInt(cleanDay);if(!monthNum||isNaN(parsedDay)||parsedDay<1||parsedDay>31)return null;return`${monthNum}-${String(parsedDay).padStart(2,'0')}`},priority:1}];
        for(let i=textNodes.length-1;i>=0;i--){const node=textNodes[i];const text=node.nodeValue;let allMatchesInNode=[];patternsToTest.forEach(pattern=>{let localRegex=new RegExp(pattern.regex.source,'gi');let match;while((match=localRegex.exec(text))!==null){const datetimeValue=pattern.handler(match);if(datetimeValue){allMatchesInNode.push({start:match.index,end:match.index+match[0].length,original:match[0],datetime:datetimeValue,priority:pattern.priority})}}});if(allMatchesInNode.length===0)continue;allMatchesInNode.sort((a,b)=>{if(a.start!==b.start)return a.start-b.start;if(a.original.length!==b.original.length)return b.original.length-a.original.length;return b.priority-a.priority});let nonOverlappingMatches=[];if(allMatchesInNode.length>0){nonOverlappingMatches.push(allMatchesInNode[0]);for(let j=1;j<allMatchesInNode.length;j++){const currentMatch=allMatchesInNode[j];const lastAddedMatch=nonOverlappingMatches[nonOverlappingMatches.length-1];if(currentMatch.start>=lastAddedMatch.end){nonOverlappingMatches.push(currentMatch)}}}
        if(nonOverlappingMatches.length>0){const parent=node.parentNode;const fragment=doc.createDocumentFragment();let lastIndex=0;nonOverlappingMatches.forEach(match=>{if(match.start>lastIndex){fragment.appendChild(doc.createTextNode(text.substring(lastIndex,match.start)))}
        const timeEl=doc.createElement('time');timeEl.className='nowrap';timeEl.setAttribute('datetime',match.datetime);const tempDiv=doc.createElement('div');tempDiv.innerHTML=match.original;while(tempDiv.firstChild){timeEl.appendChild(tempDiv.firstChild)}
        fragment.appendChild(timeEl);lastIndex=match.end});if(lastIndex<text.length){fragment.appendChild(doc.createTextNode(text.substring(lastIndex)))}
        if(parent){parent.replaceChild(fragment,node)}}}
        return body.innerHTML;
    }

    /**
     * Fixes footnote IDs and their corresponding anchor links.
     * @param {string} htmlContent - The HTML content to process.
     * @returns {string} The processed HTML with fixed footnote IDs.
     */
    function applyFixFnIds(htmlContent) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlContent, 'text/html');
        const baseIdToSupElements = new Map();
        doc.querySelectorAll('sup[id$="-rf"]').forEach(sup => {
            const baseId = sup.id.replace(/-rf$/, '');
            if (!baseIdToSupElements.has(baseId)) baseIdToSupElements.set(baseId, []);
            baseIdToSupElements.get(baseId).push(sup);
        });
        const idMapping = {};
        for (const [baseId, supList] of baseIdToSupElements.entries()) {
            let canonicalTargetId = supList[0].id;
            if (supList.length > 1) {
                canonicalTargetId = `${baseId}-rf-0`;
                supList.forEach((sup, index) => sup.id = `${baseId}-rf-${index}`);
            }
            supList.forEach(sup => idMapping[sup.id] = canonicalTargetId);
            if (supList.length > 1) idMapping[`${baseId}-rf`] = canonicalTargetId;
        }
        doc.querySelectorAll('a[href^="#"]').forEach(link => {
            const anchor = link.getAttribute('href').substring(1);
            if (idMapping.hasOwnProperty(anchor)) link.setAttribute('href', `#${idMapping[anchor]}`);
        });
        return doc.body.innerHTML;
    }

    function isBlockElement(tagName) {
        return blockElements.has(tagName);
    }

    function isInlineElement(tagName) {
        return inlineElements.has(tagName);
    }

    function isWithinAnyRange(index, ranges) {
        for (const range of ranges) {
            if (index >= range.start && index <= range.end) {
                return true;
            }
        }
        return false;
    }

    function isStartOfValidTag(index, tagRanges) {
        for (const range of tagRanges) {
            if (index === range.start) {
                return true;
            }
        }
        return false;
    }

    function isEndOfValidTag(index, tagRanges) {
        for (const range of tagRanges) {
            if (index === range.end) {
                return true;
            }
        }
        return false;
    }

    /**
     * Debounce function to limit how often a function is called.
     * @param {Function} func - The function to debounce.
     * @param {number} delay - The delay in milliseconds.
     * @returns {Function} The debounced function.
     */
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    /**
     * Highlights HTML entities in the Monaco editor.
     */
    function highlightHtmlEntities() {
        const model = editor.getModel();
        const text = model.getValue();
        const entityRegex = /&[a-zA-Z]+;|&#[0-9]+;|&#x[0-9a-fA-F]+;/g;
        let match;
        const newDecorations = [];

        while ((match = entityRegex.exec(text)) !== null) {
            const startPosition = model.getPositionAt(match.index);
            const endPosition = model.getPositionAt(match.index + match[0].length);
            newDecorations.push({
                range: new monaco.Range(startPosition.lineNumber, startPosition.column, endPosition.lineNumber, endPosition.column),
                options: {
                    inlineClassName: 'entity-highlight',
                    hoverMessage: { value: `HTML Entity: ${match[0]}` }
                }
            });
        }

        currentEntityDecorations = editor.deltaDecorations(currentEntityDecorations, newDecorations);
    }

    /**
     * Converts common character entities and named entities to their numeric HTML entity equivalents.
     * @param {string} htmlString - The HTML string to process.
     * @returns {string} The processed HTML string with numeric entities.
     */
    function convertAllEntitiesToNumeric(htmlString) {
        let xmlDeclaration = '';
        let contentToProcess = htmlString;
        let originalDocTagMatch = null;
        let originalDocTagName = '';
        let originalDocAttributes = '';

        const xmlDeclRegex = /^\s*(<\?xml[^>]*\?>)/i;
        const match = htmlString.match(xmlDeclRegex);

        if (match) {
            xmlDeclaration = match[1];
            contentToProcess = htmlString.substring(match[0].length);
        }

        const docTagRegex = /(<\s*doc\s*([^>]*)>)([\s\S]*?)(<\/\s*doc\s*>)/i;
        originalDocTagMatch = contentToProcess.match(docTagRegex);

        if (originalDocTagMatch) {
            originalDocTagName = originalDocTagMatch[1];
            originalDocAttributes = originalDocTagMatch[2];
        }

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = contentToProcess;

        const walker = document.createTreeWalker(
            tempDiv,
            NodeFilter.SHOW_TEXT,
            {
                acceptNode: function(textNode) {
                    let parent = textNode.parentNode;
                    while (parent) {
                        const tagName = parent.tagName ? parent.tagName.toLowerCase() : '';
                        if (tagName === 'script' || tagName === 'style' || tagName === 'time') {
                            return NodeFilter.FILTER_REJECT;
                        }
                        parent = parent.parentNode;
                    }
                    return NodeFilter.FILTER_ACCEPT;
                }
            },
            false
        );

        let currentNode;
        const textNodesToProcess = [];
        while (currentNode = walker.nextNode()) {
            textNodesToProcess.push(currentNode);
        }

        textNodesToProcess.forEach(textNode => {
            let text = textNode.nodeValue;
            text = text.replace(/’/g, '&#8217;');
            text = text.replace(/&rsquo;/g, '&#8217;');
            text = text.replace(/“/g, '&#8220;');
            text = text.replace(/&ldquo;/g, '&#8220;');
            text = text.replace(/”/g, '&#8221;');
            text = text.replace(/&rdquo;/g, '&#8221;');
            text = text.replace(/«/g, '&#171;');
            text = text.replace(/&laquo;/g, '&#171;');
            text = text.replace(/»/g, '&#187;');
            text = text.replace(/&raquo;/g, '&#187;');
            text = text.replace(/\u00A0/g, '&#160;');
            text = text.replace(/&nbsp;/g, '&#160;');
            textNode.nodeValue = text;
        });

        let processedHtml = tempDiv.innerHTML;
        processedHtml = processedHtml.replace(/&nbsp;/g, '&#160;');
        processedHtml = processedHtml.replace(/&rsquo;/g, '&#8217;');
        processedHtml = processedHtml.replace(/&ldquo;/g, '&#8220;');
        processedHtml = processedHtml.replace(/&rdquo;/g, '&#8221;');
        processedHtml = processedHtml.replace(/&laquo;/g, '&#171;');
        processedHtml = processedHtml.replace(/&raquo;/g, '&#187;');
        processedHtml = processedHtml.replace(/&amp;#(\d+);/g, '&#$1;');

        if (originalDocTagMatch) {
            const lowercasedDocTagRegex = /(<\s*doc\s*)([^>]*)>/i;
            const lowercasedMatch = processedHtml.match(lowercasedDocTagRegex);

            if (lowercasedMatch && lowercasedMatch[2] && lowercasedMatch[2].length > 0) {
                const replacementTag = `<doc ${originalDocAttributes}>`;
                processedHtml = processedHtml.replace(lowercasedDocTagRegex, replacementTag);
            } else {
                processedHtml = processedHtml.replace(/(<\s*doc\s*>)/i, originalDocTagName);
            }
        }
        return xmlDeclaration + processedHtml;
    }

    /**
     * Validates HTML content.
     * @param {string} fullHtmlCode - The full HTML code from the editor.
     */
    async function validateHtmlContent(fullHtmlCode) {
        const validationResultsDiv = document.getElementById('validationResults');
        let htmlCodeToValidate = fullHtmlCode;
        let bodyContentOffsetIndex = 0;

        const bodyMatch = fullHtmlCode.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
        if (bodyMatch && bodyMatch[1]) {
            htmlCodeToValidate = bodyMatch[1];
            bodyContentOffsetIndex = fullHtmlCode.indexOf(bodyMatch[1], bodyMatch.index);
        } else {
            htmlCodeToValidate = fullHtmlCode;
            bodyContentOffsetIndex = 0;
        }

        const errors = [];
        currentLineDecorations = editor.deltaDecorations(currentLineDecorations, []);

        validationResultsDiv.classList.remove('bg-green-100', 'text-green-800', 'border-green-300', 'bg-red-100', 'text-red-800', 'border-red-300');
        validationResultsDiv.classList.add('bg-gray-50', 'text-gray-700', 'border-gray-200');
        validationResultsDiv.innerHTML = '<p class="text-gray-500 text-center">Validating HTML... please wait.</p>';
        await new Promise(resolve => setTimeout(resolve, 50));

        try {
            const parser = new DOMParser();
            let isXmlLikeDoc = false;
            const trimmedCode = fullHtmlCode.trim();
            if (trimmedCode.startsWith('<?xml')) {
                const docWrapperRegex = /^\s*<\?xml[^>]*\?>\s*<doc[^>]*>[\s\S]*<\/doc>\s*$/i;
                if (docWrapperRegex.test(trimmedCode)) {
                    isXmlLikeDoc = true;
                }
            }

            if (isXmlLikeDoc) {
                const namedEntityRegex = /&([a-zA-Z]+);/g;
                if (namedEntityRegex.test(fullHtmlCode)) {
                    errors.push({
                        message: `XML Encoding Error: Named HTML entities are present. Convert to numerical entities.`,
                        lineNumber: 'N/A'
                    });
                }
            }

            const tempDoc = parser.parseFromString(htmlCodeToValidate, 'text/html');
            const validAnchors = new Set();
            tempDoc.querySelectorAll('[id]').forEach(el => {
                if (el.id) validAnchors.add(el.id);
            });
            tempDoc.querySelectorAll('[name]').forEach(el => {
                const nameAttr = el.getAttribute('name');
                if (nameAttr) validAnchors.add(nameAttr);
            });

            const idRegex = /\bid\s*=\s*(["'])(.*?)\1/g;
            const foundIds = new Map();
            let idMatch;
            while ((idMatch = idRegex.exec(htmlCodeToValidate)) !== null) {
                const idValue = idMatch[2];
                const absoluteIndex = bodyContentOffsetIndex + idMatch.index;
                const idLineNumber = editor.getModel().getPositionAt(absoluteIndex).lineNumber;
                const idInfo = { lineNumber: idLineNumber, index: absoluteIndex };
                if (foundIds.has(idValue)) {
                    foundIds.get(idValue).push(idInfo);
                } else {
                    foundIds.set(idValue, [idInfo]);
                }
            }
            for (const [idValue, idInfos] of foundIds.entries()) {
                if (idInfos.length > 1) {
                    errors.push({
                        message: `Duplicate ID: "${idValue}" found on lines: ${idInfos.map(info => info.lineNumber).join(', ')}.`,
                        lineNumber: idInfos[0].lineNumber
                    });
                }
            }

            const liElements = tempDoc.querySelectorAll('li');
            liElements.forEach(li => {
                if (li.parentNode && li.parentNode.tagName.toLowerCase() === 'li') {
                    const liOuterHtml = li.outerHTML;
                    let liIndexInBodyContent = htmlCodeToValidate.indexOf(liOuterHtml);
                    if (liIndexInBodyContent !== -1) {
                        const absoluteLiIndex = bodyContentOffsetIndex + liIndexInBodyContent;
                        const liLineNumber = editor.getModel().getPositionAt(absoluteLiIndex).lineNumber;
                        errors.push({
                            message: `Line ${liLineNumber}: Improper list nesting: &lt;li&gt; cannot be directly nested within another &lt;li&gt;. It must be inside a &lt;ul&gt; or &lt;ol&gt;.`,
                            lineNumber: liLineNumber
                        });
                    }
                }
            });

            const tagBoundaries = [];
            const fullTagAndPIRegex = /<\/?[\w-]+(?:\s+[^>]*?)?>|<\?[\s\S]*?\?>/g;
            let tagMatchForBoundaries;
            while ((tagMatchForBoundaries = fullTagAndPIRegex.exec(htmlCodeToValidate)) !== null) {
                tagBoundaries.push({
                    start: tagMatchForBoundaries.index,
                    end: tagMatchForBoundaries.index + tagMatchForBoundaries[0].length - 1
                });
            }

            const entityBoundaries = [];
            const entityRegex = /&(?:[a-zA-Z]+|#\d+);/g;
            let entityMatch;
            while ((entityMatch = entityRegex.exec(htmlCodeToValidate)) !== null) {
                entityBoundaries.push({ start: entityMatch.index, end: entityMatch.index + entityMatch[0].length - 1 });
            }

            const commentBoundaries = [];
            const commentRegex = /\<!--[\s\S]*?-->/g;
            let commentMatch;
            while ((commentMatch = commentRegex.exec(htmlCodeToValidate)) !== null) {
                commentBoundaries.push({ start: commentMatch.index, end: commentMatch.index + commentMatch[0].length - 1 });
            }

            for (let i = 0; i < htmlCodeToValidate.length; i++) {
                const char = htmlCodeToValidate[i];
                const absoluteCharIndex = bodyContentOffsetIndex + i;
                const lineNumber = editor.getModel().getPositionAt(absoluteCharIndex).lineNumber;

                if (isWithinAnyRange(i, commentBoundaries)) continue;

                const piMatch = htmlCodeToValidate.substring(i).match(/^\<\?xml\s[\s\S]*?\?\>/i);
                if (piMatch && piMatch.index === 0) {
                    i += piMatch[0].length - 1;
                    continue;
                }

                if (char === '<' && !isStartOfValidTag(i, tagBoundaries) && !isWithinAnyRange(i, entityBoundaries)) {
                    let context = htmlCodeToValidate.substring(i, Math.min(i + 20, htmlCodeToValidate.length)).split('\n')[0].trim();
                    errors.push({ message: `Line ${lineNumber}: Orphan '<' found near: "${context}..."`, lineNumber: lineNumber });
                } else if (char === '>' && !isEndOfValidTag(i, tagBoundaries) && !isWithinAnyRange(i, entityBoundaries)) {
                    let contextStart = Math.max(0, i - 20);
                    let context = htmlCodeToValidate.substring(contextStart, i + 1).split('\n').pop().trim();
                    errors.push({ message: `Line ${lineNumber}: Orphan '>' found near: "...${context}"`, lineNumber: lineNumber });
                }
            }

            const tagRegexForValidation = /<\/?([a-zA-Z0-9]+)(\s+[^>]*?)?(\/?)>/g;
            const tagStack = [];
            let match;
            while ((match = tagRegexForValidation.exec(htmlCodeToValidate)) !== null) {
                const fullTag = match[0];
                const tagName = match[1].toLowerCase();
                const attributesString = (match[2] || '').trim();
                const isSelfClosingSyntax = match[3] === '/';
                const absoluteMatchIndex = bodyContentOffsetIndex + match.index;
                const lineNumber = editor.getModel().getPositionAt(absoluteMatchIndex).lineNumber;

                if (isWithinAnyRange(match.index, commentBoundaries)) continue;
                if (ignoredTags.has(tagName)) {
                    if (!fullTag.startsWith('</') && !isSelfClosingSyntax) {
                        tagStack.push({ tagName: tagName, lineNumber: lineNumber, ignored: true });
                    } else if (fullTag.startsWith('</')) {
                        let found = false;
                        for (let i = tagStack.length - 1; i >= 0; i--) {
                            if (tagStack[i].tagName === tagName && tagStack[i].ignored) {
                                tagStack.splice(i, 1);
                                found = true;
                                break;
                            }
                        }
                        if (!found) {
                            errors.push({ message: `Line ${lineNumber}: Unmatched closing tag: &lt;/${tagName}&gt; (Ignored tag).`, lineNumber: lineNumber });
                        }
                    }
                    continue;
                }

                if (fullTag.startsWith('</')) {
                    if (tagStack.length === 0) {
                        errors.push({ message: `Line ${lineNumber}: Unmatched closing tag: &lt;/${tagName}&gt;`, lineNumber: lineNumber });
                    } else {
                        const lastOpenTag = tagStack.pop();
                        if (lastOpenTag.tagName !== tagName) {
                            errors.push({ message: `Line ${lineNumber}: Mismatched closing tag: Expected &lt;/${lastOpenTag.tagName}&gt; (opened on line ${lastOpenTag.lineNumber}), but found &lt;/${tagName}&gt;.`, lineNumber: lineNumber });
                        }
                    }
                } else {
                    const parentTag = tagStack.length > 0 ? tagStack[tagStack.length - 1] : null;

                    if (tagName === 'chapter' && (!parentTag || parentTag.tagName !== 'chapters')) {
                        errors.push({ message: `Line ${lineNumber}: &lt;chapter&gt; tag must be directly nested within a &lt;chapters&gt; tag.`, lineNumber: lineNumber });
                    }
                    if (tagName === 'clause' && (!parentTag || parentTag.tagName !== 'clauses')) {
                        errors.push({ message: `Line ${lineNumber}: &lt;clause&gt; tag must be directly nested within a &lt;clauses&gt; tag.`, lineNumber: lineNumber });
                    }
                    if (tagName === 'appendix' && (!parentTag || (parentTag.tagName !== 'appendices' && parentTag.tagName !== 'appendix'))) {
                        errors.push({ message: `Line ${lineNumber}: &lt;appendix&gt; tag must be directly nested within an &lt;appendices&gt; tag or another &lt;appendix&gt; tag.`, lineNumber: lineNumber });
                    }
                    if (tagName === 'appendices' || tagName === 'appendix') {
                        for (let i = tagStack.length - 1; i >= 0; i--) {
                            const ancestorTag = tagStack[i];
                            if (ancestorTag.tagName === 'chapters' || ancestorTag.tagName === 'chapter') {
                                errors.push({ message: `Line ${lineNumber}: Invalid nesting: &lt;${tagName}&gt; cannot be nested within &lt;${ancestorTag.tagName}&gt; (opened on line ${ancestorTag.lineNumber}).`, lineNumber: lineNumber });
                                break;
                            }
                        }
                    }

                    if (isSelfClosingSyntax && !selfClosingTags.has(tagName)) {
                        errors.push({ message: `Line ${lineNumber}: Invalid self-closing syntax for &lt;${tagName}&gt;.`, lineNumber: lineNumber });
                    }
                    if (deprecatedTags.has(tagName)) {
                        errors.push({ message: `Line ${lineNumber}: Deprecated tag: &lt;${tagName}&gt;.`, lineNumber: lineNumber });
                    }
                    if (tagName === 'img') {
                        if (!/\balt\b/i.test(attributesString)) errors.push({ message: `Line ${lineNumber}: &lt;img&gt; tag is missing the required 'alt' attribute.`, lineNumber: lineNumber });
                        if (!/\bsrc\b/i.test(attributesString)) errors.push({ message: `Line ${lineNumber}: &lt;img&gt; tag is missing the required 'src' attribute.`, lineNumber: lineNumber });
                    } else if (tagName === 'th') {
                        if (!/\bscope\b/i.test(attributesString) && !/\bid\b/i.test(attributesString)) {
                            errors.push({ message: `Line ${lineNumber}: &lt;th&gt; tag should have either a 'scope' or an 'id' attribute.`, lineNumber: lineNumber });
                        }
                    } else if (tagName === 'tr') {
                        if (/\bcolspan\b/i.test(attributesString) || /\browspan\b/i.test(attributesString)) {
                            errors.push({ message: `Line ${lineNumber}: Invalid attribute: 'colspan' or 'rowspan' found on a &lt;tr&gt; tag.`, lineNumber: lineNumber });
                        }
                    }

                    if (/\balign\b/i.test(attributesString)) {
                        errors.push({ message: `Line ${lineNumber}: Deprecated attribute: 'align' found on &lt;${tagName}&gt;. Use CSS instead.`, lineNumber: lineNumber });
                    }
                    if ((/\bwidth\b/i.test(attributesString) || /\bheight\b/i.test(attributesString)) && !mediaSizingElements.has(tagName)) {
                        errors.push({ message: `Line ${lineNumber}: Improper attribute: 'width' or 'height' found on &lt;${tagName}&gt;. Use CSS for sizing.`, lineNumber: lineNumber });
                    }
                    if (/\btarget\b/i.test(attributesString) && !targetValidElements.has(tagName)) {
                        errors.push({ message: `Line ${lineNumber}: Improper attribute: 'target' found on &lt;${tagName}&gt;.`, lineNumber: lineNumber });
                    }

                    if (tagName === 'a') {
                        const hrefMatch = attributesString.match(/\bhref\s*=\s*(["'])(.*?)\1/i);
                        if (hrefMatch) {
                            const href = hrefMatch[2];
                            if (href.includes(' ') && !href.includes('%20')) {
                                errors.push({ message: `Line ${lineNumber}: Space found in href attribute of &lt;a&gt; tag. URL-encode spaces to '%20'.`, lineNumber: lineNumber });
                            }
                            if (href.startsWith('#') && href.length > 1) {
                                const anchorId = href.substring(1);
                                if (!validAnchors.has(anchorId)) {
                                    errors.push({ message: `Line ${lineNumber}: Broken anchor link: &lt;a href="#${anchorId}"&gt; points to a non-existent ID.`, lineNumber: lineNumber });
                                }
                            }
                        }
                    }

                    if (tagStack.length > 0) {
                        const parentTag = tagStack[tagStack.length - 1];
                        if (!parentTag.ignored && isInlineElement(parentTag.tagName) && isBlockElement(tagName)) {
                            errors.push({ message: `Line ${lineNumber}: Invalid nesting: Block element &lt;${tagName}&gt; inside inline element &lt;${parentTag.tagName}&gt; (opened on line ${parentTag.lineNumber}).`, lineNumber: lineNumber });
                        }
                    }

                    if (!selfClosingTags.has(tagName) && !isSelfClosingSyntax) {
                        tagStack.push({ tagName: tagName, lineNumber: lineNumber, index: absoluteMatchIndex });
                    }
                }
            }

            while (tagStack.length > 0) {
                const unclosedTag = tagStack.pop();
                if (!unclosedTag.ignored) {
                    errors.push({ message: `Line ${unclosedTag.lineNumber}: Unclosed tag: &lt;${unclosedTag.tagName}&gt;.`, lineNumber: unclosedTag.lineNumber });
                }
            }
            return isXmlLikeDoc;
        } catch (e) {
            console.error("Error during HTML validation:", e);
            errors.push({ message: `An unexpected error occurred during validation: ${e.message}.`, lineNumber: 'N/A' });
            return false;
        } finally {
            displayValidationResults(errors);
            highlightHtmlEntities();
        }
    }


    /**
     * Displays validation results in the UI.
     * @param {Array} errors - Array of error objects.
     */
    function displayValidationResults(errors) {
        validationResultsDiv.innerHTML = '';
        if (errors.length === 0) {
            validationResultsDiv.classList.remove('bg-red-100', 'text-red-800', 'border-red-300', 'bg-gray-50', 'text-gray-700', 'border-gray-200');
            validationResultsDiv.classList.add('bg-green-100', 'text-green-800', 'border-green-300');
            validationResultsDiv.innerHTML = '<p class="font-semibold text-center">🎉 Valid! No further adjustment needed. 🎉</p>';
        } else {
            validationResultsDiv.classList.remove('bg-green-100', 'text-green-800', 'border-green-300', 'bg-gray-50', 'text-gray-700', 'border-gray-200');
            validationResultsDiv.classList.add('bg-red-100', 'text-red-800', 'border-red-300');
            const errorList = document.createElement('ul');
            errorList.classList.add('list-disc', 'pl-5');
            errors.forEach(error => {
                const listItem = document.createElement('li');
                listItem.innerHTML = error.message;
                if (typeof error.lineNumber === 'number') {
                    listItem.dataset.lineNumber = error.lineNumber;
                }
                errorList.appendChild(listItem);
            });
            validationResultsDiv.appendChild(errorList);
        }
    }

    /**
     * Handles clicks on the validation error list items to highlight the line in Monaco.
     * @param {Event} event - The click event.
     */
    function handleResultClick(event) {
        const listItem = event.target.closest('li[data-line-number]');
        if (listItem) {
            const lineNumber = parseInt(listItem.dataset.lineNumber, 10);
            currentLineDecorations = editor.deltaDecorations(currentLineDecorations, []);
            currentLineDecorations = editor.deltaDecorations(currentLineDecorations, [{
                range: new monaco.Range(lineNumber, 1, lineNumber, editor.getModel().getLineMaxColumn(lineNumber)),
                options: {
                    className: 'highlighted-line',
                    isOverviewRuler: true,
                    overviewRulerLane: monaco.editor.OverviewRulerLane.Full,
                    overviewRulerColor: 'rgba(100, 149, 237, 0.6)'
                }
            }]);
            editor.revealLineInCenter(lineNumber);
            editor.focus();
        }
    }

    /**
     * Updates the disabled state of the "Validate" button based on the "Auto-Check" toggle.
     */
    function updateValidateButtonState() {
        validateNowBtn.disabled = toggleAutoCheckOnSwitch.checked;
    }

    /**
     * Updates the disabled state of the undo/redo buttons based on the editor's stack.
     */
    function updateUndoRedoState() {
        if (editor && editor.getModel()) {
            undoBtn.disabled = !editor.getModel().canUndo();
            redoBtn.disabled = !editor.getModel().canRedo();
        }
    }


    /**
     * Updates the disabled state of the "Preview" button based on whether the content is XML-like.
     * @param {boolean} isXmlLike - True if the content is detected as XML-like, false otherwise.
     */
    function updatePreviewButtonState(isXmlLike) {
        previewBtn.disabled = isXmlLike;
        colophonBtn.disabled = isXmlLike;
    }

    /**
     * Generates the full HTML content for the preview.
     * @param {object} options - Options for generating HTML (e.g., showSections, enableCss, etc.)
     * @param {boolean} forExport - If true, removes highlight CSS.
     * @returns {string} The complete HTML string.
     */
    function generateFullHtml(options, forExport = false) {
        const bodyContent = editor.getValue();
        let customH1Title = (options.currentLanguage === 'en' ? options.h1TitleEn : options.h1TitleFr).trim();
        if (customH1Title === '') {
            customH1Title = (options.currentLanguage === 'en') ? 'Canada.ca Page Title (EN)' : 'Titre de la page Canada.ca (FR)';
        }
        const pageTitle = customH1Title;

        let dynamicTitleHtml = '';
        if (options.showTitle) {
            if (options.currentFramework === 'wet' || options.currentFramework === 'wet+') {
                dynamicTitleHtml = `<h1 property="name" id="wb-cont">${customH1Title}</h1>`;
            } else if (options.currentFramework === 'gcds') {
                dynamicTitleHtml = `<gcds-heading tag="h1">${customH1Title}</gcds-heading>`;
            }
        }

        let bylineHtml = '';
        if (options.bylineMode === 'english') {
            if (options.currentFramework === 'wet' || options.currentFramework === 'wet+') {
                bylineHtml = '<p class="gc-byline"><strong>From: <a href="/en/treasury-board-secretariat.html">Treasury Board of Canada of Canada Secretariat</a></strong></p>';
            } else if (options.currentFramework === 'gcds') {
                bylineHtml = `<gcds-text><strong>From: <gcds-link href="/en/treasury-board-secretariat.html">Treasury Board of Canada of Canada Secretariat</gcds-link></strong></gcds-text>`;
            }
        } else if (options.bylineMode === 'french') {
            if (options.currentFramework === 'wet' || options.currentFramework === 'wet+') {
                bylineHtml = '<p class="gc-byline"><strong>De : <a href="/fr/secretariat-conseil-tresor.html">Secrétariat du Conseil du Trésor du Canada</a></strong></p>';
            } else if (options.currentFramework === 'gcds') {
                bylineHtml = `<gcds-text><strong>De : <gcds-link href="/fr/secretariat-conseil-tresor.html">Secrétariat du Conseil du Conseil du Trésor du Canada</gcds-link></strong></gcds-text>`;
            }
        }

        let h1AndBylineSection = `${dynamicTitleHtml}${bylineHtml}`;
        if ((options.currentFramework === 'gcds') && (dynamicTitleHtml || bylineHtml)) {
            h1AndBylineSection = `<section>${h1AndBylineSection}</section>`;
        }

        let contentToInject = options.useContainerDiv ? `<div class="container">${h1AndBylineSection}${bodyContent}</div>` : `${h1AndBylineSection}${bodyContent}`;

        const parser = new DOMParser();
        const tempDoc = parser.parseFromString(contentToInject, 'text/html');

        const localPrefixes = ['/content/canadasite/en/treasury-board-secretariat', '/content/canadasite/fr/secretariat-conseil-tresor', '/content/canadasite/en/government', '/content/canadasite/fr/gouvernement'];
        const previewPrefixes = ['https://canada-preview.adobecqms.net/en/treasury-board-secretariat', 'https://canada-preview.adobecqms.net/fr/secretariat-conseil-tresor', 'https://canada-preview.adobecqms.net/en/government', 'https://canada-preview.adobecqms.net/fr/gouvernement'];
        const livePrefixes = ['https://www.canada.ca/en/treasury-board-secretariat', 'https://www.canada.ca/fr/secretariat-conseil-tresor', 'https://www.canada.ca/en/government', 'https://www.canada.ca/fr/gouvernement'];

        function replaceUrlPrefix(url, currentPrefixes, targetPrefixes) {
            for (let i = 0; i < currentPrefixes.length; i++) {
                if (url.startsWith(currentPrefixes[i])) {
                    return targetPrefixes[i] + url.substring(currentPrefixes[i].length);
                }
            }
            return url;
        }

        tempDoc.querySelectorAll('img').forEach(img => {
            let src = img.getAttribute('src');
            if (src && !src.startsWith('http://') && !src.startsWith('https://') && !src.startsWith('//')) {
                let baseUrl = '';
                if (options.imageSourceMode === 'preview') baseUrl = 'https://canada-preview.adobecqms.net';
                else if (options.imageSourceMode === 'live') baseUrl = 'https://www.canada.ca';
                if (baseUrl) img.setAttribute('src', `${baseUrl}${src.startsWith('/') ? '' : '/'}${src}`);
            }
        });

        tempDoc.querySelectorAll('a').forEach(link => {
            let href = link.getAttribute('href');
            if (href && (href.startsWith('/') || href.startsWith('http://') || href.startsWith('https://'))) {
                if (options.urlSourceMode === 'local') {
                    href = replaceUrlPrefix(href, previewPrefixes, localPrefixes);
                    href = replaceUrlPrefix(href, livePrefixes, localPrefixes);
                } else if (options.urlSourceMode === 'preview') {
                    href = replaceUrlPrefix(href, localPrefixes, previewPrefixes);
                    href = replaceUrlPrefix(href, livePrefixes, previewPrefixes);
                } else if (options.urlSourceMode === 'live') {
                    href = replaceUrlPrefix(href, localPrefixes, livePrefixes);
                    href = replaceUrlPrefix(href, previewPrefixes, livePrefixes);
                }
                link.setAttribute('href', href);
            }
        });

        contentToInject = tempDoc.body.innerHTML;

        const bodyClassParts = [];
        if (!forExport && options.showSections) bodyClassParts.push('show-sections-outline');
        if (!forExport && options.showHeadings) bodyClassParts.push('show-headings-outline');
        const bodyClass = bodyClassParts.join(' ');

        let cssLinks = '';
        if (options.enableCss) {
            if (options.currentFramework === 'wet') cssLinks = `<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"><link rel="stylesheet" href="https://www.canada.ca/etc/designs/canada/wet-boew/css/theme.min.css">`;
            else if (options.currentFramework === 'gcds') cssLinks = `<link rel="stylesheet" href="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-utility@latest/dist/gcds-utility.min.css"><link rel="stylesheet" href="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@latest/dist/gcds/gcds.css">`;
            else if (options.currentFramework === 'wet+') cssLinks = `<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"><link rel="stylesheet" href="https://www.canada.ca/etc/designs/canada/wet-boew/css/theme.min.css"><link rel="stylesheet" href="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@latest/dist/gcds/gcds.css">`;
        }

        let jsScripts = '';
        if (options.currentFramework === 'wet') jsScripts = `<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"><\/script><script src="https://www.canada.ca/etc/designs/canada/wet-boew/js/wet-boew.min.js"><\/script><script src="https://www.canada.ca/etc/designs/canada/wet-boew/js/theme.min.js"><\/script>`;
        else if (options.currentFramework === 'gcds') jsScripts = `<script type="module" src="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@latest/dist/gcds/gcds.esm.js"><\/script><script nomodule src="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@latest/dist/gcds/gcds.js"><\/script>`;
        else if (options.currentFramework === 'wet+') jsScripts = `<script type="module" src="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@latest/dist/gcds/gcds.esm.js"><\/script><script nomodule src="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@latest/dist/gcds/gcds.js"><\/script><script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"><\/script><script src="https://www.canada.ca/etc/designs/canada/wet-boew/js/wet-boew.min.js"><\/script><script src="https://www.canada.ca/etc/designs/canada/wet-boew/js/theme.min.js"><\/script>`;

        let mainContentWrapper = '';
        if (options.currentFramework === 'wet' || options.currentFramework === 'wet+') mainContentWrapper = `<main property="mainContentOfPage" resource="#wb-main" typeof="WebPageElement">${contentToInject}</main>`;
        else if (options.currentFramework === 'gcds') mainContentWrapper = `<gcds-container id="main-content" main-container size="xl" centered tag="main">${contentToInject}</gcds-container>`;

        return `
<!DOCTYPE html>
<html class="no-js" lang="${options.currentLanguage}" dir="ltr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${pageTitle}</title>
    ${cssLinks}
    <style>
        body { text-align: left; font-family: 'Noto Sans', sans-serif; }
        ${!forExport ? `
        .show-sections-outline section { border: 2px dashed #007bff; padding: 10px; margin-bottom: 10px; }
        .show-sections-outline section:hover { background-color: rgba(0, 123, 255, 0.1); }
        .show-headings-outline h1, .show-headings-outline gcds-heading[tag="h1"] { border: 2px solid #FF0000; background-color: rgba(255,0,0,0.1); padding: 5px; }
        .show-headings-outline h2, .show-headings-outline gcds-heading[tag="h2"] { border: 2px solid #FF7F00; background-color: rgba(255,127,0,0.1); padding: 5px; }
        .show-headings-outline h3, .show-headings-outline gcds-heading[tag="h3"] { border: 2px solid #FFFF00; background-color: rgba(255,255,0,0.1); padding: 5px; }
        .show-headings-outline h4, .show-headings-outline gcds-heading[tag="h4"] { border: 2px solid #00FF00; background-color: rgba(0,255,0,0.1); padding: 5px; }
        .show-headings-outline h5, .show-headings-outline gcds-heading[tag="h5"] { border: 2px solid #0000FF; background-color: rgba(0,0,255,0.1); padding: 5px; }
        .show-headings-outline h6, .show-headings-outline gcds-heading[tag="h6"] { border: 2px solid #4B0082; background-color: rgba(75,0,130,0.1); padding: 5px; }
        ` : ''}
        .table tbody tr.active { background-color: #e0f2f7; }
        .nowrap { white-space: nowrap; }
    </style>
</head>
<body class="${bodyClass}">
    ${mainContentWrapper}
    ${jsScripts}
</body>
</html>`;
    }


    /**
     * Updates the content of the modal iframe.
     */
    function updateModalPreview() {
        const previewOptions = {
            showSections: modalShowSections,
            showHeadings: modalShowHeadings,
            useContainerDiv: modalUseContainerDiv,
            showTitle: modalShowTitle,
            imageSourceMode: modalImageSourceMode,
            bylineMode: modalBylineMode,
            enableCss: modalEnableCss,
            urlSourceMode: modalUrlSourceMode,
            currentLanguage: modalCurrentLanguage,
            currentFramework: modalCurrentFramework,
            h1TitleEn: modalH1TitleEn,
            h1TitleFr: modalH1TitleFr
        };
        const fullHtml = generateFullHtml(previewOptions);
        const iframeDocument = modalPreviewFrame.contentDocument || modalPreviewFrame.contentWindow.document;
        iframeDocument.open();
        iframeDocument.write(fullHtml);
        iframeDocument.close();

        let iframeWidth = '100%';
        switch (modalCurrentBreakpoint) {
            case 'xs': iframeWidth = '375px'; break;
            case 'sm': iframeWidth = '640px'; break;
            case 'md': iframeWidth = '992px'; break;
            case 'full': iframeWidth = '100%'; break;
        }
        modalPreviewFrame.style.width = iframeWidth;
        modalPreviewFrame.style.margin = (iframeWidth === '100%') ? '0' : '0 auto';
    }

    /**
     * Shows the preview modal with the current editor content.
     */
    function showPreviewModal() {
        previewModal.classList.remove('hidden');
        updateModalSettingsButtonStates();
        updateModalBylineButtonStates();
        updateModalImageSourceButtonStates();
        updateModalUrlSourceButtonStates();
        updateModalSectionHeadingButtonStates();
        updateModalWetGcdsButtonState();
        updateModalLanguageButtonStates();
        updateModalBreakpointButtonStates();
        modalH1TitleInputContainer.style.display = modalShowTitle ? 'block' : 'none';
        modalH1TitleInput.value = (modalCurrentLanguage === 'en') ? modalH1TitleEn : modalH1TitleFr;
        updateModalPreview();
    }

    /**
     * Updates the disabled state of all interactive buttons.
     */
    function updateAllInteractiveButtonStates() {
        const anyTempMessageActive = allInteractiveButtons.some(btn => btn.getAttribute('data-temp-active') === 'true');
        allInteractiveButtons.forEach(btn => {
            // A button is disabled if it's currently showing a temporary message,
            // or if any *other* button is showing one.
            // Undo/Redo have their own state logic, so we don't disable them here unless another button is active.
            if (btn.id !== 'undoBtn' && btn.id !== 'redoBtn') {
                 btn.disabled = anyTempMessageActive;
            }
        });
        // Update undo/redo state separately
        updateUndoRedoState();
    }

    /**
     * Displays a modal dialog with a given message and interactive elements.
     * @param {string} title - The title of the modal.
     * @param {string} contentHtml - The HTML content for the modal body.
     * @param {HTMLElement} triggeringButton - The button that opened this modal.
     * @param {string} originalButtonHtml - The original innerHTML of the triggering button.
     */
    function showModal(title, contentHtml, triggeringButton, originalButtonHtml) {
        const modalOverlay = document.createElement('div');
        modalOverlay.className = 'modal-overlay';
        modalOverlay.innerHTML = `
            <div class="modal-content">
                <h3>${title}</h3>
                <div id="modalBody">${contentHtml}</div>
                <div class="flex justify-end mt-4 space-x-2">
                    <button id="modalCancelBtn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">Cancel</button>
                    <button id="modalInsertBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Insert</button>
                </div>
            </div>
        `;
        document.body.appendChild(modalOverlay);

        modalOverlay.addEventListener('click', (event) => {
            if (event.target === modalOverlay) closeModalAndReEnableButtons();
        });

        function closeModalAndReEnableButtons() {
            modalOverlay.remove();
            triggeringButton.removeAttribute('data-temp-active');
            triggeringButton.innerHTML = originalButtonHtml;
            triggeringButton.classList.remove('bg-green-500', 'hover:bg-green-600');
            triggeringButton.classList.add('bg-gray-600', 'hover:bg-gray-500');
            updateAllInteractiveButtonStates();
        }

        document.getElementById('modalCancelBtn').addEventListener('click', closeModalAndReEnableButtons);

        const langEnglishBtn = document.getElementById('langEnglishBtn');
        const langFrenchBtn = document.getElementById('langFrenchBtn');
        const monarchKingBtn = document.getElementById('monarchKingBtn');
        const monarchQueenBtn = document.getElementById('monarchQueenBtn');
        const idISBNBtn = document.getElementById('idISBNBtn');
        const idISSNBtn = document.getElementById('idISSNBtn');
        const colophonYearInput = document.getElementById('colophonYear');
        const colophonNumberInput = document.getElementById('colophonNumber');
        const modalInsertBtn = document.getElementById('modalInsertBtn');

        let selectedLanguage = 'English';
        let selectedMonarch = 'King';
        let selectedIdentifier = 'ISBN';

        function updateButtonActiveState(buttons, activeBtn) {
            buttons.forEach(btn => btn.classList.remove('active', 'bg-indigo-600'));
            activeBtn.classList.add('active', 'bg-indigo-600');
        }

        updateButtonActiveState([langEnglishBtn, langFrenchBtn], langEnglishBtn);
        updateButtonActiveState([monarchKingBtn, monarchQueenBtn], monarchKingBtn);
        updateButtonActiveState([idISBNBtn, idISSNBtn], idISBNBtn);

        langEnglishBtn.addEventListener('click', () => { selectedLanguage = 'English'; updateButtonActiveState([langEnglishBtn, langFrenchBtn], langEnglishBtn); });
        langFrenchBtn.addEventListener('click', () => { selectedLanguage = 'French'; updateButtonActiveState([langEnglishBtn, langFrenchBtn], langFrenchBtn); });
        monarchKingBtn.addEventListener('click', () => { selectedMonarch = 'King'; updateButtonActiveState([monarchKingBtn, monarchQueenBtn], monarchKingBtn); });
        monarchQueenBtn.addEventListener('click', () => { selectedMonarch = 'Queen'; updateButtonActiveState([monarchKingBtn, monarchQueenBtn], monarchQueenBtn); });
        idISBNBtn.addEventListener('click', () => { selectedIdentifier = 'ISBN'; updateButtonActiveState([idISBNBtn, idISSNBtn], idISBNBtn); });
        idISSNBtn.addEventListener('click', () => { selectedIdentifier = 'ISSN'; updateButtonActiveState([idISBNBtn, idISSNBtn], idISSNBtn); });

        colophonYearInput.addEventListener('input', (event) => {
            const input = event.target;
            input.value = input.value.replace(/\D/g, '');
            if (input.value.length > 4) input.value = input.value.substring(0, 4);
        });

        modalInsertBtn.addEventListener('click', async () => {
            const year = colophonYearInput.value || new Date().getFullYear();
            const number = colophonNumberInput.value || '###';
            let colophonHtmlContent = `<section id="colophon">\n<p class="mrgn-tp-lg text-center small">© `;

            if (selectedLanguage === 'English') {
                colophonHtmlContent += `${selectedMonarch === 'King' ? 'His' : 'Her'} Majesty the ${selectedMonarch} in Right of Canada, represented by the President of the Treasury Board, ${year},<br>${selectedIdentifier}:&#160;${number}</p>\n</section>`;
            } else {
                colophonHtmlContent += `Sa Majesté ${selectedMonarch === 'King' ? 'le Roi' : 'la Reine'} du chef du Canada, représenté par le président du Conseil du Trésor, ${year},<br>${selectedIdentifier}&#160;:&#160;${number}</p>\n</section>`;
            }

            if (editor) {
                const model = editor.getModel();
                const currentContent = model.getValue();
                
                // Regex to find and remove an existing colophon section from the end of the content
                const existingColophonRegex = /<section[^>]*id=["']colophon["'][^>]*>[\s\S]*?<\/section>\s*$/i;
                const contentWithoutColophon = currentContent.replace(existingColophonRegex, '').trim();

                // Append the new colophon content
                const newContent = contentWithoutColophon + '\n' + colophonHtmlContent;

                const fullRange = model.getFullModelRange();
                
                // Use a single edit operation to replace the entire content
                editor.pushUndoStop();
                model.pushEditOperations([], [{ range: fullRange, text: newContent }], () => null);
                editor.pushUndoStop();
            }

            closeModalAndReEnableButtons();

            triggeringButton.innerHTML = `Inserted! ${triggeringButton.querySelector('i')?.outerHTML || ''}`;
            triggeringButton.classList.add('bg-green-500', 'hover:bg-green-600');
            triggeringButton.classList.remove('bg-gray-600', 'hover:bg-gray-500');
            setTimeout(() => {
                triggeringButton.innerHTML = originalButtonHtml;
                triggeringButton.classList.remove('bg-green-500', 'hover:bg-green-600');
                triggeringButton.classList.add('bg-gray-600', 'hover:bg-gray-500');
            }, 1500);
        });
    }

    // Functions to update button states for the MODAL preview controls
    function updateModalSettingsButtonStates() {
        [modalToggleContainerBtn, modalToggleTitleBtn, modalToggleCssBtn].forEach(btn => btn.classList.remove('active', 'bg-indigo-600', 'bg-red-600'));
        if (modalUseContainerDiv) modalToggleContainerBtn.classList.add('active', 'bg-indigo-600');
        if (modalShowTitle) modalToggleTitleBtn.classList.add('active', 'bg-indigo-600');
        if (!modalEnableCss) modalToggleCssBtn.classList.add('bg-red-600');
        modalToggleContainerBtn.textContent = modalUseContainerDiv ? 'Custom Width' : 'Default Width';
        modalToggleTitleBtn.textContent = modalShowTitle ? 'Hide Title' : 'Show Title';
        modalToggleCssBtn.textContent = modalEnableCss ? 'Disable CSS' : 'Enable CSS';
    }

    function updateModalBylineButtonStates() {
        [modalNoneBylineBtn, modalEnglishBylineBtn, modalFrenchBylineBtn].forEach(btn => btn.classList.remove('active', 'bg-indigo-600'));
        if (modalBylineMode === 'none') modalNoneBylineBtn.classList.add('active', 'bg-indigo-600');
        else if (modalBylineMode === 'english') modalEnglishBylineBtn.classList.add('active', 'bg-indigo-600');
        else if (modalBylineMode === 'french') modalFrenchBylineBtn.classList.add('active', 'bg-indigo-600');
        modalEnglishBylineBtn.style.display = (modalCurrentLanguage === 'en') ? 'inline-block' : 'none';
        modalFrenchBylineBtn.style.display = (modalCurrentLanguage === 'fr') ? 'inline-block' : 'none';
    }

    function updateModalImageSourceButtonStates() {
        [modalLocalImagesBtn, modalPreviewImagesBtn, modalToggleLiveImagesBtn].forEach(btn => btn.classList.remove('active', 'bg-indigo-600'));
        if (modalImageSourceMode === 'local') modalLocalImagesBtn.classList.add('active', 'bg-indigo-600');
        else if (modalImageSourceMode === 'preview') modalPreviewImagesBtn.classList.add('active', 'bg-indigo-600');
        else if (modalImageSourceMode === 'live') modalToggleLiveImagesBtn.classList.add('active', 'bg-indigo-600');
    }

    function updateModalUrlSourceButtonStates() {
        [modalLocalUrlsBtn, modalPreviewUrlsBtn, modalToggleLiveUrlsBtn].forEach(btn => btn.classList.remove('active', 'bg-indigo-600'));
        if (modalUrlSourceMode === 'local') modalLocalUrlsBtn.classList.add('active', 'bg-indigo-600');
        else if (modalUrlSourceMode === 'preview') modalPreviewUrlsBtn.classList.add('active', 'bg-indigo-600');
        else if (modalUrlSourceMode === 'live') modalToggleLiveUrlsBtn.classList.add('active', 'bg-indigo-600');
    }

    function updateModalSectionHeadingButtonStates() {
        modalToggleSectionsBtn.classList.toggle('active', modalShowSections);
        modalToggleHeadingsBtn.classList.toggle('active', modalShowHeadings);
    }

    function updateModalWetGcdsButtonState() {
        modalWetGcdsToggleBtn.classList.remove('bg-blue-600', 'bg-indigo-600');
        modalWetGcdsToggleBtn.innerHTML = ''; // Clear content
        if (modalCurrentFramework === 'wet') {
            modalWetGcdsToggleBtn.classList.add('bg-blue-600');
            modalWetGcdsToggleBtn.textContent = 'WET4';
        } else if (modalCurrentFramework === 'gcds') {
            modalWetGcdsToggleBtn.classList.add('bg-indigo-600');
            modalWetGcdsToggleBtn.textContent = 'GCDS';
        } else if (modalCurrentFramework === 'wet+') {
            modalWetGcdsToggleBtn.classList.add('bg-indigo-600');
            modalWetGcdsToggleBtn.innerHTML = '<strong><u>WET+</u></strong>';
        }
    }

    function updateModalLanguageButtonStates() {
        modalLangEnBtn.classList.remove('active', 'bg-indigo-600');
        modalLangFrBtn.classList.remove('active', 'bg-indigo-600');
        if (modalCurrentLanguage === 'en') {
            modalLangEnBtn.classList.add('active', 'bg-indigo-600');
            modalH1TitleInput.placeholder = 'e.g., My Custom ENG Title';
            modalH1TitleInput.value = modalH1TitleEn;
        } else {
            modalLangFrBtn.classList.add('active', 'bg-indigo-600');
            modalH1TitleInput.placeholder = 'e.g., Mon titre FRA personnalisé';
            modalH1TitleInput.value = modalH1TitleFr;
        }
        updateModalBylineButtonStates();
    }

    function updateModalBreakpointButtonStates() {
        [modalBreakpointXsBtn, modalBreakpointSmBtn, modalBreakpointMdBtn, modalBreakpointFullBtn].forEach(btn => btn.classList.remove('active', 'bg-indigo-600'));
        if (modalCurrentBreakpoint === 'xs') modalBreakpointXsBtn.classList.add('active', 'bg-indigo-600');
        else if (modalCurrentBreakpoint === 'sm') modalBreakpointSmBtn.classList.add('active', 'bg-indigo-600');
        else if (modalCurrentBreakpoint === 'md') modalBreakpointMdBtn.classList.add('active', 'bg-indigo-600');
        else if (modalCurrentBreakpoint === 'full') modalBreakpointFullBtn.classList.add('active', 'bg-indigo-600');
    }

    // Initialize Monaco Editor and set up event listeners on window load
    window.onload = function() {
        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.52.2/min/vs' } });
        require(['vs/editor/editor.main'], function() {
            const monacoEditorContainer = document.getElementById('monacoEditorContainer');
            htmlModel = monaco.editor.createModel('', 'html');
            editor = monaco.editor.create(monacoEditorContainer, {
                model: htmlModel,
                language: 'html',
                    theme: 'hc-black', // Or 'hc-black'
                    automaticLayout: true, // Important for responsiveness
                    minimap: { enabled: true },
                    fontSize: 14,
                    tabSize: 4,
                    insertSpaces: true,
                    // Additional options for better UX
                    scrollBeyondLastLine: false,
                    wordWrap: 'on',
                    wrappingIndent: 'same'
            });

            validationResultsDiv.addEventListener('click', handleResultClick);

            const debouncedValidateAndHighlight = debounce(async () => {
                if (isAutoCheckEnabled) {
                    const isXmlLike = await validateHtmlContent(editor.getValue());
                    updatePreviewButtonState(isXmlLike);
                }
                updateUndoRedoState(); // Update undo/redo state on content change
            }, 500);
            editor.onDidChangeModelContent(debouncedValidateAndHighlight);

            validateHtmlContent(editor.getValue()).then(isXmlLike => {
                updatePreviewButtonState(isXmlLike);
            });
            highlightHtmlEntities();
            updateValidateButtonState();
            updateUndoRedoState(); // Initial check for undo/redo

            window.addEventListener('resize', () => editor.layout());

            // --- Event Listeners ---

            toggleAutoCheckOnSwitch.addEventListener('change', (event) => {
                isAutoCheckEnabled = event.target.checked;
                const parentLabel = event.target.closest('.toggle-switch');
                parentLabel.classList.toggle('is-checked', isAutoCheckEnabled);
                validateNowBtn.disabled = isAutoCheckEnabled;
                if (isAutoCheckEnabled) {
                    validateHtmlContent(editor.getValue()).then(isXmlLike => {
                        updatePreviewButtonState(isXmlLike);
                    });
                }
            });

            validateNowBtn.addEventListener('click', async () => {
                const isXmlLike = await validateHtmlContent(editor.getValue());
                updatePreviewButtonState(isXmlLike);
                const originalHtml = validateNowBtn.innerHTML;
                validateNowBtn.innerHTML = `Validated! <i class="fa-solid fa-check-double"></i>`;
                validateNowBtn.classList.add('bg-green-500');
                setTimeout(() => {
                    validateNowBtn.innerHTML = originalHtml;
                    validateNowBtn.classList.remove('bg-green-500');
                }, 1500);
            });

            previewBtn.addEventListener('click', showPreviewModal);
            previewModal.addEventListener('click', (event) => {
                if (event.target === previewModal) previewModal.classList.add('hidden');
            });
            closePreviewModalBtn.addEventListener('click', () => previewModal.classList.add('hidden'));
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && !previewModal.classList.contains('hidden')) {
                    closePreviewModalBtn.click();
                }
            });

            undoBtn.addEventListener('click', () => {
                editor.trigger('undo', 'undo', null);
                editor.focus();
            });
            redoBtn.addEventListener('click', () => {
                editor.trigger('redo', 'redo', null);
                editor.focus();
            });

            function handleButtonAction(button, action, successText) {
                const originalHtml = button.innerHTML;
                const iconHtml = button.querySelector('i')?.outerHTML || '';
                action();
                button.innerHTML = `${successText} ${iconHtml}`;
                button.classList.add('bg-green-500');
                button.disabled = true;
                setTimeout(() => {
                    button.innerHTML = originalHtml;
                    button.classList.remove('bg-green-500');
                    button.disabled = false;
                }, 1500);
            }
            
            function applyEditorChange(changeFunction) {
                const model = editor.getModel();
                const fullRange = model.getFullModelRange();
                const newContent = changeFunction(model.getValue());
                
                editor.pushUndoStop();
                model.pushEditOperations([], [{ range: fullRange, text: newContent }], () => null);
                editor.pushUndoStop();
            }

            autoEncodeBtn.addEventListener('click', () => handleButtonAction(autoEncodeBtn, () => applyEditorChange(convertAllEntitiesToNumeric), 'Encoded!'));
            autoFormatBtn.addEventListener('click', () => handleButtonAction(autoFormatBtn, () => applyEditorChange(v => html_beautify(v, { indent_size: 4, indent_char: ' ' })), 'Formatted!'));
            
            const quickFormattingToggles = [toggleCleanSpaces, toggleCleanUrls, toggleTimeTags, toggleFixFnIds];

            function updateFormatButtonState() {
                const anySelected = quickFormattingToggles.some(toggle => toggle.checked);
                formatSelectedBtn.disabled = !anySelected;
            }

            quickFormattingToggles.forEach(toggle => {
                toggle.addEventListener('change', (event) => {
                    const parentLabel = event.target.closest('.toggle-switch');
                    parentLabel.classList.toggle('is-checked', event.target.checked);
                    updateFormatButtonState();
                });
            });

            updateFormatButtonState();
            
            formatSelectedBtn.addEventListener('click', async () => {
                if (editor) {
                    const model = editor.getModel();
                    const fullRange = model.getFullModelRange();
                    let currentContent = editor.getValue();
                    
                    editor.pushUndoStop();

                    currentContent = applyNBSPPlaceholders(currentContent);

                    if (toggleCleanSpaces.checked) {
                        currentContent = applyAutoSpacing(currentContent);
                    }
                    if (toggleCleanUrls.checked) {
                        currentContent = applyUrlCleaning(currentContent);
                    }
                    if (toggleTimeTags.checked) {
                        currentContent = applyTimeTagging(currentContent);
                    }
                    if (toggleFixFnIds.checked) {
                        currentContent = applyFixFnIds(currentContent);
                    }
                    
                    currentContent = revertNBSPPlaceholders(currentContent);
                    currentContent = convertAllEntitiesToNumeric(currentContent);
                    currentContent = html_beautify(currentContent, { 
    indent_size: 4, 
    indent_char: ' ', 
    extra_liners: [], 
    max_preserve_newlines: 0 
});

                    model.pushEditOperations([], [{ range: fullRange, text: currentContent }], () => null);
                    editor.pushUndoStop();

                    highlightHtmlEntities();

                    const originalText = formatSelectedBtn.textContent;
                    formatSelectedBtn.textContent = 'Formatted!';
                    formatSelectedBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                    formatSelectedBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    formatSelectedBtn.disabled = true;
                    formatSelectedBtn.setAttribute('data-temp-active', 'true');
                    updateAllInteractiveButtonStates();
                    setTimeout(() => {
                        formatSelectedBtn.textContent = originalText;
                        formatSelectedBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                        formatSelectedBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                        formatSelectedBtn.removeAttribute('data-temp-active');
                        updateAllInteractiveButtonStates();
                        updateFormatButtonState();
                    }, 1500);
                }
            });

            colophonBtn.addEventListener('click', () => {
                const originalHtml = colophonBtn.innerHTML;
                colophonBtn.innerHTML = `Opening... ${colophonBtn.querySelector('i')?.outerHTML || ''}`;
                colophonBtn.classList.add('bg-green-500');
                colophonBtn.setAttribute('data-temp-active', 'true');
                updateAllInteractiveButtonStates();

                const colophonHtmlContent = `
                    <div class="flex flex-col space-y-4">
                        <div>
                            <span class="text-sm font-medium text-gray-200 mr-2">Language:</span>
                            <div class="button-group inline-flex space-x-1">
                                <button id="langEnglishBtn" class="px-2 py-0.5 text-sm bg-gray-600 text-white rounded-md hover:bg-gray-500">English</button>
                                <button id="langFrenchBtn" class="px-2 py-0.5 text-sm bg-gray-600 text-white rounded-md hover:bg-gray-500">French</button>
                            </div>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-200 mr-2">Monarch:</span>
                            <div class="button-group inline-flex space-x-1">
                                <button id="monarchKingBtn" class="px-2 py-0.5 text-sm bg-gray-600 text-white rounded-md hover:bg-gray-500">King</button>
                                <button id="monarchQueenBtn" class="px-2 py-0.5 text-sm bg-gray-600 text-white rounded-md hover:bg-gray-500">Queen</button>
                            </div>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-200 mr-2">Identifier Type:</span>
                            <div class="button-group inline-flex space-x-1">
                                <button id="idISBNBtn" class="px-2 py-0.5 text-sm bg-gray-600 text-white rounded-md hover:bg-gray-500">ISBN</button>
                                <button id="idISSNBtn" class="px-2 py-0.5 text-sm bg-gray-600 text-white rounded-md hover:bg-gray-500">ISSN</button>
                            </div>
                        </div>
                        <div>
                            <label for="colophonYear" class="block text-sm font-medium text-gray-200">Year (optional):</label>
                            <input type="number" id="colophonYear" class="w-full px-3 py-2 border rounded-md bg-gray-700" placeholder="e.g., ${new Date().getFullYear()}">
                        </div>
                        <div>
                            <label for="colophonNumber" class="block text-sm font-medium text-gray-200">Identifier Number (optional):</label>
                            <input type="text" id="colophonNumber" class="w-full px-3 py-2 border rounded-md bg-gray-700" placeholder="e.g., 123-456-789-X">
                        </div>
                    </div>
                `;
                showModal('Insert Colophon', colophonHtmlContent, colophonBtn, originalHtml);
            });
            
            copyCodeBtn.addEventListener('click', () => {
                const originalHtml = copyCodeBtn.innerHTML;
                const iconHtml = copyCodeBtn.querySelector('i')?.outerHTML || '';
                const codeContent = editor.getValue();
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = codeContent;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                try {
                    document.execCommand('copy');
                    copyCodeBtn.innerHTML = `Copied! ${iconHtml}`;
                    copyCodeBtn.classList.add('bg-green-500');
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    copyCodeBtn.innerHTML = `Failed! ${iconHtml}`;
                    copyCodeBtn.classList.add('bg-red-500');
                }
                document.body.removeChild(tempTextArea);
                setTimeout(() => {
                    copyCodeBtn.innerHTML = originalHtml;
                    copyCodeBtn.classList.remove('bg-green-500', 'bg-red-500');
                }, 1500);
            });

            clearAllBtn.addEventListener('click', () => handleButtonAction(clearAllBtn, () => applyEditorChange(() => ''), 'Cleared!'));
            
            importHtmlBtn.addEventListener('click', () => htmlFileInput.click());
            htmlFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => handleButtonAction(importHtmlBtn, () => applyEditorChange(() => e.target.result), 'Imported!');
                    reader.readAsText(file);
                }
                htmlFileInput.value = null;
            });
            
            exportHtmlBtn.addEventListener('click', () => {
                const originalHtml = exportHtmlBtn.innerHTML;
                const iconHtml = exportHtmlBtn.querySelector('i')?.outerHTML || '';
                const htmlContent = editor.getValue();
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'exported_html.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                exportHtmlBtn.innerHTML = `Exported! ${iconHtml}`;
                exportHtmlBtn.classList.add('bg-green-500');
                setTimeout(() => {
                    exportHtmlBtn.innerHTML = originalHtml;
                    exportHtmlBtn.classList.remove('bg-green-500');
                }, 1500);
            });
            
            // --- Modal Event Listeners ---
            modalCustomizeHeader.addEventListener('click', () => {
                modalIsCustomizeExpanded = !modalIsCustomizeExpanded;
                modalCustomizeContent.classList.toggle('expanded', modalIsCustomizeExpanded);
                modalCustomizeHeader.classList.toggle('expanded', modalIsCustomizeExpanded);
            });
            modalToggleContainerBtn.addEventListener('click', () => { modalUseContainerDiv = !modalUseContainerDiv; updateModalSettingsButtonStates(); updateModalPreview(); });
            modalToggleTitleBtn.addEventListener('click', () => { modalShowTitle = !modalShowTitle; modalH1TitleInputContainer.style.display = modalShowTitle ? 'block' : 'none'; updateModalSettingsButtonStates(); updateModalPreview(); });
            modalToggleCssBtn.addEventListener('click', () => { modalEnableCss = !modalEnableCss; updateModalSettingsButtonStates(); updateModalPreview(); });
            modalH1TitleInput.addEventListener('input', () => {
                if (modalCurrentLanguage === 'en') modalH1TitleEn = modalH1TitleInput.value; else modalH1TitleFr = modalH1TitleInput.value;
                updateModalPreview();
            });
            modalNoneBylineBtn.addEventListener('click', () => { modalBylineMode = 'none'; updateModalBylineButtonStates(); updateModalPreview(); });
            modalEnglishBylineBtn.addEventListener('click', () => { modalBylineMode = 'english'; updateModalBylineButtonStates(); updateModalPreview(); });
            modalFrenchBylineBtn.addEventListener('click', () => { modalBylineMode = 'french'; updateModalBylineButtonStates(); updateModalPreview(); });
            modalLocalImagesBtn.addEventListener('click', () => { modalImageSourceMode = 'local'; updateModalImageSourceButtonStates(); updateModalPreview(); });
            modalPreviewImagesBtn.addEventListener('click', () => { modalImageSourceMode = 'preview'; updateModalImageSourceButtonStates(); updateModalPreview(); });
            modalToggleLiveImagesBtn.addEventListener('click', () => { modalImageSourceMode = 'live'; updateModalImageSourceButtonStates(); updateModalPreview(); });
            modalLocalUrlsBtn.addEventListener('click', () => { modalUrlSourceMode = 'local'; updateModalUrlSourceButtonStates(); updateModalPreview(); });
            modalPreviewUrlsBtn.addEventListener('click', () => { modalUrlSourceMode = 'preview'; updateModalUrlSourceButtonStates(); updateModalPreview(); });
            modalToggleLiveUrlsBtn.addEventListener('click', () => { modalUrlSourceMode = 'live'; updateModalUrlSourceButtonStates(); updateModalPreview(); });
            modalToggleSectionsBtn.addEventListener('click', () => { modalShowSections = !modalShowSections; updateModalSectionHeadingButtonStates(); updateModalPreview(); });
            modalToggleHeadingsBtn.addEventListener('click', () => { modalShowHeadings = !modalShowHeadings; updateModalSectionHeadingButtonStates(); updateModalPreview(); });
            modalWetGcdsToggleBtn.addEventListener('click', () => {
                const frameworks = ['wet', 'gcds', 'wet+'];
                const currentIndex = frameworks.indexOf(modalCurrentFramework);
                modalCurrentFramework = frameworks[(currentIndex + 1) % frameworks.length];
                updateModalWetGcdsButtonState(); updateModalPreview();
            });
            modalLangEnBtn.addEventListener('click', () => { if (modalBylineMode === 'french') modalBylineMode = 'english'; modalCurrentLanguage = 'en'; updateModalLanguageButtonStates(); updateModalPreview(); });
            modalLangFrBtn.addEventListener('click', () => { if (modalBylineMode === 'english') modalBylineMode = 'french'; modalCurrentLanguage = 'fr'; updateModalLanguageButtonStates(); updateModalPreview(); });
            modalBreakpointXsBtn.addEventListener('click', () => { modalCurrentBreakpoint = 'xs'; updateModalBreakpointButtonStates(); updateModalPreview(); });
            modalBreakpointSmBtn.addEventListener('click', () => { modalCurrentBreakpoint = 'sm'; updateModalBreakpointButtonStates(); updateModalPreview(); });
            modalBreakpointMdBtn.addEventListener('click', () => { modalCurrentBreakpoint = 'md'; updateModalBreakpointButtonStates(); updateModalPreview(); });
            modalBreakpointFullBtn.addEventListener('click', () => { modalCurrentBreakpoint = 'full'; updateModalBreakpointButtonStates(); updateModalPreview(); });

            function performModalPreviewSearch(forward = true) {
                const term = modalPreviewSearchInput.value;
                if (!term || !modalPreviewFrame.contentWindow) return;
                if (term !== modalLastSearchTerm) modalPreviewFrame.contentWindow.getSelection().removeAllRanges();
                modalLastSearchTerm = term;
                modalPreviewFrame.contentWindow.find(term, false, !forward, true, false, false, false);
            }
            modalPreviewFindNextBtn.addEventListener('click', () => performModalPreviewSearch(true));
            modalPreviewFindPrevBtn.addEventListener('click', () => performModalPreviewSearch(false));
            modalPreviewSearchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); performModalPreviewSearch(true); } });

            exportPrototypeBtn.addEventListener('click', () => {
                const prototypeHtml = generateFullHtml({
                    showSections: false, showHeadings: false, useContainerDiv: modalUseContainerDiv, showTitle: modalShowTitle,
                    imageSourceMode: modalImageSourceMode, bylineMode: modalBylineMode, enableCss: modalEnableCss, urlSourceMode: modalUrlSourceMode,
                    currentLanguage: modalCurrentLanguage, currentFramework: modalCurrentFramework, h1TitleEn: modalH1TitleEn, h1TitleFr: modalH1TitleFr
                }, true);
                const blob = new Blob([prototypeHtml], { type: 'text/html' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'prototype.html';
                a.click();
                URL.revokeObjectURL(a.href);
            });

            window.onbeforeunload = function() {
                if (editor && editor.getValue().trim() !== '') {
                    return "You have unsaved changes. Are you sure you want to leave?";
                }
            };
        });
    };
</script>




</body>
</html>
