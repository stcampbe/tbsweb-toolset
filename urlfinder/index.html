<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Canada.ca Link Finder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'wet-blue': '#0066cc',
            'wet-blue-hover': '#0052a3',
          }
        }
      }
    }
  </script>
  <style>
    /* Custom scrollbar for a cleaner look */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: transparent; 
    }
    ::-webkit-scrollbar-thumb {
      background: #ccc; 
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #aaa; 
    }

    #leftPanel {
        font-family: 'Inter', sans-serif;
        background-color: #0F172A;
    }
    
    /* Ensure no double scrolling */
    body {
        margin: 0;
        padding: 0;
    }
  </style>
</head>
<body class="h-screen w-screen overflow-hidden bg-gray-100 text-black font-sans">
  
  <script>
    (function() {
        // --- 1. CLEANUP PHASE ---
        // Aggressively remove ANY existing instances of the app to prevent stacking
        const existingApps = document.querySelectorAll('#app-root');
        existingApps.forEach(el => el.remove());

        // Remove old global event listeners
        if (window.appResizeMoveHandler) {
            document.removeEventListener('mousemove', window.appResizeMoveHandler);
        }
        if (window.appResizeUpHandler) {
            document.removeEventListener('mouseup', window.appResizeUpHandler);
        }

        // --- 2. HTML GENERATION PHASE ---
        // We define the HTML here so we can control exactly when it enters the DOM
        const appTemplate = `
        <div id="app-root" class="main-container flex h-screen w-full gap-0">
            <div class="left-panel w-1/4 min-w-[250px] max-w-[50%] p-5 overflow-y-auto shadow-md flex flex-col z-10" id="leftPanel">
            <h1 class="text-2xl mt-0 mb-4 font-bold text-white">Canada.ca Link Finder</h1>
            
            <div class="input-group mb-4">
                <label for="urlInput" class="block mb-1.5 text-white">Enter Canada.ca page to search:</label>
                <div class="relative w-full">
                    <input type="text" id="urlInput" placeholder="https://www.canada.ca/..." 
                        class="w-full p-2.5 pr-10 border-2 border-zinc-600 rounded text-sm bg-[#1a1a1a] text-white box-border focus:ring-2 focus:ring-blue-500 outline-none placeholder-gray-500" autocomplete="off">
                    <button type="button" onclick="resetApp()" title="Clear and Reset" 
                            class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-red-500 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <button type="button" onclick="fetchContent()" 
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-5 rounded text-sm mb-3 transition-colors duration-200">
                Load Page Content
            </button>
            
            <button type="button" id="generateManifestBtn" onclick="generateLinkManifest()" disabled 
                    class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:text-gray-400 disabled:cursor-not-allowed text-white font-bold py-2.5 px-5 rounded text-sm mb-3 transition-colors duration-200">
                Generate Link Manifest (.csv)
            </button>
            
            <h2 class="text-lg font-bold text-white mt-8 mb-4 pt-5 border-t-2 border-gray-600">Search & Highlight</h2>
            
            <div class="input-group mb-4">
                <label for="searchInput" class="block mb-1.5 text-white">Search for URLs (whole URL or partial):</label>
                <input type="text" id="searchInput" placeholder="e.g., tbs-sct.gc.ca" 
                    class="w-full p-2.5 border-2 border-zinc-600 rounded text-sm bg-[#1a1a1a] text-white box-border focus:ring-2 focus:ring-blue-500 outline-none placeholder-gray-500" autocomplete="off">
            </div>
            
            <button type="button" id="highlightBtn" onclick="highlightURLs()" disabled
                    class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:text-gray-400 disabled:cursor-not-allowed text-white font-bold py-2.5 px-5 rounded text-sm mb-3 transition-colors duration-200">
                Highlight URLs
            </button>
            
            <div class="button-group flex gap-2.5 mb-2.5">
                <button type="button" id="prevBtn" onclick="navigateMatches('prev')" disabled 
                        class="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:text-gray-400 disabled:cursor-not-allowed text-white font-bold py-2.5 rounded text-sm transition-colors duration-200">
                ← Previous
                </button>
                <button type="button" id="nextBtn" onclick="navigateMatches('next')" disabled 
                        class="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:text-gray-400 disabled:cursor-not-allowed text-white font-bold py-2.5 rounded text-sm transition-colors duration-200">
                Next →
                </button>
            </div>
            
            <button type="button" id="clearHighlightsBtn" onclick="clearHighlights()" disabled
                    class="w-full bg-red-600 hover:bg-red-700 disabled:bg-gray-600 disabled:text-gray-400 disabled:cursor-not-allowed text-white font-bold py-2.5 px-5 rounded text-sm mb-3 transition-colors duration-200">
                Clear Highlights
            </button>
            
            <div id="matchCounter"></div>
            <div id="error"></div>
            </div>
            
            <div class="resizer w-2 bg-gray-300 hover:bg-blue-600 cursor-col-resize relative flex-shrink-0 transition-colors duration-200 z-20" id="resizer"></div>
            
            <div class="right-panel flex-1 bg-white flex flex-col overflow-hidden">
            <iframe id="previewFrame" class="flex-1 border-none w-full bg-white h-full"></iframe>
            </div>
        </div>
        `;

        // Inject the fresh HTML
        document.body.insertAdjacentHTML('beforeend', appTemplate);


        // --- 3. STATE & LOGIC ---
        let originalContent = '';
        let currentPageTitle = 'Canada.ca Page';
        let currentBaseUrl = '';
        const NBSP_PLACEHOLDER = '&#160;';
        let allMatches = [];
        let currentMatchIndex = -1;
        let lastSearchTerm = '';
        
        // Resizer Logic
        const resizer = document.getElementById('resizer');
        const leftPanel = document.getElementById('leftPanel');
        const mainContainer = document.querySelector('.main-container');
        const previewFrame = document.getElementById('previewFrame');
        
        let isResizing = false;
        
        resizer.addEventListener('mousedown', function(e) {
          isResizing = true;
          document.body.style.cursor = 'col-resize';
          document.body.style.userSelect = 'none';
          previewFrame.style.pointerEvents = 'none';
        });
        
        window.appResizeMoveHandler = function(e) {
          if (!isResizing) return;
          const containerRect = mainContainer.getBoundingClientRect();
          const newWidth = e.clientX - containerRect.left;
          const minWidth = 200;
          const maxWidth = containerRect.width * 0.5;
          if (newWidth >= minWidth && newWidth <= maxWidth) {
            leftPanel.style.width = newWidth + 'px';
          }
        };
        
        window.appResizeUpHandler = function() {
          if (isResizing) {
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            previewFrame.style.pointerEvents = 'auto';
          }
        };
        
        document.addEventListener('mousemove', window.appResizeMoveHandler);
        document.addEventListener('mouseup', window.appResizeUpHandler);

        // Input Listeners
        const searchInput = document.getElementById('searchInput');
        const highlightBtn = document.getElementById('highlightBtn');

        searchInput.addEventListener('input', function() {
            if (this.value.trim().length > 0) {
                highlightBtn.disabled = false;
            } else {
                highlightBtn.disabled = true;
            }
        });

        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const currentTerm = this.value.trim();
                if (allMatches.length > 0 && currentTerm === lastSearchTerm) {
                    window.navigateMatches('next');
                } else {
                    if (!highlightBtn.disabled) {
                        window.highlightURLs();
                    }
                }
            }
        });
        
        // --- 4. GLOBAL FUNCTIONS ---
        window.resetApp = function() {
            document.getElementById('urlInput').value = '';
            document.getElementById('searchInput').value = '';
            
            originalContent = '';
            currentPageTitle = 'Canada.ca Page';
            currentBaseUrl = '';
            allMatches = [];
            currentMatchIndex = -1;
            lastSearchTerm = '';
            
            const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write('');
            iframeDoc.close();
            
            document.getElementById('error').innerHTML = '';
            document.getElementById('matchCounter').innerHTML = '';
            
            document.getElementById('generateManifestBtn').disabled = true;
            document.getElementById('highlightBtn').disabled = true;
            document.getElementById('clearHighlightsBtn').disabled = true;
            document.getElementById('prevBtn').disabled = true;
            document.getElementById('nextBtn').disabled = true;
        }

        function fixPaths(html, baseUrl) {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          
          doc.querySelectorAll('a[href]').forEach(link => {
            const href = link.getAttribute('href');
            if (href && !href.startsWith('#')) {
              link.setAttribute('target', '_blank');
              link.setAttribute('rel', 'noopener noreferrer');
            }
            if (href && !href.startsWith('http') && !href.startsWith('//') && !href.startsWith('#') && !href.startsWith('mailto:') && !href.startsWith('tel:')) {
              try {
                const absoluteUrl = new URL(href, baseUrl).href;
                link.setAttribute('href', absoluteUrl);
              } catch (e) {
                console.warn('Could not resolve URL:', href);
              }
            }
          });
          
          doc.querySelectorAll('img[src]').forEach(img => {
            const src = img.getAttribute('src');
            if (src && !src.startsWith('http') && !src.startsWith('//') && !src.startsWith('data:')) {
              try {
                const absoluteUrl = new URL(src, baseUrl).href;
                img.setAttribute('src', absoluteUrl);
              } catch (e) {
                console.warn('Could not resolve image URL:', src);
              }
            }
          });
          
          // Fix other attributes omitted for brevity but same logic applies
          return doc.body.innerHTML;
        }
        
        function generateFullHtml(bodyContent, pageTitle) {
          return `
    <!DOCTYPE html>
    <html class="no-js" lang="en" dir="ltr">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>${pageTitle}</title>
      
      <link rel="stylesheet" href="https://use.fontawesome.com/releases/v7.0.1/css/all.css">
      <link rel="stylesheet" href="https://www.canada.ca/etc/designs/canada/wet-boew/css/theme.min.css">
      <link rel="stylesheet" href="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@latest/dist/gcds/gcds.css">
      <style>
        body { text-align: left; font-family: 'Noto Sans', sans-serif; }
        .table tbody tr.active { background-color: #e0f2f7; }
        .nowrap { white-space: nowrap; }
        .highlight {
          background-color: #ffff00 !important;
          color: #000000 !important;
          padding: 2px 4px;
          border-radius: 2px;
          font-weight: bold;
          outline: 3px solid #ff6600;
          scroll-margin-top: 100px;
        }
        .highlight.current-match {
          background-color: #ff6600 !important;
          color: #ffffff !important;
          outline: 3px solid #cc0000;
        }
      </style>
    </head>
    <body>
      ${bodyContent}
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"><\/script>
      <script src="https://www.canada.ca/etc/designs/canada/wet-boew/js/wet-boew.min.js"><\/script>
      <script src="https://www.canada.ca/etc/designs/canada/wet-boew/js/theme.min.js"><\/script>
    </body>
    </html>`;
        }
        
        window.fetchContent = async function() {
          const url = document.getElementById('urlInput').value.trim();
          const previewFrame = document.getElementById('previewFrame');
          const errorDiv = document.getElementById('error');
          const generateManifestBtn = document.getElementById('generateManifestBtn');
          
          errorDiv.innerHTML = '';
          
          if (!url) {
            errorDiv.innerHTML = '<div class="text-red-700 bg-red-100 p-3 rounded border border-red-700 mt-3 font-bold">Please enter a URL</div>';
            return;
          }
          
          if (!url.includes('canada.ca')) {
            errorDiv.innerHTML = '<div class="text-red-700 bg-red-100 p-3 rounded border border-red-700 mt-3 font-bold">Please enter a valid canada.ca URL</div>';
            return;
          }
          
          try {
            errorDiv.innerHTML = '<div class="text-gray-300 italic text-sm mt-3">Loading content...</div>';
            
            const response = await fetch(url);
            if (!response.ok) {
              throw new Error('Failed to fetch content');
            }
            
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const mainContent = doc.querySelector('main');
            
            if (mainContent) {
              currentBaseUrl = url;
              let rawContent = mainContent.outerHTML; 
              originalContent = fixPaths(rawContent, currentBaseUrl);
              
              const h1 = doc.querySelector('h1');
              currentPageTitle = h1 ? h1.textContent.trim() : 'Canada.ca Page';
              
              const fullHtml = generateFullHtml(originalContent, currentPageTitle);
              const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
              iframeDoc.open();
              iframeDoc.write(fullHtml);
              iframeDoc.close();
              
              generateManifestBtn.disabled = false;
              errorDiv.innerHTML = '<div class="text-green-800 bg-green-100 p-3 rounded border border-green-800 mt-3 font-bold">Content loaded successfully!</div>';
            } else {
              errorDiv.innerHTML = '<div class="text-red-700 bg-red-100 p-3 rounded border border-red-700 mt-3 font-bold">No &lt;main&gt; tag found in the page</div>';
            }
          } catch (error) {
            errorDiv.innerHTML = '<div class="text-red-700 bg-red-100 p-3 rounded border border-red-700 mt-3 font-bold">Error loading content: ' + error.message + '</div>';
          }
        }
        
        window.generateLinkManifest = function() {
          const previewFrame = document.getElementById('previewFrame');
          const errorDiv = document.getElementById('error');
          
          if (!originalContent) return;
          
          try {
            const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
            const contentDiv = iframeDoc.querySelector('main') || iframeDoc.body;
            
            if (!contentDiv) return;
            
            const links = contentDiv.querySelectorAll('a[href]');
            const linkData = [];
            let linkNumber = 1;
            
            links.forEach(link => {
              const href = link.getAttribute('href');
              if (href && !href.startsWith('#')) {
                const linkTitle = link.textContent.trim() || '(No title)';
                linkData.push({
                  number: linkNumber,
                  title: linkTitle,
                  url: href
                });
                linkNumber++;
              }
            });
            
            if (linkData.length === 0) {
              errorDiv.innerHTML = '<div class="text-red-700 bg-red-100 p-3 rounded border border-red-700 mt-3 font-bold">No non-anchor links found on the page</div>';
              return;
            }
            
            let csvContent = '#,Link Title,URL\n';
            linkData.forEach(link => {
              const escapedTitle = link.title.replace(/"/g, '""');
              const escapedUrl = link.url.replace(/"/g, '""');
              csvContent += `${link.number},"${escapedTitle}","${escapedUrl}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            
            const sanitizedTitle = currentPageTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            downloadLink.download = `link_manifest_${sanitizedTitle}.csv`;
            
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(url);
            
            errorDiv.innerHTML = `<div class="text-green-800 bg-green-100 p-3 rounded border border-green-800 mt-3 font-bold">Link manifest generated successfully! Downloaded ${linkData.length} links.</div>`;
          } catch (error) {
            errorDiv.innerHTML = '<div class="text-red-700 bg-red-100 p-3 rounded border border-red-700 mt-3 font-bold">Error generating manifest: ' + error.message + '</div>';
          }
        }
        
        function openParentDetails(element) {
          let parent = element.parentElement;
          while (parent) {
            if (parent.tagName === 'DETAILS') {
              parent.setAttribute('open', '');
            }
            parent = parent.parentElement;
          }
        }
        
        window.highlightURLs = function() {
          const searchTerm = document.getElementById('searchInput').value.trim();
          const errorDiv = document.getElementById('error');
          const matchCounterDiv = document.getElementById('matchCounter');
          const previewFrame = document.getElementById('previewFrame');
          const prevBtn = document.getElementById('prevBtn');
          const nextBtn = document.getElementById('nextBtn');
          const clearHighlightsBtn = document.getElementById('clearHighlightsBtn');
          
          if (!originalContent || !searchTerm) return;

          lastSearchTerm = searchTerm;
          
          try {
            const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
            const contentDiv = iframeDoc.querySelector('main') || iframeDoc.body;
            
            contentDiv.querySelectorAll('.highlight').forEach(el => {
              el.classList.remove('highlight', 'current-match');
            });
            
            allMatches = [];
            let foundMatches = 0;
            const searchLower = searchTerm.toLowerCase();
            
            const links = contentDiv.querySelectorAll('a[href]');
            links.forEach(link => {
              const href = link.getAttribute('href');
              if (href && href.toLowerCase().includes(searchLower)) {
                link.classList.add('highlight');
                link.setAttribute('data-match-id', foundMatches);
                allMatches.push(link);
                openParentDetails(link);
                foundMatches++;
              }
            });
            
            const urlPattern = /https?:\/\/[^\s<>"{}|\\^`\[\]]+/gi;
            const walker = iframeDoc.createTreeWalker(
              contentDiv,
              NodeFilter.SHOW_TEXT,
              {
                acceptNode: function(node) {
                  if (node.parentElement.tagName === 'SCRIPT' || 
                      node.parentElement.tagName === 'STYLE') {
                    return NodeFilter.FILTER_REJECT;
                  }
                  return NodeFilter.FILTER_ACCEPT;
                }
              },
              false
            );
            
            const textNodes = [];
            let node;
            while (node = walker.nextNode()) {
              const text = node.textContent;
              const urls = text.match(urlPattern);
              if (urls && urls.some(u => u.toLowerCase().includes(searchLower))) {
                  textNodes.push(node);
              }
            }
            
            textNodes.forEach(textNode => {
              const text = textNode.textContent;
              const urls = text.match(urlPattern);
              if (urls) {
                let newHTML = text;
                let changed = false;
                urls.forEach(url => {
                  if (url.toLowerCase().includes(searchLower)) {
                    const regex = new RegExp(url.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                    newHTML = newHTML.replace(regex, `<span class="highlight" data-match-id="${foundMatches}">${url}</span>`);
                    foundMatches++;
                    changed = true;
                  }
                });
                
                if (changed) {
                  const span = iframeDoc.createElement('span');
                  span.innerHTML = newHTML;
                  textNode.parentNode.replaceChild(span, textNode);
                  const newHighlights = span.querySelectorAll('.highlight');
                  newHighlights.forEach(highlight => {
                    allMatches.push(highlight);
                    openParentDetails(highlight);
                  });
                }
              }
            });
            
            if (foundMatches > 0) {
              errorDiv.innerHTML = `<div class="text-green-800 bg-green-100 p-3 rounded border border-green-800 mt-3 font-bold">Found ${foundMatches} matches!</div>`;
              matchCounterDiv.innerHTML = `<div class="text-blue-400 bg-blue-900/30 p-2.5 rounded text-center font-bold mt-2.5">Match 0 of ${foundMatches}</div>`;
              currentMatchIndex = -1;
              prevBtn.disabled = false;
              nextBtn.disabled = false;
              clearHighlightsBtn.disabled = false;
            } else {
              errorDiv.innerHTML = '<div class="text-red-700 bg-red-100 p-3 rounded border border-red-700 mt-3 font-bold">No matching URLs found</div>';
              matchCounterDiv.innerHTML = '';
              prevBtn.disabled = true;
              nextBtn.disabled = true;
              clearHighlightsBtn.disabled = true;
            }
          } catch (error) {
            errorDiv.innerHTML = '<div class="text-red-700 bg-red-100 p-3 rounded border border-red-700 mt-3 font-bold">Error highlighting: ' + error.message + '</div>';
          }
        }
        
        window.navigateMatches = function(direction) {
          if (allMatches.length === 0) return;
          const matchCounterDiv = document.getElementById('matchCounter');
          if (currentMatchIndex >= 0 && currentMatchIndex < allMatches.length) {
            allMatches[currentMatchIndex].classList.remove('current-match');
          }
          if (direction === 'next') {
            currentMatchIndex = (currentMatchIndex + 1) % allMatches.length;
          } else {
            currentMatchIndex = (currentMatchIndex - 1 + allMatches.length) % allMatches.length;
          }
          const currentMatch = allMatches[currentMatchIndex];
          currentMatch.classList.add('current-match');
          currentMatch.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
          matchCounterDiv.innerHTML = `<div class="text-blue-400 bg-blue-900/30 p-2.5 rounded text-center font-bold mt-2.5">Match ${currentMatchIndex + 1} of ${allMatches.length}</div>`;
        }
        
        window.clearHighlights = function() {
          const previewFrame = document.getElementById('previewFrame');
          if (originalContent) {
            const fullHtml = generateFullHtml(originalContent, currentPageTitle);
            const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(fullHtml);
            iframeDoc.close();
            document.getElementById('error').innerHTML = '';
            document.getElementById('matchCounter').innerHTML = '';
            allMatches = [];
            currentMatchIndex = -1;
            lastSearchTerm = '';
            document.getElementById('prevBtn').disabled = true;
            document.getElementById('nextBtn').disabled = true;
            document.getElementById('clearHighlightsBtn').disabled = true;
          }
        }
    })();
  </script>
</body>
</html>
